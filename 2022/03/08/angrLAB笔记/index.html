<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"2298233831.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="实验开始前还得先把文件编译一下 在相应目录下，使用如下命令，如 1python generate.py 1234 00_angr_find  贴一个angr中文文档angr （非官方） angr-官方,英文的。angr-api,英语苦手泪目。 （本题中，有些导入的库不一定那个用得到，但是题目数量多，懒得增删改，就一次性导入了…） 00_angr_find先上伪代码  当然，其实这整个实验，汇编语言">
<meta property="og:type" content="article">
<meta property="og:title" content="angrLAB笔记">
<meta property="og:url" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="The Blog of Yu4n">
<meta property="og:description" content="实验开始前还得先把文件编译一下 在相应目录下，使用如下命令，如 1python generate.py 1234 00_angr_find  贴一个angr中文文档angr （非官方） angr-官方,英文的。angr-api,英语苦手泪目。 （本题中，有些导入的库不一定那个用得到，但是题目数量多，懒得增删改，就一次性导入了…） 00_angr_find先上伪代码  当然，其实这整个实验，汇编语言">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308172612146.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308190311979.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308190505546.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308211050475.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308215004547.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308215133653.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220310171010963.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312101104842.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312112246653.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312113844308.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312115905211.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312155034471.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312163054462.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312164107756.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312164721082.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312170347821.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312172250586.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312172829883.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312180011638.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312180837996.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312181720370.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312183629337.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312190749217.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312192050484.png">
<meta property="og:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312192112152.png">
<meta property="article:published_time" content="2022-03-08T02:14:02.000Z">
<meta property="article:modified_time" content="2022-03-25T09:49:26.291Z">
<meta property="article:author" content="Yu4n">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308172612146.png">

<link rel="canonical" href="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>angrLAB笔记 | The Blog of Yu4n</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">The Blog of Yu4n</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://2298233831.github.io/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yu4n">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The Blog of Yu4n">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          angrLAB笔记
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-08 10:14:02" itemprop="dateCreated datePublished" datetime="2022-03-08T10:14:02+08:00">2022-03-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-25 17:49:26" itemprop="dateModified" datetime="2022-03-25T17:49:26+08:00">2022-03-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>实验开始前还得先把文件编译一下</p>
<p>在相应目录下，使用如下命令，如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python generate.py 1234 00_angr_find</span><br></pre></td></tr></table></figure>

<p>贴一个angr中文文档<a target="_blank" rel="noopener" href="https://github.com/anhkgg/angr-doc-zh_CN">angr</a> （非官方）</p>
<p><a target="_blank" rel="noopener" href="https://docs.angr.io/core-concepts/solver">angr-官方</a>,英文的。<a target="_blank" rel="noopener" href="https://angr.io/api-doc/">angr-api</a>,英语苦手泪目。</p>
<p>（本题中，有些导入的库不一定那个用得到，但是题目数量多，懒得增删改，就一次性导入了…）</p>
<h2 id="00-angr-find"><a href="#00-angr-find" class="headerlink" title="00_angr_find"></a>00_angr_find</h2><p>先上伪代码</p>
<p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308172612146.png" alt="image-20220308172612146"></p>
<p>当然，其实这整个实验，汇编语言是很重要的，伪代码是为了帮助理清程序逻辑。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.text:0804864E                 push    offset s2       ; &quot;FPQPMQXT&quot;</span><br><span class="line">.text:08048653                 lea     eax, [ebp+s1]</span><br><span class="line">.text:08048656                 push    eax             ; s1</span><br><span class="line">.text:08048657                 call    _strcmp</span><br><span class="line">.text:0804865C                 add     esp, 10h</span><br><span class="line">.text:0804865F                 test    eax, eax</span><br><span class="line">.text:08048661                 jz      short loc_8048675</span><br><span class="line">.text:08048663                 sub     esp, 0Ch</span><br><span class="line">.text:08048666                 push    offset s        ; &quot;Try again.&quot;</span><br><span class="line">.text:0804866B                 call    _puts</span><br><span class="line">.text:08048670                 add     esp, 10h</span><br><span class="line">.text:08048673                 jmp     short loc_8048685</span><br><span class="line">.text:08048675 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:08048675</span><br><span class="line">.text:08048675 loc_8048675:                            ; CODE XREF: main+9A↑j</span><br><span class="line">.text:08048675                 sub     esp, 0Ch</span><br><span class="line">.text:08048678                 push    offset aGoodJob ; &quot;Good Job.&quot;</span><br><span class="line">.text:0804867D                 call    _puts</span><br><span class="line">.text:08048682                 add     esp, 10h</span><br><span class="line">.text:08048685</span><br><span class="line">.text:08048685 loc_8048685:</span><br></pre></td></tr></table></figure>

<p>（这题可以直接逆来着）</p>
<p>发现程序中正确结果的走向，有good job语句，利用angr的explore，让angr找到相对应路径，执行即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    path_to_binary = <span class="string">&quot;E:\\LAB\\angr\\angr\program\\00_angr_find&quot;</span><span class="comment">#打开二进制文件</span></span><br><span class="line">    project = angr.Project(path_to_binary, auto_load_libs=<span class="literal">False</span>)<span class="comment">#创建对象</span></span><br><span class="line">    initial_state = project.factory.entry_state()<span class="comment">#state初始化</span></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">    print_good_address = <span class="number">0x8048678</span>  </span><br><span class="line">    simulation.explore(find=print_good_address)<span class="comment">#寻找地址对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;THE Answer is: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="01-angr-avoid"><a href="#01-angr-avoid" class="headerlink" title="01_angr_avoid"></a>01_angr_avoid</h2><p>这题因为太大反汇编不了，所以还是得看汇编。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">.text:0804890F                 jz      short loc_804892E</span><br><span class="line">.text:08048911                 call    avoid_me</span><br><span class="line">.text:08048916                 sub     esp, 8</span><br><span class="line">.text:08048919                 lea     eax, [ebp+var_20]</span><br><span class="line">.text:0804891C                 push    eax</span><br><span class="line">.text:0804891D                 lea     eax, [ebp+var_34]</span><br><span class="line">.text:08048920                 push    eax</span><br><span class="line">.text:08048921                 call    maybe_good</span><br><span class="line">.text:08048926                 add     esp, 10h</span><br><span class="line">.text:08048929                 jmp     loc_80D456F</span><br><span class="line">.text:0804892E ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0804892E</span><br><span class="line">.text:0804892E loc_804892E:                            ; CODE XREF: main+30D↑j</span><br><span class="line">.text:0804892E                 sub     esp, 8</span><br><span class="line">.text:08048931                 lea     eax, [ebp+var_20]</span><br><span class="line">.text:08048934                 push    eax</span><br><span class="line">.text:08048935                 lea     eax, [ebp+var_34]</span><br><span class="line">.text:08048938                 push    eax</span><br><span class="line">.text:08048939                 call    maybe_good</span><br><span class="line">.text:0804893E                 add     esp, 10h</span><br><span class="line">.text:08048941                 jmp     loc_80D456F</span><br><span class="line">.text:08048946 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:08048946</span><br><span class="line">.text:08048946 loc_8048946:                            ; CODE XREF: main+2E5↑j</span><br><span class="line">.text:08048946                 call    avoid_me</span><br><span class="line"></span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">text:080485B5                 public maybe_good</span><br><span class="line">.text:080485B5 maybe_good      proc near               ; CODE XREF: main+31F↓p</span><br><span class="line">.text:080485B5                                         ; main+337↓p ...</span><br><span class="line">.text:080485B5</span><br><span class="line">.text:080485B5 arg_0           = dword ptr  8</span><br><span class="line">.text:080485B5 arg_4           = dword ptr  0Ch</span><br><span class="line">.text:080485B5</span><br><span class="line">.text:080485B5 ; __unwind &#123;</span><br><span class="line">.text:080485B5                 push    ebp</span><br><span class="line">.text:080485B6                 mov     ebp, esp</span><br><span class="line">.text:080485B8                 sub     esp, 8</span><br><span class="line">.text:080485BB                 movzx   eax, should_succeed</span><br><span class="line">.text:080485C2                 test    al, al</span><br><span class="line">.text:080485C4                 jz      short loc_80485EF</span><br><span class="line">.text:080485C6                 sub     esp, 4</span><br><span class="line">.text:080485C9                 push    8</span><br><span class="line">.text:080485CB                 push    [ebp+arg_4]</span><br><span class="line">.text:080485CE                 push    [ebp+arg_0]</span><br><span class="line">.text:080485D1                 call    _strncmp</span><br><span class="line">.text:080485D6                 add     esp, 10h</span><br><span class="line">.text:080485D9                 test    eax, eax</span><br><span class="line">.text:080485DB                 jnz     short loc_80485EF</span><br><span class="line">.text:080485DD                 sub     esp, 0Ch</span><br><span class="line">.text:080485E0                 push    offset aGoodJob ; &quot;Good Job.&quot;</span><br><span class="line">.text:080485E5                 call    _puts</span><br><span class="line">.text:080485EA                 add     esp, 10h</span><br><span class="line">.text:080485ED                 jmp     short loc_80485FF</span><br><span class="line">.text:080485EF ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080485EF</span><br><span class="line">.text:080485EF loc_80485EF:                            ; CODE XREF: maybe_good+F↑j</span><br><span class="line">.text:080485EF                                         ; maybe_good+26↑j</span><br><span class="line">.text:080485EF                 sub     esp, 0Ch</span><br><span class="line">.text:080485F2                 push    offset aTryAgain ; &quot;Try again.&quot;</span><br><span class="line">.text:080485F7                 call    _puts</span><br><span class="line">.text:080485FC                 add     esp, 10h</span><br><span class="line">.text:080485FF</span><br><span class="line">.text:080485FF loc_80485FF:                            ; CODE XREF: maybe_good+38↑j</span><br><span class="line">.text:080485FF                 nop</span><br><span class="line">.text:08048600                 leave</span><br><span class="line">.text:08048601                 retn</span><br><span class="line">.text:08048601 ; &#125; // starts at 80485B5</span><br><span class="line">.text:08048601 maybe_good      endp</span><br><span class="line">.text:08048601</span><br></pre></td></tr></table></figure>

<p>有俩个函数，avoid me和maybegood。字面意思，正确寻址应该在后者里。</p>
<p>查找到goodjob地址为0x080485E0</p>
<p>要避开的tryagain在0x080485F2</p>
<p>（其实这题就把上一题的脚本拿来改个地址也可以得出答案，不过会慢很多，因为不会避开avoidme函数）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    path_to_binary = <span class="string">&quot;E:\\LAB\\angr\\angr\program\\01_angr_avoid&quot;</span></span><br><span class="line">    project = angr.Project(path_to_binary, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line">    initial_state = project.factory.entry_state()</span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">    avoid_me_address =   <span class="number">0x080485A8</span><span class="comment">#avoidme函数首地址，不推介用tryagain来避开，应为没有避开avoidme函数，时间要很久。</span></span><br><span class="line">    maybe_good_address = <span class="number">0x080485E0</span></span><br><span class="line"></span><br><span class="line">    simulation.explore(find=maybe_good_address, avoid=avoid_me_address)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ANSWER is: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个脚本相比于上一道题，在于explore中多了一个avoid&#x3D;要排除执行的路径。</p>
<h2 id="02-angr-find-condition"><a href="#02-angr-find-condition" class="headerlink" title="02_angr_find_condition"></a>02_angr_find_condition</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308190311979.png" alt="image-20220308190311979"></p>
<p>首先乍一看，多个goodjob，这题肯定就不能直接寻址goodjob了，不唯一。</p>
<p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308190505546.png" alt="image-20220308190505546"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">.text:0804876B loc_804876B:                            ; CODE XREF: main+112↑j</span><br><span class="line">.text:0804876B                 cmp     [ebp+var_38], 0DEADBEEFh</span><br><span class="line">.text:08048772                 jz      short loc_80487B5</span><br><span class="line">.text:08048774                 sub     esp, 8</span><br><span class="line">.text:08048777                 lea     eax, [ebp+s2]</span><br><span class="line">.text:0804877A                 push    eax             ; s2</span><br><span class="line">.text:0804877B                 lea     eax, [ebp+s1]</span><br><span class="line">.text:0804877E                 push    eax             ; s1</span><br><span class="line">.text:0804877F                 call    _strcmp</span><br><span class="line">.text:08048784                 add     esp, 10h</span><br><span class="line">.text:08048787                 test    eax, eax</span><br><span class="line">.text:08048789                 jz      short loc_80487A0</span><br><span class="line">.text:0804878B                 sub     esp, 0Ch</span><br><span class="line">.text:0804878E                 push    offset s        ; &quot;Try again.&quot;</span><br><span class="line">.text:08048793                 call    _puts</span><br><span class="line">.text:08048798                 add     esp, 10h</span><br><span class="line">.text:0804879B                 jmp     loc_804D267</span><br><span class="line">.text:080487A0 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080487A0</span><br><span class="line">.text:080487A0 loc_80487A0:                            ; CODE XREF: main+1C1↑j</span><br><span class="line">.text:080487A0                 sub     esp, 0Ch</span><br><span class="line">.text:080487A3                 push    offset aGoodJob ; &quot;Good Job.&quot;</span><br><span class="line">.text:080487A8                 call    _puts</span><br><span class="line">.text:080487AD                 add     esp, 10h</span><br><span class="line">.text:080487B0                 jmp     loc_804D267</span><br><span class="line">.text:080487B5 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080487B5</span><br><span class="line">.text:080487B5 loc_80487B5:                            ; CODE XREF: main+1AA↑j</span><br><span class="line">.text:080487B5                 sub     esp, 8</span><br><span class="line">.text:080487B8                 lea     eax, [ebp+s2]</span><br><span class="line">.text:080487BB                 push    eax             ; s2</span><br><span class="line">.text:080487BC                 lea     eax, [ebp+s1]</span><br><span class="line">.text:080487BF                 push    eax             ; s1</span><br><span class="line">.text:080487C0                 call    _strcmp</span><br><span class="line">.text:080487C5                 add     esp, 10h</span><br><span class="line">.text:080487C8                 test    eax, eax</span><br><span class="line">.text:080487CA                 jz      short loc_80487E1</span><br><span class="line">.text:080487CC                 sub     esp, 0Ch</span><br><span class="line">.text:080487CF                 push    offset s        ; &quot;Try again.&quot;</span><br><span class="line">.text:080487D4                 call    _puts</span><br><span class="line">.text:080487D9                 add     esp, 10h</span><br><span class="line">.text:080487DC                 jmp     loc_804D267</span><br><span class="line">.text:080487E1 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080487E1</span><br><span class="line">.text:080487E1 loc_80487E1:                            ; CODE XREF: main+202↑j</span><br><span class="line">.text:080487E1                 sub     esp, 0Ch</span><br><span class="line">.text:080487E4                 push    offset aGoodJob ; &quot;Good Job.&quot;</span><br><span class="line">.text:080487E9                 call    _puts</span><br></pre></td></tr></table></figure>

<p>当然，这题想要直接逆也是可以的，不过我们还是用angr</p>
<p>首先是思路：够狠上面一样题的是，还是应该回避tryagain一类的失败路径，然后再设置两个回调函数，当返回tryagain时，回避路径，反之则不回避。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    path_to_binary = <span class="string">&quot;E:\\LAB\\angr\\angr\program\\02_angr_find_condition&quot;</span></span><br><span class="line">    project = angr.Project(path_to_binary, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line">    initial_state = project.factory.entry_state()</span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())<span class="comment">#获取模拟执行的控制台输出</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output:<span class="comment">#根据模拟控制台得输出结果来判断，下面同理。</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span><span class="comment">#发现路径</span></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span><span class="comment">#忽略路径</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span>  stdout_output:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;The ANSWER is: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>



<h2 id="03-angr-symbolic-registers"><a href="#03-angr-symbolic-registers" class="headerlink" title="03_angr_symbolic_registers"></a>03_angr_symbolic_registers</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308211050475.png" alt="image-20220308211050475"></p>
<p>上面是伪代码。</p>
<p>主函数汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">.text:080488E8 main            proc near               ; DATA XREF: _start+17↑o</span><br><span class="line">.text:080488E8</span><br><span class="line">.text:080488E8 var_14          = dword ptr -14h</span><br><span class="line">.text:080488E8 var_10          = dword ptr -10h</span><br><span class="line">.text:080488E8 var_C           = dword ptr -0Ch</span><br><span class="line">.text:080488E8 var_4           = dword ptr -4</span><br><span class="line">.text:080488E8 argc            = dword ptr  8</span><br><span class="line">.text:080488E8 argv            = dword ptr  0Ch</span><br><span class="line">.text:080488E8 envp            = dword ptr  10h</span><br><span class="line">.text:080488E8</span><br><span class="line">.text:080488E8 ; __unwind &#123;</span><br><span class="line">.text:080488E8                 lea     ecx, [esp+4]</span><br><span class="line">.text:080488EC                 and     esp, 0FFFFFFF0h</span><br><span class="line">.text:080488EF                 push    dword ptr [ecx-4]</span><br><span class="line">.text:080488F2                 push    ebp</span><br><span class="line">.text:080488F3                 mov     ebp, esp</span><br><span class="line">.text:080488F5                 push    ecx</span><br><span class="line">.text:080488F6                 sub     esp, 14h</span><br><span class="line">.text:080488F9                 sub     esp, 0Ch</span><br><span class="line">.text:080488FC                 push    offset aEnterThePasswo ; &quot;Enter the password: &quot;</span><br><span class="line">.text:08048901                 call    _printf</span><br><span class="line">.text:08048906                 add     esp, 10h</span><br><span class="line">.text:08048909                 call    get_user_input</span><br><span class="line">.text:0804890E                 mov     [ebp+var_14], eax</span><br><span class="line">.text:08048911                 mov     [ebp+var_10], ebx</span><br><span class="line">.text:08048914                 mov     [ebp+var_C], edx</span><br><span class="line">.text:08048917                 sub     esp, 0Ch</span><br><span class="line">.text:0804891A                 push    [ebp+var_14]</span><br><span class="line">.text:0804891D                 call    complex_function_1</span><br><span class="line">.text:08048922                 add     esp, 10h</span><br><span class="line">.text:08048925                 mov     ecx, eax</span><br><span class="line">.text:08048927                 mov     [ebp+var_14], ecx</span><br><span class="line">.text:0804892A                 sub     esp, 0Ch</span><br><span class="line">.text:0804892D                 push    [ebp+var_10]</span><br><span class="line">.text:08048930                 call    complex_function_2</span><br><span class="line">.text:08048935                 add     esp, 10h</span><br><span class="line">.text:08048938                 mov     ecx, eax</span><br><span class="line">.text:0804893A                 mov     [ebp+var_10], ecx</span><br><span class="line">.text:0804893D                 sub     esp, 0Ch</span><br><span class="line">.text:08048940                 push    [ebp+var_C]</span><br><span class="line">.text:08048943                 call    complex_function_3</span><br><span class="line">.text:08048948                 add     esp, 10h</span><br><span class="line">.text:0804894B                 mov     ecx, eax</span><br><span class="line">.text:0804894D                 mov     [ebp+var_C], ecx</span><br><span class="line">.text:08048950                 cmp     [ebp+var_14], 0</span><br><span class="line">.text:08048954                 jnz     short loc_8048962</span><br><span class="line">.text:08048956                 cmp     [ebp+var_10], 0</span><br><span class="line">.text:0804895A                 jnz     short loc_8048962</span><br><span class="line">.text:0804895C                 cmp     [ebp+var_C], 0</span><br><span class="line">.text:08048960                 jz      short loc_8048974</span><br></pre></td></tr></table></figure>

<p>可以看到，四个函数调用。第一个就是让我们输入三个数；eax，ebx，edx分别存放输入数据，也是接下来三个函数的参数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">.text:0804889A get_user_input  proc near               ; CODE XREF: main+21↓p</span><br><span class="line">.text:0804889A</span><br><span class="line">.text:0804889A var_18          = dword ptr -18h</span><br><span class="line">.text:0804889A var_14          = dword ptr -14h</span><br><span class="line">.text:0804889A var_10          = dword ptr -10h</span><br><span class="line">.text:0804889A var_C           = dword ptr -0Ch</span><br><span class="line">.text:0804889A</span><br><span class="line">.text:0804889A ; __unwind &#123;</span><br><span class="line">.text:0804889A                 push    ebp</span><br><span class="line">.text:0804889B                 mov     ebp, esp</span><br><span class="line">.text:0804889D                 sub     esp, 18h</span><br><span class="line">.text:080488A0                 mov     ecx, large gs:14h</span><br><span class="line">.text:080488A7                 mov     [ebp+var_C], ecx</span><br><span class="line">.text:080488AA                 xor     ecx, ecx</span><br><span class="line">.text:080488AC                 lea     ecx, [ebp+var_10]</span><br><span class="line">.text:080488AF                 push    ecx</span><br><span class="line">.text:080488B0                 lea     ecx, [ebp+var_14]</span><br><span class="line">.text:080488B3                 push    ecx</span><br><span class="line">.text:080488B4                 lea     ecx, [ebp+var_18]</span><br><span class="line">.text:080488B7                 push    ecx</span><br><span class="line">.text:080488B8                 push    offset aXXX     ; &quot;%x %x %x&quot;</span><br><span class="line">.text:080488BD                 call    ___isoc99_scanf</span><br><span class="line">.text:080488C2                 add     esp, 10h</span><br><span class="line">.text:080488C5                 mov     ecx, [ebp+var_18]</span><br><span class="line">.text:080488C8                 mov     eax, ecx</span><br><span class="line">.text:080488CA                 mov     ecx, [ebp+var_14]</span><br><span class="line">.text:080488CD                 mov     ebx, ecx</span><br><span class="line">.text:080488CF                 mov     ecx, [ebp+var_10]</span><br><span class="line">.text:080488D2                 mov     edx, ecx</span><br><span class="line">.text:080488D4                 nop</span><br><span class="line">.text:080488D5                 mov     ecx, [ebp+var_C]</span><br><span class="line">.text:080488D8                 xor     ecx, large gs:14h</span><br><span class="line">.text:080488DF                 jz      short locret_80488E6</span><br><span class="line">.text:080488E1                 call    ___stack_chk_fail</span><br><span class="line">.text:080488E6 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080488E6</span><br><span class="line">.text:080488E6 locret_80488E6:                         ; CODE XREF: get_user_input+45↑j</span><br><span class="line">.text:080488E6                 leave</span><br><span class="line">.text:080488E7                 retn</span><br><span class="line">.text:080488E7 ; &#125; // starts at 804889A</span><br><span class="line">.text:080488E7 get_user_input  endp</span><br></pre></td></tr></table></figure>

<p>我们看接下来三个函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">.text:08048509 complex_function_1 proc near            ; CODE XREF: main+35↓p</span><br><span class="line">.text:08048509</span><br><span class="line">.text:08048509 arg_0           = dword ptr  8</span><br><span class="line">.text:08048509</span><br><span class="line">.text:08048509 ; __unwind &#123;</span><br><span class="line">.text:08048509                 push    ebp</span><br><span class="line">.text:0804850A                 mov     ebp, esp</span><br><span class="line">.text:0804850C                 xor     [ebp+arg_0], 0A78D4A5Fh</span><br><span class="line">.text:08048513                 add     [ebp+arg_0], 3EC98793h</span><br><span class="line">.text:0804851A                 xor     [ebp+arg_0], 51FCDF96h</span><br><span class="line">.text:08048521                 add     [ebp+arg_0], 546F1B35h</span><br><span class="line">.text:08048528                 add     [ebp+arg_0], 7CD06332h</span><br><span class="line">.text:0804852F                 add     [ebp+arg_0], 3BEEDF0Bh</span><br><span class="line">.text:08048536                 add     [ebp+arg_0], 5824146Ch</span><br><span class="line">.text:0804853D                 add     [ebp+arg_0], 15CBC4FFh</span><br><span class="line">.text:08048544                 mov     ecx, [ebp+arg_0]</span><br><span class="line">.text:08048547                 sub     ecx, 46C32D9h</span><br><span class="line">.text:0804854D                 mov     [ebp+arg_0], ecx</span><br><span class="line">.text:08048550                 xor     [ebp+arg_0], 9B99C626h</span><br><span class="line">.text:08048557                 add     [ebp+arg_0], 6590A23Dh</span><br><span class="line">.text:0804855E                 xor     [ebp+arg_0], 0D16C9C3Ch</span><br><span class="line">.text:08048565                 xor     [ebp+arg_0], 0D73D3031h</span><br><span class="line">.text:0804856C                 xor     [ebp+arg_0], 37EB59D3h</span><br><span class="line">.text:08048573                 mov     ecx, [ebp+arg_0]</span><br><span class="line">.text:08048576                 sub     ecx, 5DDF68E6h</span><br><span class="line">.text:0804857C                 mov     [ebp+arg_0], ecx</span><br><span class="line">.text:0804857F                 mov     ecx, [ebp+arg_0]</span><br><span class="line">.text:08048582                 sub     ecx, 64F2CB17h</span><br><span class="line">.text:08048588                 mov     [ebp+arg_0], ecx</span><br><span class="line">.text:0804858B                 xor     [ebp+arg_0], 0F1C347B6h</span><br><span class="line">.text:08048592                 xor     [ebp+arg_0], 0BB664966h</span><br><span class="line">.text:08048599                 xor     [ebp+arg_0], 0DCD816D2h</span><br><span class="line">.text:080485A0                 xor     [ebp+arg_0], 0A523DD67h</span><br><span class="line">.text:080485A7                 add     [ebp+arg_0], 2C64C6B3h</span><br><span class="line">.text:080485AE                 mov     ecx, [ebp+arg_0]</span><br><span class="line">.text:080485B1                 sub     ecx, 632C11C3h</span><br><span class="line">.text:080485B7                 mov     [ebp+arg_0], ecx</span><br><span class="line">.text:080485BA                 add     [ebp+arg_0], 220BCB4Ch</span><br><span class="line">.text:080485C1                 xor     [ebp+arg_0], 0C13B368Ah</span><br><span class="line">.text:080485C8                 xor     [ebp+arg_0], 7323522h</span><br><span class="line">.text:080485CF                 mov     ecx, [ebp+arg_0]</span><br><span class="line">.text:080485D2                 sub     ecx, 7FA5CE75h</span><br><span class="line">.text:080485D8                 mov     [ebp+arg_0], ecx</span><br><span class="line">.text:080485DB                 add     [ebp+arg_0], 2BA5F91Ah</span><br><span class="line">.text:080485E2                 xor     [ebp+arg_0], 0CEF3925Eh</span><br><span class="line">.text:080485E9                 xor     [ebp+arg_0], 879B8252h</span><br><span class="line">.text:080485F0                 add     [ebp+arg_0], 6D4F923Bh</span><br><span class="line">.text:080485F7                 mov     ecx, [ebp+arg_0]</span><br><span class="line">.text:080485FA                 sub     ecx, 491AF770h</span><br><span class="line">.text:08048600                 mov     [ebp+arg_0], ecx</span><br><span class="line">.text:08048603                 xor     [ebp+arg_0], 96C75B6h</span><br><span class="line">.text:0804860A                 xor     [ebp+arg_0], 51EC989Bh</span><br><span class="line">.text:08048611                 xor     [ebp+arg_0], 0DE67C3E3h</span><br><span class="line">.text:08048618                 add     [ebp+arg_0], 2C688544h</span><br><span class="line">.text:0804861F                 xor     [ebp+arg_0], 6A479F09h</span><br><span class="line">.text:08048626                 xor     [ebp+arg_0], 0D8B0FF0Dh</span><br><span class="line">.text:0804862D                 xor     [ebp+arg_0], 37172519h</span><br><span class="line">.text:08048634                 mov     ecx, [ebp+arg_0]</span><br><span class="line">.text:08048637                 mov     eax, ecx</span><br><span class="line">.text:08048639                 pop     ebp</span><br><span class="line">.text:0804863A                 retn</span><br><span class="line">.text:0804863A ; &#125; // starts at 8048509</span><br><span class="line">.text:0804863A complex_function_1 endp</span><br></pre></td></tr></table></figure>

<p>逻辑简单，就是异或。</p>
<p>来说整体思路：</p>
<p>首先是三个参数，要异或过后符合要求，输出goodjob。由于这题没有指出最后要比较的三个数的具体的值，所以我们不能套用前面那的方法。此处应该控制输入的三个值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    path_to_binary = <span class="string">&quot;E:\\LAB\\angr\\angr\program\\03_angr_symbolic_registers&quot;</span> </span><br><span class="line">    project = angr.Project(path_to_binary)</span><br><span class="line">    start_addr = <span class="number">0x0804890E</span></span><br><span class="line">    initial_state = project.factory.blank_state(addr=start_addr)</span><br><span class="line">	</span><br><span class="line">    passwd_size_in_bits = <span class="number">32</span></span><br><span class="line">    passwd0 = claripy.BVS(<span class="string">&#x27;passwd0&#x27;</span>, passwd_size_in_bits)<span class="comment">#开始初始化符号位向量</span></span><br><span class="line">    passwd1 = claripy.BVS(<span class="string">&#x27;passwd1&#x27;</span>, passwd_size_in_bits)</span><br><span class="line">    passwd2 = claripy.BVS(<span class="string">&#x27;passwd2&#x27;</span>, passwd_size_in_bits)</span><br><span class="line"></span><br><span class="line">    initial_state.regs.eax = passwd0<span class="comment">#更新寄存器内容</span></span><br><span class="line">    initial_state.regs.ebx = passwd1</span><br><span class="line">    initial_state.regs.edx = passwd2</span><br><span class="line"></span><br><span class="line">    simulation = project.factory.simgr(initial_state) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span>  stdout_output:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> simulation.found:</span><br><span class="line">            solution_state = i</span><br><span class="line">            solution0 = <span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(passwd0), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">            solution1 = <span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(passwd1), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">            solution2 = <span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(passwd2), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">            solution = solution0 + <span class="string">&quot; &quot;</span> + solution1 + <span class="string">&quot; &quot;</span> + solution2</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;The ANSWER is: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="04-angr-symbolic-stack"><a href="#04-angr-symbolic-stack" class="headerlink" title="04_angr_symbolic_stack"></a>04_angr_symbolic_stack</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308215004547.png" alt="image-20220308215004547"></p>
<p>可以明确，关键在handle_user函数里面</p>
<p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220308215133653.png" alt="image-20220308215133653"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">handle_user     proc near               ; CODE XREF: main+21↓p</span><br><span class="line">.text:08048679</span><br><span class="line">.text:08048679 var_10          = dword ptr -10h</span><br><span class="line">.text:08048679 var_C           = dword ptr -0Ch</span><br><span class="line">.text:08048679</span><br><span class="line">.text:08048679 ; __unwind &#123;</span><br><span class="line">.text:08048679                 push    ebp</span><br><span class="line">.text:0804867A                 mov     ebp, esp</span><br><span class="line">.text:0804867C                 sub     esp, 18h</span><br><span class="line">.text:0804867F                 sub     esp, 4</span><br><span class="line">.text:08048682                 lea     eax, [ebp+var_10]</span><br><span class="line">.text:08048685                 push    eax</span><br><span class="line">.text:08048686                 lea     eax, [ebp+var_C]</span><br><span class="line">.text:08048689                 push    eax</span><br><span class="line">.text:0804868A                 push    offset aUU      ; &quot;%u %u&quot;</span><br><span class="line">.text:0804868F                 call    ___isoc99_scanf</span><br><span class="line">.text:08048694                 add     esp, 10h</span><br><span class="line">.text:08048697                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:0804869A                 sub     esp, 0Ch</span><br><span class="line">.text:0804869D                 push    eax</span><br><span class="line">.text:0804869E                 call    complex_function0</span><br><span class="line">.text:080486A3                 add     esp, 10h</span><br><span class="line">.text:080486A6                 mov     [ebp+var_C], eax</span><br><span class="line">.text:080486A9                 mov     eax, [ebp+var_10]</span><br><span class="line">.text:080486AC                 sub     esp, 0Ch</span><br><span class="line">.text:080486AF                 push    eax</span><br><span class="line">.text:080486B0                 call    complex_function1</span><br><span class="line">.text:080486B5                 add     esp, 10h</span><br><span class="line">.text:080486B8                 mov     [ebp+var_10], eax</span><br><span class="line">.text:080486BB                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:080486BE                 cmp     eax, 0D3062A4Ch</span><br><span class="line">.text:080486C3                 jnz     short loc_80486CF</span><br><span class="line">.text:080486C5                 mov     eax, [ebp+var_10]</span><br><span class="line">.text:080486C8                 cmp     eax, 694E5BA0h</span><br><span class="line">.text:080486CD                 jz      short loc_80486E1</span><br><span class="line">.text:080486CF</span><br><span class="line">.text:080486CF loc_80486CF:                            ; CODE XREF: handle_user+4A↑j</span><br><span class="line">.text:080486CF                 sub     esp, 0Ch</span><br><span class="line">.text:080486D2                 push    offset s        ; &quot;Try again.&quot;</span><br><span class="line">.text:080486D7                 call    _puts</span><br><span class="line">.text:080486DC                 add     esp, 10h</span><br><span class="line">.text:080486DF                 jmp     short loc_80486F1</span><br><span class="line">.text:080486E1 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080486E1</span><br><span class="line">.text:080486E1 loc_80486E1:                            ; CODE XREF: handle_user+54↑j</span><br><span class="line">.text:080486E1                 sub     esp, 0Ch</span><br><span class="line">.text:080486E4                 push    offset aGoodJob ; &quot;Good Job.&quot;</span><br><span class="line">.text:080486E9                 call    _puts</span><br><span class="line">.text:080486EE                 add     esp, 10h</span><br><span class="line">.text:080486F1</span><br><span class="line">.text:080486F1 loc_80486F1:                            ; CODE XREF: handle_user+66↑j</span><br><span class="line">.text:080486F1                 nop</span><br><span class="line">.text:080486F2                 leave</span><br><span class="line">.text:080486F3                 retn</span><br><span class="line">.text:080486F3 ; &#125; // starts at 8048679</span><br><span class="line">.text:080486F3 handle_user     endp</span><br></pre></td></tr></table></figure>

<p>我们可以看一下complex_function0的函数汇编代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">.text:080484A9 complex_function0 proc near             ; CODE XREF: handle_user+25↓p</span><br><span class="line">.text:080484A9</span><br><span class="line">.text:080484A9 arg_0           = dword ptr  8</span><br><span class="line">.text:080484A9</span><br><span class="line">.text:080484A9 ; __unwind &#123;</span><br><span class="line">.text:080484A9                 push    ebp</span><br><span class="line">.text:080484AA                 mov     ebp, esp</span><br><span class="line">.text:080484AC                 xor     [ebp+arg_0], 0D53642BEh</span><br><span class="line">.text:080484B3                 xor     [ebp+arg_0], 58FC2926h</span><br><span class="line">.text:080484BA                 xor     [ebp+arg_0], 25596A36h</span><br><span class="line">.text:080484C1                 xor     [ebp+arg_0], 0A7AFAA43h</span><br><span class="line">.text:080484C8                 xor     [ebp+arg_0], 1559CAFEh</span><br><span class="line">.text:080484CF                 xor     [ebp+arg_0], 0D8D89C66h</span><br><span class="line">.text:080484D6                 xor     [ebp+arg_0], 6B8B30B6h</span><br><span class="line">.text:080484DD                 xor     [ebp+arg_0], 0B5E7C180h</span><br><span class="line">.text:080484E4                 xor     [ebp+arg_0], 1FA429F6h</span><br><span class="line">.text:080484EB                 xor     [ebp+arg_0], 21C70AF4h</span><br><span class="line">.text:080484F2                 xor     [ebp+arg_0], 0B7261E1Dh</span><br><span class="line">.text:080484F9                 xor     [ebp+arg_0], 0ADD88AD8h</span><br><span class="line">.text:08048500                 xor     [ebp+arg_0], 3E16A0F2h</span><br><span class="line">.text:08048507                 xor     [ebp+arg_0], 0DF2308FBh</span><br><span class="line">.text:0804850E                 xor     [ebp+arg_0], 2273AAFh</span><br><span class="line">.text:08048515                 xor     [ebp+arg_0], 8E69AC70h</span><br><span class="line">.text:0804851C                 xor     [ebp+arg_0], 0AC8924h</span><br><span class="line">.text:08048523                 xor     [ebp+arg_0], 561B782h</span><br><span class="line">.text:0804852A                 xor     [ebp+arg_0], 5A64A924h</span><br><span class="line">.text:08048531                 xor     [ebp+arg_0], 0B118005Bh</span><br><span class="line">.text:08048538                 xor     [ebp+arg_0], 61461EA2h</span><br><span class="line">.text:0804853F                 xor     [ebp+arg_0], 0E0E04E79h</span><br><span class="line">.text:08048546                 xor     [ebp+arg_0], 0A8DDACAAh</span><br><span class="line">.text:0804854D                 xor     [ebp+arg_0], 82AF667Dh</span><br><span class="line">.text:08048554                 xor     [ebp+arg_0], 0B3CB4464h</span><br><span class="line">.text:0804855B                 xor     [ebp+arg_0], 43B7BB1Ah</span><br><span class="line">.text:08048562                 xor     [ebp+arg_0], 0DF30F25Bh</span><br><span class="line">.text:08048569                 xor     [ebp+arg_0], 4C0F3376h</span><br><span class="line">.text:08048570                 xor     [ebp+arg_0], 0B2E462E5h</span><br><span class="line">.text:08048577                 xor     [ebp+arg_0], 7BF4CFC3h</span><br><span class="line">.text:0804857E                 xor     [ebp+arg_0], 0C2960388h</span><br><span class="line">.text:08048585                 xor     [ebp+arg_0], 27071524h</span><br><span class="line">.text:0804858C                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:0804858F                 pop     ebp</span><br><span class="line">.text:08048590                 retn</span><br><span class="line">.text:08048590 ; &#125; // starts at 80484A9</span><br><span class="line">.text:08048590 complex_function0 endp</span><br></pre></td></tr></table></figure>

<p>其实可以看出，跟上一题的思路其实相差不大。所以本题，我们也需要控制两个参数。</p>
<p>故，思路如下：</p>
<p>开始地址设置在输入函数之后，传参数给complex之前。通过complex函数内部可以知道，esp寄存器的值给了ebp（两个complex函数都是这样）。然后我们设置两个参数并将其压入栈。之后的操作和上一题大同小异</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">pro =angr.Project(<span class="string">&quot;E:\\LAB\\angr\\angr\program\\04_angr_symbolic_stack&quot;</span>)</span><br><span class="line"></span><br><span class="line">start_addr = <span class="number">0x08048697</span></span><br><span class="line">init_state = pro.factory.blank_state(addr=start_addr)</span><br><span class="line"></span><br><span class="line">init_state.regs.ebp = init_state.regs.esp</span><br><span class="line"></span><br><span class="line">passwd0 = claripy.BVS(<span class="string">&quot;passwd0&quot;</span>, <span class="number">32</span>)</span><br><span class="line">passwd1 = claripy.BVS(<span class="string">&quot;passwd1&quot;</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">init_state.regs.esp -= <span class="number">8</span></span><br><span class="line">init_state.stack_push(passwd0)</span><br><span class="line">init_state.stack_push(passwd1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">simulation = pro.factory.simgr(init_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">success</span>(<span class="params">state</span>):</span><br><span class="line">    output = state.posix.dumps(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Good Job.&quot;</span> <span class="keyword">in</span> output</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">abort</span>(<span class="params">state</span>):</span><br><span class="line">    output = state.posix.dumps(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;Try again.&quot;</span> <span class="keyword">in</span> output</span><br><span class="line"></span><br><span class="line">simulation.explore(find=success, avoid=abort)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    res = simulation.found[<span class="number">0</span>]</span><br><span class="line">    solution0 = res.solver.<span class="built_in">eval</span>(passwd0)</span><br><span class="line">    solution1 = res.solver.<span class="built_in">eval</span>(passwd1)</span><br><span class="line">    </span><br><span class="line">    solution = <span class="string">&quot; &quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, [solution0, solution1]))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The Answer is :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No Answer!&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="05-angr-symbolic-memory"><a href="#05-angr-symbolic-memory" class="headerlink" title="05_angr_symbolic_memory"></a>05_angr_symbolic_memory</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220310171010963.png" alt="image-20220310171010963"></p>
<p>还是先贴上伪代码</p>
<p>接着看汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">main            proc near               ; DATA XREF: _start+17↑o</span><br><span class="line">.text:080485A8</span><br><span class="line">.text:080485A8 var_C           = dword ptr -0Ch</span><br><span class="line">.text:080485A8 var_4           = dword ptr -4</span><br><span class="line">.text:080485A8 argc            = dword ptr  8</span><br><span class="line">.text:080485A8 argv            = dword ptr  0Ch</span><br><span class="line">.text:080485A8 envp            = dword ptr  10h</span><br><span class="line">.text:080485A8</span><br><span class="line">.text:080485A8 ; __unwind &#123;</span><br><span class="line">.text:080485A8                 lea     ecx, [esp+4]</span><br><span class="line">.text:080485AC                 and     esp, 0FFFFFFF0h</span><br><span class="line">.text:080485AF                 push    dword ptr [ecx-4]</span><br><span class="line">.text:080485B2                 push    ebp</span><br><span class="line">.text:080485B3                 mov     ebp, esp</span><br><span class="line">.text:080485B5                 push    ecx</span><br><span class="line">.text:080485B6                 sub     esp, 14h</span><br><span class="line">.text:080485B9                 sub     esp, 4</span><br><span class="line">.text:080485BC                 push    21h ; &#x27;!&#x27;       ; n</span><br><span class="line">.text:080485BE                 push    0               ; c</span><br><span class="line">.text:080485C0                 push    offset user_input ; s</span><br><span class="line">.text:080485C5                 call    _memset</span><br><span class="line">.text:080485CA                 add     esp, 10h</span><br><span class="line">.text:080485CD                 sub     esp, 0Ch</span><br><span class="line">.text:080485D0                 push    offset aEnterThePasswo ; &quot;Enter the password: &quot;</span><br><span class="line">.text:080485D5                 call    _printf</span><br><span class="line">.text:080485DA                 add     esp, 10h</span><br><span class="line">.text:080485DD                 sub     esp, 0Ch</span><br><span class="line">.text:080485E0                 push    offset unk_9FD92B8</span><br><span class="line">.text:080485E5                 push    offset unk_9FD92B0</span><br><span class="line">.text:080485EA                 push    offset unk_9FD92A8</span><br><span class="line">.text:080485EF                 push    offset user_input</span><br><span class="line">.text:080485F4                 push    offset a8s8s8s8s ; &quot;%8s %8s %8s %8s&quot;</span><br><span class="line">.text:080485F9                 call    ___isoc99_scanf</span><br><span class="line">.text:080485FE                 add     esp, 20h</span><br><span class="line">.text:08048601                 mov     [ebp+var_C], 0</span><br><span class="line">.text:08048608                 jmp     short loc_8048637</span><br><span class="line">.text:0804860A ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0804860A</span><br><span class="line">.text:0804860A loc_804860A:                            ; CODE XREF: main+93↓j</span><br><span class="line">.text:0804860A                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:0804860D                 add     eax, 9FD92A0h</span><br><span class="line">.text:08048612                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:08048615                 movsx   eax, al</span><br><span class="line">.text:08048618                 sub     esp, 8</span><br><span class="line">.text:0804861B                 push    [ebp+var_C]</span><br><span class="line">.text:0804861E                 push    eax</span><br><span class="line">.text:0804861F                 call    complex_function</span><br><span class="line">.text:08048624                 add     esp, 10h</span><br><span class="line">.text:08048627                 mov     edx, eax</span><br><span class="line">.text:08048629                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:0804862C                 add     eax, 9FD92A0h</span><br><span class="line">.text:08048631                 mov     [eax], dl</span><br><span class="line">.text:08048633                 add     [ebp+var_C], 1</span><br><span class="line">.text:08048637</span><br><span class="line">.text:08048637 loc_8048637:                            ; CODE XREF: main+60↑j</span><br><span class="line">.text:08048637                 cmp     [ebp+var_C], 1Fh</span><br><span class="line">.text:0804863B                 jle     short loc_804860A</span><br><span class="line">.text:0804863D                 sub     esp, 4</span><br><span class="line">.text:08048640                 push    20h ; &#x27; &#x27;       ; n</span><br><span class="line">.text:08048642                 push    offset s2       ; &quot;THNJXTHBJUCDIMEEMLZNGMHISXAIXDQG&quot;</span><br><span class="line">.text:08048647                 push    offset user_input ; s1</span><br><span class="line">.text:0804864C                 call    _strncmp</span><br><span class="line">.text:08048651                 add     esp, 10h</span><br><span class="line">.text:08048654                 test    eax, eax</span><br><span class="line">.text:08048656                 jz      short loc_804866A</span><br><span class="line">.text:08048658                 sub     esp, 0Ch</span><br><span class="line">.text:0804865B                 push    offset s        ; &quot;Try again.&quot;</span><br><span class="line">.text:08048660                 call    _puts</span><br><span class="line">.text:08048665                 add     esp, 10h</span><br><span class="line">.text:08048668                 jmp     short loc_804867A</span><br><span class="line">.text:0804866A ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0804866A</span><br><span class="line">.text:0804866A loc_804866A:                            ; CODE XREF: main+AE↑j</span><br><span class="line">.text:0804866A                 sub     esp, 0Ch</span><br><span class="line">.text:0804866D                 push    offset aGoodJob ; &quot;Good Job.&quot;</span><br><span class="line">.text:08048672                 call    _puts</span><br><span class="line">.text:08048677                 add     esp, 10h</span><br><span class="line">.text:0804867A</span><br><span class="line">.text:0804867A loc_804867A:                            ; CODE XREF: main+C0↑j</span><br><span class="line">.text:0804867A                 mov     eax, 0</span><br><span class="line">.text:0804867F                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:08048682                 leave</span><br><span class="line">.text:08048683                 lea     esp, [ecx-4]</span><br><span class="line">.text:08048686                 retn</span><br><span class="line">.text:08048686 ; &#125; // starts at 80485A8</span><br><span class="line">.text:08048686 main            endp</span><br></pre></td></tr></table></figure>

<p>思路跟上一题差不多，函数开始地址还是设在相应的位置0x08048601</p>
<p>然后是初始化符号位向量，且注意四个数据的地址，然后是一如既往的设置成功的路径和避免的路径。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">project =angr.Project(<span class="string">&quot;E:\\LAB\\angr\\angr\program\\05_angr_symbolic_memory&quot;</span>)</span><br><span class="line"></span><br><span class="line">start_address = <span class="number">0x8048601</span></span><br><span class="line">initial_state = project.factory.blank_state(addr=start_address)</span><br><span class="line"></span><br><span class="line">password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, <span class="number">8</span> * <span class="number">8</span>)</span><br><span class="line">password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, <span class="number">8</span> * <span class="number">8</span>)</span><br><span class="line">password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, <span class="number">8</span> * <span class="number">8</span>)</span><br><span class="line">password3 = claripy.BVS(<span class="string">&#x27;password3&#x27;</span>, <span class="number">8</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">password0_address = <span class="number">0x9FD92A0</span></span><br><span class="line">initial_state.memory.store(password0_address, password0)<span class="comment">#初始化地址中的数据</span></span><br><span class="line">password1_address = <span class="number">0x9FD92A8</span></span><br><span class="line">initial_state.memory.store(password1_address, password1)</span><br><span class="line">password2_address = <span class="number">0x9FD92B0</span></span><br><span class="line">initial_state.memory.store(password2_address, password2)</span><br><span class="line">password3_address = <span class="number">0x9FD92B8</span></span><br><span class="line">initial_state.memory.store(password3_address, password3)</span><br><span class="line"></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Good Job&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Try again&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output)</span><br><span class="line"></span><br><span class="line">simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    solution0 = solution_state.se.<span class="built_in">eval</span>(password0)</span><br><span class="line">    solution1 = solution_state.se.<span class="built_in">eval</span>(password1)</span><br><span class="line">    solution2 = solution_state.se.<span class="built_in">eval</span>(password2)</span><br><span class="line">    solution3 = solution_state.se.<span class="built_in">eval</span>(password3)</span><br><span class="line">    solution = <span class="string">&#x27; &#x27;</span>.join(<span class="built_in">map</span>(<span class="string">&#x27;&#123;:x&#125;&#x27;</span>.<span class="built_in">format</span>, [ solution0, solution1,solution2,solution3 ]))</span><br><span class="line">    </span><br><span class="line">    solution = <span class="string">&quot; &quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, [solution0, solution1]))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The Answer is :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No Answer!&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="06-angr-symbolic-dynamic-memory"><a href="#06-angr-symbolic-dynamic-memory" class="headerlink" title="06_angr_symbolic_dynamic_memory"></a>06_angr_symbolic_dynamic_memory</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312101104842.png" alt="image-20220312101104842"></p>
<p>伪代码如上。</p>
<p>看一下程序逻辑，输入两个数据，经过处理，比较，相等则通过。要注意buffer两个数据是存放在堆区的。、</p>
<p>所以在</p>
<p>main函数部分汇编代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">.text:08048691                 call    ___isoc99_scanf</span><br><span class="line">.text:08048696                 add     esp, 10h</span><br><span class="line">.text:08048699                 mov     [ebp+var_C], 0</span><br><span class="line">.text:080486A0                 jmp     short loc_8048706</span><br><span class="line">.text:080486A2 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080486A2</span><br><span class="line">.text:080486A2 loc_80486A2:                            ; CODE XREF: main+FE↓j</span><br><span class="line">.text:080486A2                 mov     edx, ds:buffer0</span><br><span class="line">.text:080486A8                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:080486AB                 lea     ebx, [edx+eax]</span><br><span class="line">.text:080486AE                 mov     edx, ds:buffer0</span><br><span class="line">.text:080486B4                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:080486B7                 add     eax, edx</span><br><span class="line">.text:080486B9                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:080486BC                 movsx   eax, al</span><br><span class="line">.text:080486BF                 sub     esp, 8</span><br><span class="line">.text:080486C2                 push    [ebp+var_C]</span><br><span class="line">.text:080486C5                 push    eax</span><br><span class="line">.text:080486C6                 call    complex_function</span><br><span class="line">.text:080486CB                 add     esp, 10h</span><br><span class="line">.text:080486CE                 mov     [ebx], al</span><br><span class="line">.text:080486D0                 mov     edx, ds:buffer1</span><br><span class="line">.text:080486D6                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:080486D9                 lea     ebx, [edx+eax]</span><br><span class="line">.text:080486DC                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:080486DF                 lea     edx, [eax+20h]</span><br><span class="line">.text:080486E2                 mov     ecx, ds:buffer1</span><br><span class="line">.text:080486E8                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:080486EB                 add     eax, ecx</span><br><span class="line">.text:080486ED                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:080486F0                 movsx   eax, al</span><br><span class="line">.text:080486F3                 sub     esp, 8</span><br><span class="line">.text:080486F6                 push    edx</span><br><span class="line">.text:080486F7                 push    eax</span><br><span class="line">.text:080486F8                 call    complex_function</span><br><span class="line">.text:080486FD                 add     esp, 10h</span><br><span class="line">.text:08048700                 mov     [ebx], al</span><br><span class="line">.text:08048702                 add     [ebp+var_C], 1</span><br><span class="line">.text:08048706</span><br></pre></td></tr></table></figure>

<p>再来看看complex的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">.text:080485A9 complex_function proc near              ; CODE XREF: main+BA↓p</span><br><span class="line">.text:080485A9                                         ; main+EC↓p</span><br><span class="line">.text:080485A9</span><br><span class="line">.text:080485A9 arg_0           = dword ptr  8</span><br><span class="line">.text:080485A9 arg_4           = dword ptr  0Ch</span><br><span class="line">.text:080485A9</span><br><span class="line">.text:080485A9 ; __unwind &#123;</span><br><span class="line">.text:080485A9                 push    ebp</span><br><span class="line">.text:080485AA                 mov     ebp, esp</span><br><span class="line">.text:080485AC                 sub     esp, 8</span><br><span class="line">.text:080485AF                 cmp     [ebp+arg_0], 40h ; &#x27;@&#x27;</span><br><span class="line">.text:080485B3                 jle     short loc_80485BB</span><br><span class="line">.text:080485B5                 cmp     [ebp+arg_0], 5Ah ; &#x27;Z&#x27;</span><br><span class="line">.text:080485B9                 jle     short loc_80485D5</span><br><span class="line">.text:080485BB</span><br><span class="line">.text:080485BB loc_80485BB:                            ; CODE XREF: complex_function+A↑j</span><br><span class="line">.text:080485BB                 sub     esp, 0Ch</span><br><span class="line">.text:080485BE                 push    offset s        ; &quot;Try again.&quot;</span><br><span class="line">.text:080485C3                 call    _puts</span><br><span class="line">.text:080485C8                 add     esp, 10h</span><br><span class="line">.text:080485CB                 sub     esp, 0Ch</span><br><span class="line">.text:080485CE                 push    1               ; status</span><br><span class="line">.text:080485D0                 call    _exit</span><br><span class="line">.text:080485D5 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080485D5</span><br><span class="line">.text:080485D5 loc_80485D5:                            ; CODE XREF: complex_function+10↑j</span><br><span class="line">.text:080485D5                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:080485D8                 lea     ecx, [eax-41h]</span><br><span class="line">.text:080485DB                 mov     edx, [ebp+arg_4]</span><br><span class="line">.text:080485DE                 mov     eax, edx</span><br><span class="line">.text:080485E0                 add     eax, eax</span><br><span class="line">.text:080485E2                 add     eax, edx</span><br><span class="line">.text:080485E4                 shl     eax, 2</span><br><span class="line">.text:080485E7                 add     eax, edx</span><br><span class="line">.text:080485E9                 add     ecx, eax</span><br><span class="line">.text:080485EB                 mov     edx, 4EC4EC4Fh</span><br><span class="line">.text:080485F0                 mov     eax, ecx</span><br><span class="line">.text:080485F2                 imul    edx</span><br><span class="line">.text:080485F4                 sar     edx, 3</span><br><span class="line">.text:080485F7                 mov     eax, ecx</span><br><span class="line">.text:080485F9                 sar     eax, 1Fh</span><br><span class="line">.text:080485FC                 sub     edx, eax</span><br><span class="line">.text:080485FE                 mov     eax, edx</span><br><span class="line">.text:08048600                 imul    eax, 1Ah</span><br><span class="line">.text:08048603                 sub     ecx, eax</span><br><span class="line">.text:08048605                 mov     eax, ecx</span><br><span class="line">.text:08048607                 add     eax, 41h ; &#x27;A&#x27;</span><br><span class="line">.text:0804860A                 leave</span><br><span class="line">.text:0804860B                 retn</span><br><span class="line">.text:0804860B ; &#125; // starts at 80485A9</span><br><span class="line">.text:0804860B complex_function endp</span><br></pre></td></tr></table></figure>

<p>本题跟上面一题脚本的主要区别在于，要设置数据保存的地址。而malloc是在堆区中分配的，而没有明确地址。故脚本中我们要指出地址来存放数据（随意指定，只要不在代码区等影响程序运行的地方就行）。以及需要指定数据在内存中是以小端序存储的（angr默认是大端序）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">project =angr.Project(<span class="string">&quot;E:\\LAB\\angr\\angr\program\\06_angr_symbolic_dynamic_memory&quot;</span>)</span><br><span class="line"></span><br><span class="line">start_addr = <span class="number">0x08048699</span></span><br><span class="line">initial_state = project.factory.blank_state(addr=start_addr)</span><br><span class="line"></span><br><span class="line">password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">fake0_addr = <span class="number">0x4444440</span></span><br><span class="line">fake1_addr = <span class="number">0x4444450</span></span><br><span class="line"></span><br><span class="line">buffer0_addr = <span class="number">0x09FD92AC</span> </span><br><span class="line">buffer1_addr = <span class="number">0x09FD92B4</span></span><br><span class="line">initial_state.memory.store(buffer0_addr,fake0_addr,endness=project.arch.memory_endness)<span class="comment">#endness=...就是指定存储端序 </span></span><br><span class="line">initial_state.memory.store(buffer1_addr,fake1_addr,endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">initial_state.memory.store(fake0_addr, password0)</span><br><span class="line">initial_state.memory.store(fake1_addr, password1)</span><br><span class="line"></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.se.<span class="built_in">eval</span>(password0)</span><br><span class="line">    solution1 = solution_state.se.<span class="built_in">eval</span>(password1)</span><br><span class="line">    solution = <span class="string">&#x27; &#x27;</span>.join(<span class="built_in">map</span>(<span class="string">&#x27;&#123;:x&#125;&#x27;</span>.<span class="built_in">format</span>, [ solution0, solution1 ]))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The Answer is :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No Answer!&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="07-angr-symbolic-file"><a href="#07-angr-symbolic-file" class="headerlink" title="07_angr_symbolic_file"></a>07_angr_symbolic_file</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312112246653.png" alt="image-20220312112246653"></p>
<p>伪代码整体逻辑为输入数据后，经过ignoerme处理，并保存在文件里MRXJ…txt，然后读取文件的数据，经过计算然后比较。</p>
<p>再看看ignoreme的伪代码</p>
<p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312113844308.png" alt="image-20220312113844308"></p>
<p>main函数部分汇编代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">.text:080488B2                 push    offset buffer</span><br><span class="line">.text:080488B7                 push    offset a64s     ; &quot;%64s&quot;</span><br><span class="line">.text:080488BC                 call    ___isoc99_scanf</span><br><span class="line">.text:080488C1                 add     esp, 10h</span><br><span class="line">.text:080488C4                 sub     esp, 8</span><br><span class="line">.text:080488C7                 push    40h ; &#x27;@&#x27;       ; n</span><br><span class="line">.text:080488C9                 push    offset buffer   ; int</span><br><span class="line">.text:080488CE                 call    ignore_me</span><br><span class="line">.text:080488D3                 add     esp, 10h</span><br><span class="line">.text:080488D6                 sub     esp, 4</span><br><span class="line">.text:080488D9                 push    40h ; &#x27;@&#x27;       ; n</span><br><span class="line">.text:080488DB                 push    0               ; c</span><br><span class="line">.text:080488DD                 push    offset buffer   ; s</span><br><span class="line">.text:080488E2                 call    _memset</span><br><span class="line">.text:080488E7                 add     esp, 10h</span><br><span class="line">.text:080488EA                 sub     esp, 8</span><br><span class="line">.text:080488ED                 push    offset aRb      ; &quot;rb&quot;</span><br><span class="line">.text:080488F2                 push    offset name     ; &quot;MRXJKZYR.txt&quot;</span><br><span class="line">.text:080488F7                 call    _fopen</span><br><span class="line">.text:080488FC                 add     esp, 10h</span><br><span class="line">.text:080488FF                 mov     ds:fp, eax</span><br><span class="line">.text:08048904                 mov     eax, ds:fp</span><br><span class="line">.text:08048909                 push    eax             ; stream</span><br><span class="line">.text:0804890A                 push    40h ; &#x27;@&#x27;       ; n</span><br><span class="line">.text:0804890C                 push    1               ; size</span><br><span class="line">.text:0804890E                 push    offset buffer   ; ptr</span><br><span class="line">.text:08048913                 call    _fread</span><br><span class="line">.text:08048918                 add     esp, 10h</span><br><span class="line">.text:0804891B                 mov     eax, ds:fp</span><br><span class="line">.text:08048920                 sub     esp, 0Ch</span><br><span class="line">.text:08048923                 push    eax             ; stream</span><br><span class="line">.text:08048924                 call    _fclose</span><br><span class="line">.text:08048929                 add     esp, 10h</span><br><span class="line">.text:0804892C                 sub     esp, 0Ch</span><br><span class="line">.text:0804892F                 push    offset name     ; &quot;MRXJKZYR.txt&quot;</span><br><span class="line">.text:08048934                 call    _unlink</span><br><span class="line">.text:08048939                 add     esp, 10h</span><br><span class="line">.text:0804893C                 mov     [ebp+var_C], 0</span><br><span class="line">.text:08048943                 jmp     short loc_8048972</span><br><span class="line">.text:08048945 ; ----------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">project =angr.Project(<span class="string">&quot;E:\\LAB\\angr\\angr\program\\07_angr_symbolic_file&quot;</span>)</span><br><span class="line"></span><br><span class="line">start_addr = <span class="number">0x080488EA</span><span class="comment">#这个位置并没有符号化文件名</span></span><br><span class="line"></span><br><span class="line">filename = <span class="string">&#x27;MRXJKZYR.txt&#x27;</span> </span><br><span class="line">symbolic_file_size_bytes = <span class="number">64</span> </span><br><span class="line"></span><br><span class="line">password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, symbolic_file_size_bytes * <span class="number">8</span>) </span><br><span class="line">password_file = angr.SimFile(filename, content=password, size=symbolic_file_size_bytes) </span><br><span class="line"><span class="comment">#模拟读取文件</span></span><br><span class="line"></span><br><span class="line">initial_state = project.factory.blank_state(addr=start_addr,fs&#123;filename:password_file&#125;) <span class="comment">#构建状态上下文里的文件数据系统</span></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution = long_to_bytes(solution_state.solver.<span class="built_in">eval</span>(password))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The Answer is :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No Answer!&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="08-angr-constraints"><a href="#08-angr-constraints" class="headerlink" title="08_angr_constraints"></a>08_angr_constraints</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312115905211.png" alt="image-20220312115905211"></p>
<p>惯例伪代码</p>
<p>逻辑很简单输入数据经过变化后与passwd比较，不过是在函数中比较。</p>
<p>main部分汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">.text:08048603                 push    offset aEnterThePasswo ; &quot;Enter the password: &quot;</span><br><span class="line">.text:08048608                 call    _printf</span><br><span class="line">.text:0804860D                 add     esp, 10h</span><br><span class="line">.text:08048610                 sub     esp, 8</span><br><span class="line">.text:08048613                 push    offset buffer</span><br><span class="line">.text:08048618                 push    offset a16s     ; &quot;%16s&quot;</span><br><span class="line">.text:0804861D                 call    ___isoc99_scanf</span><br><span class="line">.text:08048622                 add     esp, 10h</span><br><span class="line">.text:08048625                 mov     [ebp+var_C], 0</span><br><span class="line">.text:0804862C                 jmp     short loc_8048663</span><br><span class="line">.text:0804862E ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0804862E</span><br><span class="line">.text:0804862E loc_804862E:                            ; CODE XREF: main+B4↓j</span><br><span class="line">.text:0804862E                 mov     eax, 0Fh</span><br><span class="line">.text:08048633                 sub     eax, [ebp+var_C]</span><br><span class="line">.text:08048636                 mov     edx, eax</span><br><span class="line">.text:08048638                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:0804863B                 add     eax, 804A050h</span><br><span class="line">.text:08048640                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:08048643                 movsx   eax, al</span><br><span class="line">.text:08048646                 sub     esp, 8</span><br><span class="line">.text:08048649                 push    edx</span><br><span class="line">.text:0804864A                 push    eax</span><br><span class="line">.text:0804864B                 call    complex_function</span><br><span class="line">.text:08048650                 add     esp, 10h</span><br><span class="line">.text:08048653                 mov     edx, eax</span><br><span class="line">.text:08048655                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:08048658                 add     eax, 804A050h</span><br><span class="line">.text:0804865D                 mov     [eax], dl</span><br><span class="line">.text:0804865F                 add     [ebp+var_C], 1</span><br><span class="line">.text:08048663</span><br><span class="line">.text:08048663 loc_8048663:                            ; CODE XREF: main+79↑j</span><br><span class="line">.text:08048663                 cmp     [ebp+var_C], 0Fh</span><br><span class="line">.text:08048667                 jle     short loc_804862E</span><br><span class="line">.text:08048669                 sub     esp, 8</span><br><span class="line">.text:0804866C                 push    10h</span><br><span class="line">.text:0804866E                 push    offset buffer</span><br><span class="line">.text:08048673                 call    check_equals_MRXJKZYRKMKENFZB</span><br><span class="line">.text:08048678                 add     esp, 10h</span><br><span class="line">.text:0804867B                 test    eax, eax</span><br><span class="line">.text:0804867D                 jnz     short loc_8048691</span><br><span class="line">.text:0804867F                 sub     esp, 0Ch</span><br><span class="line">.text:08048682                 push    offset s        ; &quot;Try again.&quot;</span><br><span class="line">.text:08048687                 call    _puts</span><br><span class="line">.text:0804868C                 add     esp, 10h</span><br><span class="line">.text:0804868F                 jmp     short loc_80486A1</span><br><span class="line">.text:08048691 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:08048691</span><br><span class="line">.text:08048691 loc_8048691:                            ; CODE XREF: main+CA↑j</span><br><span class="line">.text:08048691                 sub     esp, 0Ch</span><br><span class="line">.text:08048694                 push    offset aGoodJob ; &quot;Good Job.&quot;</span><br><span class="line">.text:08048699                 call    _puts</span><br><span class="line">.text:0804869E                 add     esp, 10h</span><br></pre></td></tr></table></figure>

<p>complex的代码跟刚开始两道差不多，就不放了</p>
<p>思路：</p>
<p>开始地址还是设在输入后调用complex前，0x8048625</p>
<p>然后构造输入，从后面的比较函数的参数来看，buffer是16（0x10）个字节，80比特大小。再者就是buffer的地址</p>
<p>然后是循环的计算，在8048669位置结束，从下一行开始，就是往检查函数传参了。</p>
<p>需要注意的是，在检查函数里，是一个一个字符进行比较，这样就会让程序每次执行if语句16次，然后计算该走的分支，如此一算就是2^16，这就会产生路径爆炸问题。故，通过添加约束条件来避免这个问题。</p>
<p>列出脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">project =angr.Project(<span class="string">&quot;E:\\LAB\\angr\\angr\program\\08_angr_constraints&quot;</span>)</span><br><span class="line"></span><br><span class="line">start_addr = <span class="number">0x08048625</span> </span><br><span class="line">initial_state = project.factory.blank_state(addr=start_addr)</span><br><span class="line"></span><br><span class="line">buffer = claripy.BVS(<span class="string">&#x27;buffer&#x27;</span>, <span class="number">16</span>*<span class="number">8</span>)</span><br><span class="line">buffer_addr = <span class="number">0x0804A050</span></span><br><span class="line">initial_state.memory.store(buffer_addr, buffer)</span><br><span class="line"></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">addr_to_check_constraint = <span class="number">0x08048669</span> </span><br><span class="line">simulation.explore(find=addr_to_check_constraint)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        constrained_parameter_addr = <span class="number">0x0804A050</span> </span><br><span class="line">        constrained_parameter_size_bytes = <span class="number">16</span>   </span><br><span class="line">        constrained_parameter_bitvector = solution_state.memory.load(constrained_parameter_addr, constrained_parameter_size_bytes)  <span class="comment"># 从内存中加载buffer</span></span><br><span class="line"></span><br><span class="line">        constrained_parameter_desired_value = <span class="string">&#x27;MRXJKZYRKMKENFZB&#x27;</span> </span><br><span class="line"></span><br><span class="line">        constrained_expression = constrained_parameter_bitvector == constrained_parameter_desired_value                               <span class="comment"># 约束表达式</span></span><br><span class="line"></span><br><span class="line">        solution_state.add_constraints(constrained_expression)    <span class="comment"># 添加约束</span></span><br><span class="line"></span><br><span class="line">        solution = long_to_bytes(solution_state.se.<span class="built_in">eval</span>(buffer))</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;The ANSWER is :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution.decode(<span class="string">&quot;utf-8&quot;</span>)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    	<span class="built_in">print</span>(<span class="string">&quot;No Answer!&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="09-angr-hooks"><a href="#09-angr-hooks" class="headerlink" title="09_angr_hooks"></a>09_angr_hooks</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312155034471.png" alt="image-20220312155034471"></p>
<p>程序逻辑大致为先后输入两个数据，各自经过一系列变化，然后比较。</p>
<p>可以看到本题依旧有同样的检查函数，那么同上题一样，相同原理也会产生路径爆炸问题，本题如其名，我们通过angr的hook来避免路径爆炸，所以，我们钩取检查函数，定义一个自己的检查函数来作为替换。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">project =angr.Project(<span class="string">&quot;E:\\LAB\\angr\\angr\program\\09_angr_hooks&quot;</span>)</span><br><span class="line"></span><br><span class="line">initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">check_equals_called_address = <span class="number">0x80486B3</span>  <span class="comment">#  检查函数地址</span></span><br><span class="line">instruction_to_skip_length = <span class="number">0x5</span>         <span class="comment">#  call check_equals_MRXJKZYRKMKENFZB这条指令的长度</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@project.hook(<span class="params">check_equals_called_address, length=instruction_to_skip_length</span>)</span><span class="comment">#钩取</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">skip_check_equals_</span>(<span class="params">state</span>):</span><br><span class="line">    user_input_buffer_address = <span class="number">0x804A054</span>  <span class="comment">#  输入的地址</span></span><br><span class="line">    user_input_buffer_length = <span class="number">0x10</span>        <span class="comment">#  输入的长度</span></span><br><span class="line"></span><br><span class="line">    user_input_string = state.memory.load( <span class="comment">#  加载输入的数据</span></span><br><span class="line">      user_input_buffer_address,</span><br><span class="line">      user_input_buffer_length</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    check_against_string = <span class="string">&#x27;MRXJKZYRKMKENFZB&#x27;</span> </span><br><span class="line"></span><br><span class="line">    state.regs.eax = claripy.If(           <span class="comment">#  添加约束</span></span><br><span class="line">      user_input_string == check_against_string,  <span class="comment">#  条件</span></span><br><span class="line">      claripy.BVV(<span class="number">1</span>, <span class="number">32</span>),                  <span class="comment">#  真则返回 </span></span><br><span class="line">      claripy.BVV(<span class="number">0</span>, <span class="number">32</span>)                   <span class="comment">#  假则0</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Good Job&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Try again&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output)</span><br><span class="line"></span><br><span class="line">simulation.explore(find=is_successful, avoid=should_abort) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno()) </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The ANSWER is :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution.decode(<span class="string">&quot;utf-8&quot;</span>)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No Answer!&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="10-angr-simprocedures"><a href="#10-angr-simprocedures" class="headerlink" title="10_angr_simprocedures"></a>10_angr_simprocedures</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312163054462.png" alt="image-20220312163054462"></p>
<p>程序逻辑大同小异，不说了。</p>
<p>虽然说上一道和这一道没放汇编代码，但还是要看的，比如这道</p>
<p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312164107756.png" alt="image-20220312164107756"></p>
<p>可以看到检查函数被调用了多次，那么我们无法通过准确的地址来进行钩取，故，我们需要通过函数名来钩取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">project =angr.Project(<span class="string">&quot;E:\\LAB\\angr\\angr\program\\10_angr_simprocedures&quot;</span>)</span><br><span class="line"></span><br><span class="line">initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReplacementCheckEquals</span>(angr.SimProcedure):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, check_data_address, check_data_length</span>):  <span class="comment">#参数后俩个是要hook函数的参数</span></span><br><span class="line">      check_input_string = self.state.memory.load(</span><br><span class="line">        check_data_address,</span><br><span class="line">        check_data_length</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      check_against_string = <span class="string">&#x27;MRXJKZYRKMKENFZB&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> claripy.If(check_input_string == check_against_string, claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), claripy.BVV(<span class="number">0</span>, <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">check_equals_symbol = <span class="string">&#x27;check_equals_MRXJKZYRKMKENFZB&#x27;</span> </span><br><span class="line">project.hook_symbol(check_equals_symbol, ReplacementCheckEquals())  <span class="comment">#通过函数名钩取检查函数并替换为我们的检查函数</span></span><br><span class="line"></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Good Job&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Try again&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output)</span><br><span class="line"></span><br><span class="line">simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The ANSWER is :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution.decode(<span class="string">&quot;utf-8&quot;</span>)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No Answer!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>本题脚本与上一题整体差别不大。主要在函数钩取方式上。</p>
<h2 id="11-angr-sim-scanf"><a href="#11-angr-sim-scanf" class="headerlink" title="11_angr_sim_scanf"></a>11_angr_sim_scanf</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312164721082.png" alt="image-20220312164721082"></p>
<p>程序逻辑很明了，将原有数据变化，然后输入两个数据（每个四字节）与变化的数据作比较。</p>
<p>查看汇编代码发现，有多次调用输入函数，并比较的代码。这就是本题的关键点。</p>
<p>其实跟上一题差不多，这次很多调用的是输入，不是检查，相同的方法，钩取输入函数。不过参数设置上需要注意，数据大小，以及将数据以小端形式保存到地址中。并且需要将两个输入数据设置为全局变量。（需要重新设置两个变量来存储，因为我们在函数中设置的只是自定义的输入函数的局部变量，要想传到main中，得设置全局变量）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">project =angr.Project(<span class="string">&quot;E:\\LAB\\angr\\angr\program\\11_angr_sim_scanf&quot;</span>)</span><br><span class="line"></span><br><span class="line">initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReplacementScanf</span>(angr.SimProcedure):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, format_string, scanf0_address, scanf1_address </span>):</span><br><span class="line">      scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)<span class="comment">#4字节，32比特</span></span><br><span class="line">      scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">      self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)<span class="comment">#保存到内存中</span></span><br><span class="line">      self.state.memory.store(scanf1_address, scanf1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>] = scanf0<span class="comment">#全局变量的设置</span></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line">scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span></span><br><span class="line">project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Good Job&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Try again&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output)</span><br><span class="line"></span><br><span class="line">simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    stored_solutions0 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>]</span><br><span class="line">    stored_solutions1 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>]</span><br><span class="line">    solution0 = solution_state.se.<span class="built_in">eval</span>(stored_solutions0)</span><br><span class="line">    solution1 = solution_state.se.<span class="built_in">eval</span>(stored_solutions1)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The ANSWER is :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution0))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The ANSWER is :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution1))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No Answer!&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="12-angr-veritesting"><a href="#12-angr-veritesting" class="headerlink" title="12_angr_veritesting"></a>12_angr_veritesting</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312170347821.png" alt="image-20220312170347821"></p>
<p>输入数据，经过祖传complex函数变化，然后作比较。</p>
<p>其实这个for循环和if语句加起来相当于一个检查函数，而且会执行2^32次，路径爆炸是必须的。</p>
<p>这题除了避免路径爆炸外，其余的跟刚开始几道题差不多。</p>
<p>放脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">project =angr.Project(<span class="string">&quot;E:\\LAB\\angr\\angr\program\\12_angr_veritesting&quot;</span>)</span><br><span class="line"></span><br><span class="line">initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">simulation = project.factory.simgr(initial_state,veritesting = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">  stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output)  <span class="comment"># :boolean</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">  stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;Try again.&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output)  <span class="comment"># :boolean</span></span><br><span class="line"></span><br><span class="line">simulation.explore(find = is_successful,avoid = should_abort)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found :</span><br><span class="line">  solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">  <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No Answer!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>本题主要是利用了project.factory.simgr() 函数提供的veritesting 参数来指定是否自动合并路径。</p>
<p>贴上大佬的简单原理解释</p>
<p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312172250586.png" alt="image-20220312172250586"></p>
<h2 id="13-angr-static-binary"><a href="#13-angr-static-binary" class="headerlink" title="13_angr_static_binary"></a>13_angr_static_binary</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312172829883.png" alt="image-20220312172829883"></p>
<p>伪代码如上。也是祖传complex函数变化。</p>
<p>乍一看，跟第一题还很像。但是用第一题的脚本跑半天出不来。而且还报错。</p>
<p>点进printf，scanf这类函数可以发现，呈现的是函数的源代码，不再是之前的跳转命令。</p>
<p>这个程序是静态链接编译的，故才会包含printf，scanf这类libc函数的实现。</p>
<p>因此我们需要hook掉这些实现的libc函数，避免angr在这些libc函数里东跑西跑迷失。</p>
<p>本题的libc函数有printf，scanf，puts，还有一个glibc函数__libc_start_main</p>
<p>hook掉之后，脚本就跟第一题的一样了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">project =angr.Project(<span class="string">&quot;E:\\LAB\\angr\\angr\program\\13_angr_static_binary&quot;</span>)</span><br><span class="line"></span><br><span class="line">initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">simulation = project.factory.simgr(initial_state,veritesting = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">project.hook(<span class="number">0x804ed40</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;printf&#x27;</span>]()) <span class="comment"># 获取Angr 内部实现的系统函数</span></span><br><span class="line">project.hook(<span class="number">0x804ed80</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;scanf&#x27;</span>]())</span><br><span class="line">project.hook(<span class="number">0x804f350</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;puts&#x27;</span>]())</span><br><span class="line">project.hook(<span class="number">0x8048d10</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;glibc&#x27;</span>][<span class="string">&#x27;__libc_start_main&#x27;</span>]())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">  stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">  stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;Try again.&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(stdout_output) </span><br><span class="line"></span><br><span class="line">simulation.explore(find = is_successful,avoid = should_abort)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found :</span><br><span class="line">  solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">  <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No Answer!&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="14-angr-shared-library"><a href="#14-angr-shared-library" class="headerlink" title="14_angr_shared_library"></a>14_angr_shared_library</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312180011638.png" alt="image-20220312180011638"></p>
<p>…….</p>
<p>这题还有一个对应的.so文件，这就需要用angr来动态链接了。</p>
<p>反编译的时候会报错，寄。</p>
<p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312180837996.png" alt="image-20220312180837996"></p>
<p>原因摘自其他大神博客</p>
<p>这是因为generate.py 里面有一个Bug ,在最后的一个gcc 编译命令因为-L 参数缺少了指定当前目录,导致在寻找lib14_angr_shared_library.so 的时候找到了系统库目录,所以gcc 抛出了这个找不到<code>14_angr_shared_library: No such file or directory</code> 的问题,代码修改如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">with</span> tempfile.NamedTemporaryFile(delete=<span class="literal">False</span>, suffix=<span class="string">&#x27;.c&#x27;</span>) <span class="keyword">as</span> temp:</span><br><span class="line">    temp.write(c_code)</span><br><span class="line">    temp.seek(<span class="number">0</span>)</span><br><span class="line">-    os.system(<span class="string">&#x27;gcc -m32 -I . -L &#x27;</span> + <span class="string">&#x27;/&#x27;</span>.join(output_file.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>:-<span class="number">1</span>]) + <span class="string">&#x27; -o &#x27;</span> + output_file + <span class="string">&#x27; &#x27;</span> + temp.name + <span class="string">&#x27; -l&#x27;</span> + output_file.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>])</span><br><span class="line">+    os.system(<span class="string">&#x27;gcc -m32 -I . -L . &#x27;</span> + <span class="string">&#x27;/&#x27;</span>.join(output_file.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>:-<span class="number">1</span>]) + <span class="string">&#x27; -o &#x27;</span> + output_file + <span class="string">&#x27; &#x27;</span> + temp.name + <span class="string">&#x27; -l&#x27;</span> + output_file.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<p>回到函数本身，这个validate是验证函数哈，但是不在v这个程序里，在.so文件动态链接着</p>
<p>所以我们用IDA打开.so文件，查看validate代码。</p>
<p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312181720370.png" alt="image-20220312181710748"></p>
<p>…祖传complex，没什么好说的。</p>
<p>这题考点在于这个动态链接。我们对这个.so文件进行符号执行。（加载文件时加载.so文件）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> msilib.schema <span class="keyword">import</span> Binary</span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">base = <span class="number">0x400000</span>  <span class="comment">#  base 基址是随意定的,可以随意修改</span></span><br><span class="line">project = angr.Project(<span class="string">&quot;E:\\LAB\\angr\\angr\program\\lib14_angr_shared_library.so&quot;</span>, load_options=&#123;</span><br><span class="line">    <span class="string">&#x27;main_opts&#x27;</span> : &#123;</span><br><span class="line">      <span class="string">&#x27;custom_base_addr&#x27;</span> : base</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">buf_pointer = claripy.BVV(<span class="number">0x03000000</span>, <span class="number">32</span>)  <span class="comment"># 变量地址</span></span><br><span class="line">validate_addr = base+<span class="number">0x6d7</span>                 <span class="comment"># 函数地址</span></span><br><span class="line"><span class="comment"># validate(char* buffer, int length)</span></span><br><span class="line">init_state = project.factory.call_state(validate_addr, buf_pointer, claripy.BVV(<span class="number">8</span>, <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">flag = claripy.BVS(<span class="string">&quot;flag&quot;</span>, <span class="number">8</span>*<span class="number">8</span>)            <span class="comment"># 要求解的输入</span></span><br><span class="line">init_state.memory.store(buf_pointer, flag)</span><br><span class="line"></span><br><span class="line">good = base+<span class="number">0x783</span>  <span class="comment"># validate返回地址</span></span><br><span class="line">simu = project.factory.simgr(init_state)</span><br><span class="line">simu.explore(find=good)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simu.found:</span><br><span class="line">    solu_state = simu.found[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 限制返回时的寄存器值不为0才是正确结果</span></span><br><span class="line">    solu_state.add_constraints(solu_state.regs.eax != <span class="number">0</span>)</span><br><span class="line">    flag = solu_state.solver.<span class="built_in">eval</span>(flag, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No result!&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="15-angr-arbitrary-read"><a href="#15-angr-arbitrary-read" class="headerlink" title="15_angr_arbitrary_read"></a>15_angr_arbitrary_read</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312183629337.png" alt="image-20220312183629337"></p>
<p>接下来重点看汇编代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">.text:080484C9 main            proc near               ; DATA XREF: _start+17↑o</span><br><span class="line">.text:080484C9</span><br><span class="line">.text:080484C9 var_1C          = byte ptr -1Ch</span><br><span class="line">.text:080484C9 s               = dword ptr -0Ch</span><br><span class="line">.text:080484C9 var_4           = dword ptr -4</span><br><span class="line">.text:080484C9 argc            = dword ptr  8</span><br><span class="line">.text:080484C9 argv            = dword ptr  0Ch</span><br><span class="line">.text:080484C9 envp            = dword ptr  10h</span><br><span class="line">.text:080484C9</span><br><span class="line">.text:080484C9 ; __unwind &#123;</span><br><span class="line">.text:080484C9                 lea     ecx, [esp+4]</span><br><span class="line">.text:080484CD                 and     esp, 0FFFFFFF0h</span><br><span class="line">.text:080484D0                 push    dword ptr [ecx-4]</span><br><span class="line">.text:080484D3                 push    ebp</span><br><span class="line">.text:080484D4                 mov     ebp, esp</span><br><span class="line">.text:080484D6                 push    ecx</span><br><span class="line">.text:080484D7                 sub     esp, 24h</span><br><span class="line">.text:080484DA                 mov     eax, try_again</span><br><span class="line">.text:080484DF                 mov     [ebp+s], eax</span><br><span class="line">.text:080484E2                 sub     esp, 0Ch</span><br><span class="line">.text:080484E5                 push    offset aEnterThePasswo ; &quot;Enter the password: &quot;</span><br><span class="line">.text:080484EA                 call    _printf</span><br><span class="line">.text:080484EF                 add     esp, 10h</span><br><span class="line">.text:080484F2                 sub     esp, 4</span><br><span class="line">.text:080484F5                 lea     eax, [ebp+var_1C]</span><br><span class="line">.text:080484F8                 push    eax</span><br><span class="line">.text:080484F9                 push    offset key</span><br><span class="line">.text:080484FE                 push    offset aU20s    ; &quot;%u %20s&quot;</span><br><span class="line">.text:08048503                 call    ___isoc99_scanf</span><br><span class="line">.text:08048508                 add     esp, 10h</span><br><span class="line">.text:0804850B                 mov     eax, ds:key</span><br><span class="line">.text:08048510                 cmp     eax, 228BF7Eh</span><br><span class="line">.text:08048515                 jz      short loc_8048531</span><br><span class="line">.text:08048517                 cmp     eax, 3AD516Ah</span><br><span class="line">.text:0804851C                 jnz     short loc_8048542</span><br><span class="line">.text:0804851E                 mov     eax, try_again</span><br><span class="line">.text:08048523                 sub     esp, 0Ch</span><br><span class="line">.text:08048526                 push    eax             ; s</span><br><span class="line">.text:08048527                 call    _puts</span><br><span class="line">.text:0804852C                 add     esp, 10h</span><br><span class="line">.text:0804852F                 jmp     short loc_8048553</span><br><span class="line">.text:08048531 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:08048531</span><br><span class="line">.text:08048531 loc_8048531:                            ; CODE XREF: main+4C↑j</span><br><span class="line">.text:08048531                 mov     eax, [ebp+s]</span><br><span class="line">.text:08048534                 sub     esp, 0Ch</span><br><span class="line">.text:08048537                 push    eax             ; s</span><br><span class="line">.text:08048538                 call    _puts</span><br><span class="line">.text:0804853D                 add     esp, 10h</span><br><span class="line">.text:08048540                 jmp     short loc_8048553</span><br><span class="line">.text:08048542 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:08048542</span><br><span class="line">.text:08048542 loc_8048542:                            ; CODE XREF: main+53↑j</span><br><span class="line">.text:08048542                 mov     eax, try_again</span><br><span class="line">.text:08048547                 sub     esp, 0Ch</span><br><span class="line">.text:0804854A                 push    eax             ; s</span><br><span class="line">.text:0804854B                 call    _puts</span><br><span class="line">.text:08048550                 add     esp, 10h</span><br><span class="line">.text:08048553</span><br><span class="line">.text:08048553 loc_8048553:                            ; CODE XREF: main+66↑j</span><br><span class="line">.text:08048553                                         ; main+77↑j</span><br><span class="line">.text:08048553                 nop</span><br><span class="line">.text:08048554                 mov     eax, 0</span><br><span class="line">.text:08048559                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:0804855C                 leave</span><br><span class="line">.text:0804855D                 lea     esp, [ecx-4]</span><br><span class="line">.text:08048560                 retn</span><br><span class="line">.text:08048560 ; &#125; // starts at 80484C9</span><br><span class="line">.text:08048560 main            endp</span><br></pre></td></tr></table></figure>

<p>输入的两个参数，key，v4，分别对应汇编代码中的s（var_c），var_1c，由此可见，两个参数相距0x10（16个字节大小，其实也就是说，var_1c（v4）是16个字节大小。）而输入会输入20个字节。必定会将key变量覆盖部分甚至全部。（其实%u就是占四个字节，这里key就刚好全部被覆盖了）</p>
<p>再会看程序逻辑，将key与0x228BF7E比较，相等则不输出tryagain，至此我们找到了输出s的方法</p>
<p>我们使用hook，钩取scanf</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> msilib.schema <span class="keyword">import</span> Binary</span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary_path = <span class="string">&quot;E:\\LAB\\angr\\angr\program\\15_angr_arbitrary_read&quot;</span></span><br><span class="line">pro = angr.Project(binary_path)</span><br><span class="line"></span><br><span class="line">init_state = pro.factory.entry_state()</span><br><span class="line"></span><br><span class="line"><span class="comment"># replace scanf</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReplaceScanf</span>(angr.SimProcedure):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, format_str, param0, param1</span>):</span><br><span class="line">        scanf0 = claripy.BVS(<span class="string">&quot;0&quot;</span>, <span class="number">32</span>)</span><br><span class="line">        scanf1 = claripy.BVS(<span class="string">&quot;1&quot;</span>, <span class="number">20</span>*<span class="number">8</span>)</span><br><span class="line">        <span class="comment"># 限制单个字符的求解范围</span></span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> scanf1.chop(bits=<span class="number">8</span>):</span><br><span class="line">            self.state.add_constraints(ch &gt;= <span class="string">&quot;A&quot;</span>, ch &lt;= <span class="string">&quot;Z&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.state.memory.store(param0, scanf0, endness=pro.arch.memory_endness)</span><br><span class="line">        self.state.memory.store(param1, scanf1)</span><br><span class="line">        self.state.<span class="built_in">globals</span>[<span class="string">&quot;solutions&quot;</span>] = (scanf0, scanf1)</span><br><span class="line"></span><br><span class="line">scanf_sym = <span class="string">&quot;__isoc99_scanf&quot;</span></span><br><span class="line">pro.hook_symbol(scanf_sym, ReplaceScanf())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过检查puts的输出来确定是否是想要的结果</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_puts</span>(<span class="params">state</span>):</span><br><span class="line">    puts_para = state.memory.load(state.regs.esp+<span class="number">4</span>, <span class="number">4</span>, endness=pro.arch.memory_endness)</span><br><span class="line">    <span class="keyword">if</span> state.solver.symbolic(puts_para):</span><br><span class="line">        good_str = <span class="number">0x4D52584B</span></span><br><span class="line">        copy_state = state.copy()</span><br><span class="line">        copy_state.add_constraints(puts_para == good_str)</span><br><span class="line">        <span class="keyword">if</span> copy_state.satisfiable():</span><br><span class="line">            <span class="comment"># 先通过拷贝的状态判断是否满足，然后再直接在原状态增加限制</span></span><br><span class="line">            state.add_constraints(puts_para == good_str) <span class="comment">#  如果有解的话就保存到我们执行的那个状态对象</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">success</span>(<span class="params">state</span>):</span><br><span class="line">    puts_plt = <span class="number">0x08048370</span> <span class="comment">#  当程序执行到puts() 函数时,我们就认为路径探索到了这里,然后再去通过check_puts() 判断这里是否存在漏洞,告诉Angr这是不是我们需要找的那条执行路径</span></span><br><span class="line">    <span class="keyword">if</span> state.addr == puts_plt:</span><br><span class="line">        <span class="keyword">return</span> check_puts(state)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">simu = pro.factory.simgr(init_state)</span><br><span class="line">simu.explore(find=success)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simu.found:</span><br><span class="line">    solu_state = simu.found[<span class="number">0</span>]</span><br><span class="line">    (scanf0, scanf1) = solu_state.<span class="built_in">globals</span>[<span class="string">&quot;solutions&quot;</span>]</span><br><span class="line">    flag = <span class="built_in">str</span>(solu_state.solver.<span class="built_in">eval</span>(scanf0)).encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    flag += <span class="string">b&quot; &quot;</span> + solu_state.solver.<span class="built_in">eval</span>(scanf1, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No result!&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="16-angr-arbitrary-write"><a href="#16-angr-arbitrary-write" class="headerlink" title="16_angr_arbitrary_write"></a>16_angr_arbitrary_write</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312190749217.png" alt="image-20220312190749217"></p>
<p>汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">.text:08048569 ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:08048569                 public main</span><br><span class="line">.text:08048569 main            proc near               ; DATA XREF: _start+17↑o</span><br><span class="line">.text:08048569</span><br><span class="line">.text:08048569 input_buffer(s)    = byte ptr -1Ch</span><br><span class="line">.text:08048569 target_buffer(dest)   = dword ptr -0Ch</span><br><span class="line">.text:08048569 var_4           = dword ptr -4</span><br><span class="line">.text:08048569 argc            = dword ptr  8</span><br><span class="line">.text:08048569 argv            = dword ptr  0Ch</span><br><span class="line">.text:08048569 envp            = dword ptr  10h</span><br><span class="line">.text:08048569</span><br><span class="line">.text:08048569 ; __unwind &#123;</span><br><span class="line">.text:08048569                 lea     ecx, [esp+4]</span><br><span class="line">.text:0804856D                 and     esp, 0FFFFFFF0h</span><br><span class="line">.text:08048570                 push    dword ptr [ecx-4]</span><br><span class="line">.text:08048573                 push    ebp</span><br><span class="line">.text:08048574                 mov     ebp, esp</span><br><span class="line">.text:08048576                 push    ecx</span><br><span class="line">.text:08048577                 sub     esp, 24h</span><br><span class="line">.text:0804857A                 mov     [ebp+target_buffer], offset unimportant_buffer</span><br><span class="line">.text:08048581                 sub     esp, 4</span><br><span class="line">.text:08048584                 push    10h             ; n</span><br><span class="line">.text:08048586                 push    0               ; c</span><br><span class="line">.text:08048588                 lea     eax, [ebp+input_buffer]</span><br><span class="line">.text:0804858B                 push    eax             ; s</span><br><span class="line">.text:0804858C                 call    _memset         ;  清空input_buffer 的内容</span><br><span class="line">.text:08048591                 add     esp, 10h</span><br><span class="line">.text:08048594                 sub     esp, 4</span><br><span class="line">.text:08048597                 push    0Ch             ; n</span><br><span class="line">.text:08048599                 push    offset src      ; &quot;PASSWORD&quot;</span><br><span class="line">.text:0804859E                 push    offset password_buffer ; dest</span><br><span class="line">.text:080485A3                 call    _strncpy        ;  复制PASSWORD 到全局内存password_buffer</span><br><span class="line">.text:080485A8                 add     esp, 10h</span><br><span class="line">.text:080485AB                 sub     esp, 0Ch</span><br><span class="line">.text:080485AE                 push    offset aEnterThePasswo ; &quot;Enter the password: &quot;</span><br><span class="line">.text:080485B3                 call    _printf</span><br><span class="line">.text:080485B8                 add     esp, 10h</span><br><span class="line">.text:080485BB                 sub     esp, 4</span><br><span class="line">.text:080485BE                 lea     eax, [ebp+input_buffer]</span><br><span class="line">.text:080485C1                 push    eax</span><br><span class="line">.text:080485C2                 push    offset check_key</span><br><span class="line">.text:080485C7                 push    offset aU20s    ; &quot;%u %20s&quot;</span><br><span class="line">.text:080485CC                 call    ___isoc99_scanf  ;  scanf(&quot;%u %20s&quot;,check_key,input_buffer) .注意input_buffer 的大小是20 字节,栈上的input_buffer 默认的大小是16 字节,最后4 字节可以覆盖target_buffer .</span><br><span class="line">.text:080485D1                 add     esp, 10h</span><br><span class="line">.text:080485D4                 mov     eax, ds:check_key</span><br><span class="line">.text:080485D9                 cmp     eax, 1A25D71h</span><br><span class="line">.text:080485DE                 jz      short loc_80485E9</span><br><span class="line">.text:080485E0                 cmp     eax, 1CB7D43h</span><br><span class="line">.text:080485E5                 jz      short loc_8048601  ;  根据check_key 的输入来跳转到不同的_strncpy</span><br><span class="line">.text:080485E7                 jmp     short loc_8048618</span><br><span class="line">.text:080485E9 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080485E9</span><br><span class="line">.text:080485E9 loc_80485E9:                            ; CODE XREF: main+75↑j</span><br><span class="line">.text:080485E9                 sub     esp, 4</span><br><span class="line">.text:080485EC                 push    10h             ; n</span><br><span class="line">.text:080485EE                 lea     eax, [ebp+input_buffer]</span><br><span class="line">.text:080485F1                 push    eax             ; src</span><br><span class="line">.text:080485F2                 push    offset unimportant_buffer ; dest</span><br><span class="line">.text:080485F7                 call    _strncpy</span><br><span class="line">.text:080485FC                 add     esp, 10h</span><br><span class="line">.text:080485FF                 jmp     short loc_804862E</span><br><span class="line">.text:08048601 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:08048601</span><br><span class="line">.text:08048601 loc_8048601:                            ; CODE XREF: main+7C↑j</span><br><span class="line">.text:08048601                 mov     eax, [ebp+target_buffer]  ;  注意这个是MOV 指令,意思是获取EBP + target_buffer 这个地址的内容保存到EAX 中</span><br><span class="line">.text:08048604                 sub     esp, 4</span><br><span class="line">.text:08048607                 push    10h             ; n</span><br><span class="line">.text:08048609                 lea     edx, [ebp+input_buffer]  ;  注意这个是LEA 指令,意思是计算出EBP + input_buffer 的地址保存到EBX 中</span><br><span class="line">.text:0804860C                 push    edx             ; src</span><br><span class="line">.text:0804860D                 push    eax             ; dest</span><br><span class="line">.text:0804860E                 call    _strncpy  ;  漏洞点在这里,strncpy(*target_buffer,input_buffer) ,也就是说input_buffer 最后四字节可以控制对任意地址的_strncpy() .总结起来就是strncpy(input_buffer[ -4 : ],input_buffer,0x10) .</span><br><span class="line">.text:08048613                 add     esp, 10h</span><br><span class="line">.text:08048616                 jmp     short loc_804862E</span><br><span class="line">.text:08048618 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:08048618</span><br><span class="line">.text:08048618 loc_8048618:                            ; CODE XREF: main+7E↑j</span><br><span class="line">.text:08048618                 sub     esp, 4</span><br><span class="line">.text:0804861B                 push    10h             ; n</span><br><span class="line">.text:0804861D                 lea     eax, [ebp+input_buffer]</span><br><span class="line">.text:08048620                 push    eax             ; src</span><br><span class="line">.text:08048621                 push    offset unimportant_buffer ; dest</span><br><span class="line">.text:08048626                 call    _strncpy</span><br><span class="line">.text:0804862B                 add     esp, 10h</span><br><span class="line">.text:0804862E</span><br><span class="line">.text:0804862E loc_804862E:                            ; CODE XREF: main+96↑j</span><br><span class="line">.text:0804862E                                         ; main+AD↑j</span><br><span class="line">.text:0804862E                 nop</span><br><span class="line">.text:0804862F                 sub     esp, 4</span><br><span class="line">.text:08048632                 push    8               ; n</span><br><span class="line">.text:08048634                 push    offset key_string       ; &quot;KZYRKMKE&quot;</span><br><span class="line">.text:08048639                 push    offset password_buffer ; s1</span><br><span class="line">.text:0804863E                 call    _strncmp        ;  我们知道了上面有一个任意地址写之后,我们就需要改写key_string 或者password_buffer 一致,让_strncmp() 返回0 ,跳转到puts(&quot;Good Job&quot;)</span><br><span class="line">.text:08048643                 add     esp, 10h</span><br><span class="line">.text:08048646                 test    eax, eax</span><br><span class="line">.text:08048648                 jz      short loc_804865C</span><br><span class="line">.text:0804864A                 sub     esp, 0Ch</span><br><span class="line">.text:0804864D                 push    offset s        ; &quot;Try again.&quot;</span><br><span class="line">.text:08048652                 call    _puts</span><br><span class="line">.text:08048657                 add     esp, 10h</span><br><span class="line">.text:0804865A                 jmp     short loc_804866C</span><br><span class="line">.text:0804865C ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0804865C</span><br><span class="line">.text:0804865C loc_804865C:                            ; CODE XREF: main+DF↑j</span><br><span class="line">.text:0804865C                 sub     esp, 0Ch</span><br><span class="line">.text:0804865F                 push    offset aGoodJob ; &quot;Good Job.&quot;</span><br><span class="line">.text:08048664                 call    _puts</span><br><span class="line">.text:08048669                 add     esp, 10h</span><br></pre></td></tr></table></figure>

<p>这题，s和key的关系跟上题v4和key的关系一样。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> msilib.schema <span class="keyword">import</span> Binary</span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary_path = <span class="string">&quot;E:\\LAB\\angr\\angr\program\\16_angr_arbitrary_write&quot;</span></span><br><span class="line">project= angr.Project(binary_path)</span><br><span class="line"></span><br><span class="line">initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReplacementScanf</span>(angr.SimProcedure):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, format_string, check_key ,input_buffer</span>):</span><br><span class="line">      scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">      scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">20</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> char <span class="keyword">in</span> scanf1.chop(bits=<span class="number">8</span>):</span><br><span class="line">        self.state.add_constraints(char &gt;= <span class="string">&#x27;0&#x27;</span>, char &lt;= <span class="string">&#x27;z&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      self.state.memory.store(check_key, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">      self.state.memory.store(input_buffer, scanf1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>] = scanf0</span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line">scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span></span><br><span class="line">project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_strncpy</span>(<span class="params">state</span>):</span><br><span class="line">    strncpy_dest = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>, endness=project.arch.memory_endness)  <span class="comment">#  获取strncpy() 的参数,strncpy_dest ..</span></span><br><span class="line">    strncpy_src  = state.memory.load(state.regs.esp + <span class="number">8</span>, <span class="number">4</span>, endness=project.arch.memory_endness)</span><br><span class="line">    strncpy_len  = state.memory.load(state.regs.esp + <span class="number">12</span>, <span class="number">4</span>, endness=project.arch.memory_endness)</span><br><span class="line">    src_contents = state.memory.load(strncpy_src, strncpy_len)  <span class="comment">#  因为参数中只保存了地址,我们需要根据这个地址去获取内容</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> state.se.symbolic(strncpy_dest) <span class="keyword">and</span> state.se.symbolic(src_contents) :  <span class="comment">#  判断dest 和src 的内容是不是符号化对象</span></span><br><span class="line">      <span class="keyword">if</span> state.satisfiable(extra_constraints=(src_contents[ -<span class="number">1</span> : -<span class="number">64</span> ] == <span class="string">&#x27;KZYRKMKE&#x27;</span> ,strncpy_dest == <span class="number">0x4D52584C</span>)):  <span class="comment">#  尝试求解,其中strncpy_dest == 0x4D52584C 的意思是判断dest 是否可控为password 的地址;src_contents[ -1 : -64 ] == &#x27;KZYRKMKE&#x27; 是判断input_buffer 的内容是否可控为&#x27;KZYRKMKE&#x27; ,因为这块内存是倒序,所以需要通过[ -1 : -64 ] 倒转(contentes 的内容是比特,获取8 字节的大小为:8*8 = 64),然后判断该值是否为字符串&#x27;KZYRKMKE&#x27;</span></span><br><span class="line">        state.add_constraints(src_contents[ -<span class="number">1</span> : -<span class="number">64</span> ] == <span class="string">&#x27;KZYRKMKE&#x27;</span>,strncpy_dest == <span class="number">0x4D52584C</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    strncpy_address = <span class="number">0x8048410</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> state.addr == strncpy_address:</span><br><span class="line">      <span class="keyword">return</span> check_strncpy(state)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">simulation.explore(find=is_successful)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    solution0 = solution_state.se.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>])</span><br><span class="line">    solution1 = solution_state.se.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>],cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution0,solution1)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No result!&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="17-angr-arbitrary-jump"><a href="#17-angr-arbitrary-jump" class="headerlink" title="17_angr_arbitrary_jump"></a>17_angr_arbitrary_jump</h2><p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312192050484.png" alt="image-20220312192050484"></p>
<p><img src="/2022/03/08/angrLAB%E7%AC%94%E8%AE%B0/image-20220312192112152.png" alt="image-20220312192112152"></p>
<p>这么简单肯定出事儿，没有Goodjob。</p>
<p>汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">.text:4D525886 ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:4D525886                 public main</span><br><span class="line">.text:4D525886 main            proc near               ; DATA XREF: _start+17↑o</span><br><span class="line">.text:4D525886</span><br><span class="line">.text:4D525886 var_C           = dword ptr -0Ch</span><br><span class="line">.text:4D525886 var_4           = dword ptr -4</span><br><span class="line">.text:4D525886 argc            = dword ptr  8</span><br><span class="line">.text:4D525886 argv            = dword ptr  0Ch</span><br><span class="line">.text:4D525886 envp            = dword ptr  10h</span><br><span class="line">.text:4D525886</span><br><span class="line">.text:4D525886 ; __unwind &#123;</span><br><span class="line">.text:4D525886                 lea     ecx, [esp+4]</span><br><span class="line">.text:4D52588A                 and     esp, 0FFFFFFF0h</span><br><span class="line">.text:4D52588D                 push    dword ptr [ecx-4]</span><br><span class="line">.text:4D525890                 push    ebp</span><br><span class="line">.text:4D525891                 mov     ebp, esp</span><br><span class="line">.text:4D525893                 push    ecx</span><br><span class="line">.text:4D525894                 sub     esp, 14h</span><br><span class="line">.text:4D525897                 mov     [ebp+var_C], 0</span><br><span class="line">.text:4D52589E                 sub     esp, 0Ch</span><br><span class="line">.text:4D5258A1                 push    offset aEnterThePasswo ; &quot;Enter the password: &quot;</span><br><span class="line">.text:4D5258A6                 call    _printf</span><br><span class="line">.text:4D5258AB                 add     esp, 10h</span><br><span class="line">.text:4D5258AE                 call    read_input  ;  </span><br><span class="line">.text:4D5258B3                 sub     esp, 0Ch</span><br><span class="line">.text:4D5258B6                 push    offset aTryAgain ; &quot;Try again.&quot;</span><br><span class="line">.text:4D5258BB                 call    _puts</span><br><span class="line">.text:4D5258C0                 add     esp, 10h</span><br><span class="line">.text:4D5258C3                 mov     eax, 0</span><br><span class="line">.text:4D5258C8                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:4D5258CB                 leave</span><br><span class="line">.text:4D5258CC                 lea     esp, [ecx-4]</span><br><span class="line">.text:4D5258CF                 retn</span><br></pre></td></tr></table></figure>

<p>good job</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:4D525849 print_good      proc near</span><br><span class="line">.text:4D525849 ; __unwind &#123;</span><br><span class="line">.text:4D525849                 push    ebp</span><br><span class="line">.text:4D52584A                 mov     ebp, esp</span><br><span class="line">.text:4D52584C                 sub     esp, 8</span><br><span class="line">.text:4D52584F                 sub     esp, 0Ch</span><br><span class="line">.text:4D525852                 push    offset s        ; &quot;Good Job.&quot;</span><br><span class="line">.text:4D525857                 call    _puts</span><br><span class="line">.text:4D52585C                 add     esp, 10h</span><br><span class="line">.text:4D52585F                 sub     esp, 0Ch</span><br><span class="line">.text:4D525862                 push    0               ; status</span><br><span class="line">.text:4D525864                 call    _exit</span><br><span class="line">.text:4D525864 ; &#125; // starts at 4D525849</span><br><span class="line">.text:4D525864 print_good      endp</span><br></pre></td></tr></table></figure>

<p>reaad_input</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">read_input      proc near               ; CODE XREF: main+28↓p</span><br><span class="line">.text:4D525869</span><br><span class="line">.text:4D525869 var_2B          = byte ptr -2Bh</span><br><span class="line">.text:4D525869</span><br><span class="line">.text:4D525869 ; __unwind &#123;</span><br><span class="line">.text:4D525869                 push    ebp</span><br><span class="line">.text:4D52586A                 mov     ebp, esp</span><br><span class="line">.text:4D52586C                 sub     esp, 38h</span><br><span class="line">.text:4D52586F                 sub     esp, 8</span><br><span class="line">.text:4D525872                 lea     eax, [ebp+var_2B]</span><br><span class="line">.text:4D525875                 push    eax</span><br><span class="line">.text:4D525876                 push    offset format   ; &quot;%s&quot;</span><br><span class="line">.text:4D52587B                 call    ___isoc99_scanf</span><br><span class="line">.text:4D525880                 add     esp, 10h</span><br><span class="line">.text:4D525883                 nop</span><br><span class="line">.text:4D525884                 leave</span><br><span class="line">.text:4D525885                 retn</span><br><span class="line">.text:4D525885 ; &#125; // starts at 4D525869</span><br><span class="line">.text:4D525885 read_input      endp</span><br></pre></td></tr></table></figure>

<p>这道题和上面两道题其实是有相似之处的，输入的长度过长会造成溢出，会覆盖某些东西。</p>
<p>这个函数是当输入足够长时造成的栈溢出会覆盖retn的命令。</p>
<p>其实思路也已经出来了</p>
<p>我们hook输入函数，将输入的参数字节扩大，让它不覆盖retn</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> msilib.schema <span class="keyword">import</span> Binary</span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary_path = <span class="string">&quot;E:\\LAB\\angr\\angr\program\\17_angr_arbitrary_jump&quot;</span></span><br><span class="line">project= angr.Project(binary_path)</span><br><span class="line"></span><br><span class="line">initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">simulation = project.factory.simgr(</span><br><span class="line">    initial_state,</span><br><span class="line">    save_unconstrained=<span class="literal">True</span>,</span><br><span class="line">    stashes=&#123;</span><br><span class="line">      <span class="string">&#x27;active&#x27;</span> : [initial_state],</span><br><span class="line">      <span class="string">&#x27;unconstrained&#x27;</span> : [],</span><br><span class="line">      <span class="string">&#x27;found&#x27;</span> : [],</span><br><span class="line">      <span class="string">&#x27;not_needed&#x27;</span> : []</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReplacementScanf</span>(angr.SimProcedure):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, format_string, input_buffer_address</span>):</span><br><span class="line">      input_buffer = claripy.BVS(<span class="string">&#x27;input_buffer&#x27;</span>, <span class="number">64</span> * <span class="number">8</span>)  <span class="comment">#  设置一个较大的input_buffer</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> char <span class="keyword">in</span> input_buffer.chop(bits=<span class="number">8</span>):</span><br><span class="line">        self.state.add_constraints(char &gt;= <span class="string">&#x27;0&#x27;</span>, char &lt;= <span class="string">&#x27;z&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      self.state.memory.store(input_buffer_address, input_buffer, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution&#x27;</span>] = input_buffer</span><br><span class="line"></span><br><span class="line">scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span></span><br><span class="line">project.hook_symbol(scanf_symbol, ReplacementScanf())  <span class="comment">#  对scanf() 做Hook</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (simulation.active <span class="keyword">or</span> simulation.unconstrained) <span class="keyword">and</span> (<span class="keyword">not</span> simulation.found):  <span class="comment">#  </span></span><br><span class="line">    <span class="keyword">for</span> unconstrained_state <span class="keyword">in</span> simulation.unconstrained:</span><br><span class="line">      <span class="keyword">def</span> <span class="title function_">should_move</span>(<span class="params">s</span>):</span><br><span class="line">        <span class="keyword">return</span> s <span class="keyword">is</span> unconstrained_state</span><br><span class="line">      </span><br><span class="line">      simulation.move(<span class="string">&#x27;unconstrained&#x27;</span>, <span class="string">&#x27;found&#x27;</span>, filter_func=should_move)  <span class="comment">#  保存</span></span><br><span class="line"></span><br><span class="line">    simulation.step()  <span class="comment">#  步进执行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution_state.add_constraints(solution_state.regs.eip == <span class="number">0x4D525849</span>)  <span class="comment">#  判断EIP 地址是否可控</span></span><br><span class="line"></span><br><span class="line">    solution = solution_state.se.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution&#x27;</span>],cast_to = <span class="built_in">bytes</span>)  <span class="comment">#  生成Payload</span></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>丫的，终于写完了</p>
<p>感觉这个实验写完，能入个门，更多的还是得多多琢磨官方文档。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/02/28/Boomlab/" rel="prev" title="Boomlab">
      <i class="fa fa-chevron-left"></i> Boomlab
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/03/25/IL2CPP%E5%AD%A6%E4%B9%A0/" rel="next" title="IL2CPP学习">
      IL2CPP学习 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#00-angr-find"><span class="nav-number">1.</span> <span class="nav-text">00_angr_find</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#01-angr-avoid"><span class="nav-number">2.</span> <span class="nav-text">01_angr_avoid</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#02-angr-find-condition"><span class="nav-number">3.</span> <span class="nav-text">02_angr_find_condition</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#03-angr-symbolic-registers"><span class="nav-number">4.</span> <span class="nav-text">03_angr_symbolic_registers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#04-angr-symbolic-stack"><span class="nav-number">5.</span> <span class="nav-text">04_angr_symbolic_stack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#05-angr-symbolic-memory"><span class="nav-number">6.</span> <span class="nav-text">05_angr_symbolic_memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#06-angr-symbolic-dynamic-memory"><span class="nav-number">7.</span> <span class="nav-text">06_angr_symbolic_dynamic_memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#07-angr-symbolic-file"><span class="nav-number">8.</span> <span class="nav-text">07_angr_symbolic_file</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#08-angr-constraints"><span class="nav-number">9.</span> <span class="nav-text">08_angr_constraints</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#09-angr-hooks"><span class="nav-number">10.</span> <span class="nav-text">09_angr_hooks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-angr-simprocedures"><span class="nav-number">11.</span> <span class="nav-text">10_angr_simprocedures</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-angr-sim-scanf"><span class="nav-number">12.</span> <span class="nav-text">11_angr_sim_scanf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-angr-veritesting"><span class="nav-number">13.</span> <span class="nav-text">12_angr_veritesting</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-angr-static-binary"><span class="nav-number">14.</span> <span class="nav-text">13_angr_static_binary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-angr-shared-library"><span class="nav-number">15.</span> <span class="nav-text">14_angr_shared_library</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-angr-arbitrary-read"><span class="nav-number">16.</span> <span class="nav-text">15_angr_arbitrary_read</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-angr-arbitrary-write"><span class="nav-number">17.</span> <span class="nav-text">16_angr_arbitrary_write</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-angr-arbitrary-jump"><span class="nav-number">18.</span> <span class="nav-text">17_angr_arbitrary_jump</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">19.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Yu4n</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yu4n</span>
</div>
<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>
-->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
